<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PLAYSTATION 3</title>
    <link rel="stylesheet" href="assets/css/global.css">
</head>

<body class="spectrum-lista">

    <!-- BANDA SUPERIOR -->
    <header class="top-bar top-bar--spectrum">

    <!-- FILA 1: ATR√ÅS + T√çTULO + HOME (igual que PLATAFORMAS) -->
    <div class="top-bar-inner">
        <img src="assets/img/ic_back.svg"
             class="top-bar-back"
             alt="Atr√°s"
             onclick="window.location.href='plataformas.html'">

        <h1 class="top-bar-title">PLAYSTATION 3</h1>

        <img src="assets/img/ic_home.svg"
             class="top-bar-home"
             alt="Home"
             onclick="window.location.href='index.html'">
    </div>

    <!-- FILA 2: BUSCADOR -->
    <div class="spectrum-header-box">
        <div class="spectrum-search-wrapper">
            <div class="spectrum-search-box">
                <input type="text"
                       class="spectrum-search-input"
                       placeholder="Buscar">

                <img src="assets/img/ic_search.svg"
                     class="spectrum-search-icon"
                     alt="Buscar">
            </div>
        </div>
    </div>

    <!-- FILA 3: CONTADOR -->
    <div class="spectrum-records-block">
        <p class="spectrum-records-text">Cargando registros...</p>
    </div>

</header>


    <!-- CONTENIDO DE LA P√ÅGINA ZX SPECTRUM -->
    <main class="platforms-content">

        <!-- =========================================
             LISTA ZX SPECTRUM
        ========================================== -->
        <section class="zx-list-wrapper">
            <!-- Contenedor donde se inyectar√°n las tarjetas v√≠a JS -->
            <div id="zx-spectrum-list" class="zx-list-grid">
                <p class="zx-list-loading">Cargando listado de juegos...</p>
            </div>
        </section>

    </main>

    <script>
  // URL DEL FEED CSV PS3 (hoja "PS3")
  // =========================================
  const PS3_LISTA_CSV_URL = "URL_DEL_CSV_AQUI";

  // Lista global con TODOS los juegos (para el buscador)
  let allGames = [];
  // Contexto del √∫ltimo filtro aplicado
  let currentFilterField = "";
  let currentFilterValue = "";
 
  // =========================================
  // PARSER DE UNA L√çNEA CSV (RESPETA COMILLAS)
  // =========================================
  function parseCSVLine(line) {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];

      if (ch === '"') {
        // Si estamos dentro de comillas y vemos "" ‚Üí comilla escapada
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++; // saltamos la segunda
        } else {
          inQuotes = !inQuotes; // abrir/cerrar bloque de comillas
        }
      } else if (ch === "," && !inQuotes) {
        // Separador de campo real
        result.push(current.trim());
        current = "";
      } else {
        current += ch;
      }
    }

    // √öltimo campo
    result.push(current.trim());
    return result;
  }

  // =========================================
  // UTILIDAD PARA PARSEAR EL CSV COMPLETO
  // =========================================
  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (lines.length === 0) return [];

    const header = parseCSVLine(lines[0]);
    const rows = [];

    // √çndices de las columnas de PS3_LISTA
    const idxID        = header.indexOf("ID");
    const idxTitulo    = header.indexOf("TITULO_MOSTRAR");
    const idxAnio      = header.indexOf("A√ëO_MOSTRAR");
    const idxPub       = header.indexOf("PUBLISHER_MOSTRAR");
    const idxGenero    = header.indexOf("GENERO_MOSTRAR");
    const idxSubgenero = header.indexOf("SUBGENERO_MOSTRAR");
    const idxFavorito  = header.indexOf("FAVORITO_MOSTRAR");
    const idxCaratula  = header.indexOf("CARATULA_URL");
    const idxJugadores = header.indexOf("JUGADORES_MOSTRAR");
    const idxTerminado = header.indexOf("TERMINADO_MOSTRAR");

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i];
      if (!line.trim()) continue;

      const cols = parseCSVLine(line);

      const id        = (idxID        >= 0 && cols[idxID]        !== undefined) ? cols[idxID].trim()        : "";
      const titulo    = (idxTitulo    >= 0 && cols[idxTitulo]    !== undefined) ? cols[idxTitulo].trim()    : "";
      const anio      = (idxAnio      >= 0 && cols[idxAnio]      !== undefined) ? cols[idxAnio].trim()      : "";
      const pub       = (idxPub       >= 0 && cols[idxPub]       !== undefined) ? cols[idxPub].trim()       : "";
      const genero    = (idxGenero    >= 0 && cols[idxGenero]    !== undefined) ? cols[idxGenero].trim()    : "";
      const subgenero = (idxSubgenero >= 0 && cols[idxSubgenero] !== undefined) ? cols[idxSubgenero].trim() : "";
      const favorito  = (idxFavorito  >= 0 && cols[idxFavorito]  !== undefined) ? cols[idxFavorito].trim()  : "";
      const caratula  = (idxCaratula  >= 0 && cols[idxCaratula]  !== undefined) ? cols[idxCaratula].trim()  : "";
      const jugadores = (idxJugadores >= 0 && cols[idxJugadores] !== undefined) ? cols[idxJugadores].trim() : "";
      const terminado = (idxTerminado >= 0 && cols[idxTerminado] !== undefined) ? cols[idxTerminado].trim() : "";

      // Si no hay t√≠tulo, descartamos la fila
      if (!titulo) continue;

      // T√≠tulo SOLO para mostrar (con art√≠culo al final)
      const displayTitulo = formatTitleWithArticle(titulo);

      rows.push({
        id,
        titulo,
        displayTitulo,
        anio,
        pub,
        genero,
        subgenero,
        favorito,
        caratula,
        jugadores,
        terminado,
        sortKey: displayTitulo.toLowerCase()
      });

    }

    return rows;
  }

  // =========================================
  // FORMATEO DE T√çTULOS CON ART√çCULO AL FINAL
  // Ej: "The Great Escape" ‚Üí "Great Escape, The"
  //     "La Abad√≠a del Crimen" ‚Üí "Abad√≠a del Crimen, La"
  // =========================================
  function formatTitleWithArticle(title) {
    if (!title) return "";
    const t = title.trim();

    // Art√≠culos que queremos mover al final
    const re = /^(the|a|an|el|la|los|las|lo)\s+(.*)$/i;
    const match = t.match(re);

    if (!match) {
      return t;  // Sin art√≠culo al principio ‚Üí se deja igual
    }

    const article = match[1]; // "The", "La", etc.
    const rest    = match[2]; // El resto
    return rest + ", " + article;
  }

  // =========================================
  // NORMALIZAR TEXTO (min√∫sculas + sin tildes)
  // para que el buscador sea m√°s amable
  // =========================================
  function normalizeText(str) {
    return (str || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, ""); // quita acentos
  }

  // =========================================
  // CREACI√ìN DE UNA TARJETA DE JUEGO
  // =========================================
  function createGameCard(game) {
    const card = document.createElement("article");
    card.className = "zx-card";

    // --- Thumb ---
    const thumbWrapper = document.createElement("div");
    thumbWrapper.className = "zx-thumb-wrapper";

    // Usamos CARATULA_URL para el thumbnail
    const thumbUrl = (game.caratula || "").trim();

    if (thumbUrl) {
      const img = document.createElement("img");
      img.className = "zx-thumb-img";
      img.src = thumbUrl;
      img.alt = game.titulo || "Screenshot";
      thumbWrapper.appendChild(img);
    } else {
      const placeholder = document.createElement("div");
      placeholder.className = "zx-thumb-placeholder";
      placeholder.textContent = "SIN IMAGEN";
      thumbWrapper.appendChild(placeholder);
    }

    // --- Meta (textos) ---
    const meta = document.createElement("div");
    meta.className = "zx-meta";

    const titleEl = document.createElement("h3");
    titleEl.className = "zx-title";
    titleEl.textContent = game.displayTitulo || game.titulo;
    meta.appendChild(titleEl);

    // Publisher en su propia l√≠nea
    if (game.pub) {
      const pubEl = document.createElement("p");
      pubEl.className = "zx-subtitle";
      pubEl.textContent = game.pub.replace(/[\"""¬´¬ª‚Äû‚Äü]+/g, "");
      meta.appendChild(pubEl);
    }

    // A√±o en su propia l√≠nea
    if (game.anio) {
      const yearEl = document.createElement("p");
      yearEl.className = "zx-subtitle";
      yearEl.textContent = game.anio.replace(/[\"""¬´¬ª‚Äû‚Äü]+/g, "");
      meta.appendChild(yearEl);
    }

    card.appendChild(thumbWrapper);
    card.appendChild(meta);

    return card;
  }

  // =========================================
  // PINTAR LISTA + ACTUALIZAR CONTADOR
  // =========================================
  function resetListScroll() {
    const container = document.getElementById("zx-spectrum-list");
    if (!container) return;

    requestAnimationFrame(() => {
      container.scrollTop = 0;

      const scrollableParent = container.closest(".platforms-content");
      if (scrollableParent) {
        scrollableParent.scrollTop = 0;
      }

      const scrollingElement = document.scrollingElement || document.documentElement;
      if (scrollingElement) {
        scrollingElement.scrollTop = 0;
      }

      if (typeof window !== "undefined" && window.scrollTo) {
        window.scrollTo(0, 0);
      }
    });
  }

  function renderGames(gamesToRender, query = "") {
    const container = document.getElementById("zx-spectrum-list");
    if (!container) return;

    container.innerHTML = "";

        if (!gamesToRender.length) {
      container.innerHTML = '<p class="zx-list-loading">No se han encontrado juegos que coincidan con la b√∫squeda.</p>';
    } else {
      gamesToRender.forEach(game => {
        const card = createGameCard(game);

        // üîπ Hacer que toda la tarjeta sea clicable
        // Usamos el ID que viene del CSV (columna "ID")
        card.addEventListener("click", () => {
  if (game.id) {
    const searchInput = document.querySelector(".spectrum-search-input");
    const query = searchInput ? searchInput.value.trim() : "";
    let url = "ps3-ficha.html?id=" + encodeURIComponent(game.id);
    if (query) {
      url += "&search=" + encodeURIComponent(query);
    }
    if (currentFilterField && currentFilterValue) {
      url += `&filterField=${encodeURIComponent(currentFilterField)}&filterValue=${encodeURIComponent(currentFilterValue)}`;
    }
    window.location.href = url;
  }
});

        // Cambiamos el cursor para que se note que es clicable
        card.style.cursor = "pointer";

        container.appendChild(card);
      });
    }


    // Actualizar contador "X REGISTROS" o "N DE X REGISTROS"
    const recordsEl = document.querySelector(".spectrum-records-text");
    if (recordsEl) {
      const total = allGames.length;
      if (!query.trim()) {
        recordsEl.textContent = total.toLocaleString("es-ES") + " REGISTROS";
      } else {
        const current = gamesToRender.length;
        recordsEl.textContent =
          current.toLocaleString("es-ES") +
          " DE " +
          total.toLocaleString("es-ES") +
        " REGISTROS";
      }
    }

    // Tras cada render de la lista (p. ej., al aplicar un filtro),
    // llevamos el contenedor que hace scroll al inicio para que se vean
    // los primeros resultados del listado.
    resetListScroll();

  }
    
  // =========================================
  // CONFIGURAR BUSCADOR
  // =========================================
  function setupSearch() {
    const searchInput = document.querySelector(".spectrum-search-input");
    if (!searchInput) return;

    searchInput.addEventListener("input", () => {
      const query = searchInput.value || "";
      const trimmed = query.trim();
// =============================================
// UN SOLO CAR√ÅCTER (letra o n√∫mero) ‚Üí mostrar solo 
// juegos que empiezan por ese car√°cter
// =============================================
const singleCharMatch = trimmed.match(/^([a-z√±√°√©√≠√≥√∫√º0-9])$/i);

if (singleCharMatch) {
    const char = normalizeText(singleCharMatch[1]);

    const filteredByChar = allGames.filter(game => {
        const titleNorm = normalizeText(game.displayTitulo || game.titulo);
        return titleNorm.startsWith(char);
    });

    renderGames(filteredByChar, trimmed);
    currentFilterField = "";
    currentFilterValue = "";
    return; // ‚¨ÖÔ∏è IMPORTANTE: no seguir con el buscador normal
}

      if (!trimmed) {
        // Sin texto ‚Üí lista completa
        renderGames(allGames, "");
        currentFilterField = "";
        currentFilterValue = "";
        return;
      }

      const qNorm = normalizeText(trimmed);

     const filtered = allGames.filter(game => {
       const titleNorm     = normalizeText(game.displayTitulo || game.titulo);
       const pubNorm       = normalizeText(game.pub);
       const yearNorm      = normalizeText(game.anio);
       const generoNorm    = normalizeText(game.genero);
       const subgeneroNorm = normalizeText(game.subgenero);
       const jugadoresNorm = normalizeText(game.jugadores);
       const terminadoNorm = normalizeText(game.terminado);

       return (
         titleNorm.includes(qNorm)     ||
         pubNorm.includes(qNorm)       ||
         yearNorm.includes(qNorm)      ||
         generoNorm.includes(qNorm)    ||
         subgeneroNorm.includes(qNorm) ||
         jugadoresNorm.includes(qNorm) ||
         terminadoNorm.includes(qNorm)
       );
     });


      // Guardar contexto del filtro si es un subg√©nero exacto
      currentFilterField = "";
      currentFilterValue = trimmed;

      const isExactSubgenero =
        filtered.length > 0 &&
        filtered.every(game => normalizeText(game.subgenero) === qNorm);

      if (isExactSubgenero) {
        currentFilterField = "subgenero";
      }
        
      renderGames(filtered, query);
    });
  }

  // =========================================
  // CARGA INICIAL DE LA LISTA
  // =========================================
  async function loadPS3List() {
    const container = document.getElementById("zx-spectrum-list");
    if (!container) return;

    try {
      container.innerHTML = '<p class="zx-list-loading">Cargando listado de juegos...</p>';

      const response = await fetch(PS3_LISTA_CSV_URL);
      if (!response.ok) {
        throw new Error("No se pudo cargar el CSV");
      }

      const text = await response.text();
      const games = parseCSV(text);

      // Ordenar alfab√©ticamente usando sortKey (ya en min√∫sculas)
      games.sort((a, b) => (a.sortKey || "").localeCompare(b.sortKey || "", "es-ES"));

      // Guardamos la lista completa para el buscador
      allGames = games;

      // Pintamos la lista completa (estado inicial, sin filtro)
      renderGames(allGames, "");

      // Configuramos el buscador (una sola vez)
      setupSearch();

    } catch (err) {
      console.error("Error al cargar la lista PS3:", err);
      container.innerHTML = '<p class="zx-list-loading">Error al cargar la lista de juegos.</p>';
    }
  }

  document.addEventListener("DOMContentLoaded", loadPS3List);
</script>


</body>
</html>
