<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title id="page-title">Cargando – Ficha</title>
    <link rel="stylesheet" href="assets/css/global.css">
</head>

<body class="ficha-final ficha-cover-standard loading">

    <!-- CABECERA -->
    <header class="top-bar top-bar--spectrum">
        <div class="top-bar-inner top-bar-inner--ficha">

<img src="assets/img/ic_back.svg"
     class="top-bar-back"
     alt="Atrás"
     id="back-button"
     onclick="goBackToList()">

           <!-- Navegación juego a juego (centrada) -->
<div class="game-nav-bar game-nav-bar--inline">
    <div class="game-nav-center">
        <img src="assets/img/ic_back.svg"
             class="game-nav-arrow game-nav-arrow--prev"
             alt="Anterior">

        <span class="game-nav-title"></span>

        <img src="assets/img/ic_back.svg"
             class="game-nav-arrow game-nav-arrow--next game-nav-arrow--next-real"
             alt="Siguiente">
    </div>
    <div class="game-nav-counter-line">
        <span class="game-nav-counter">- / -</span>
    </div>
</div>

            <!-- Botón HOME (derecha) -->
            <img src="assets/img/ic_home.svg"
                 class="top-bar-home"
                 alt="Home"
                 onclick="window.location.href='index.html'">

        </div>
    </header>

    <!-- CONTENIDO -->
<main class="platforms-content">
    
<!-- BLOQUE SUPERIOR: Carátula + Info básica -->
<div class="ficha-hero">
    <div class="ficha-cover-wrapper">
        <span class="skeleton-label" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:rgba(255,255,255,0.4); font-size:14px; font-weight:500; text-transform:uppercase; letter-spacing:1px; pointer-events:none;">Carátula</span>
        <img id="ficha-cover"
             class="ficha-cover"
             alt="Carátula del juego"
             style="display:none; opacity:0; transition:opacity 0.2s ease-in-out;">
    </div>
    <div class="ficha-hero-info">
        <h1 id="ficha-title" class="loading-title">Cargando ficha...</h1>

        <!-- Estos empiezan ocultos -->
        <p class="ficha-platform" id="ficha-platform" style="display:none;">Cargando...</p>
        <p class="ficha-puntuacion" id="ficha-puntuacion" style="display:none;"></p>

        <div class="ficha-rating" style="display:none;">
            <span class="ficha-rating-stars" id="ficha-rating-stars">★★★★★</span>
        </div>
    </div>
</div>

<!-- SCREENSHOTS -->
<div class="ficha-screenshots" id="ficha-screenshots" style="display:none;">
    <div class="screenshot-wrapper" id="screenshot-wrapper-1">
        <span class="skeleton-label" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:rgba(255,255,255,0.4); font-size:12px; font-weight:500; text-transform:uppercase; letter-spacing:1px; pointer-events:none;">Screenshot 1</span>
        <img id="screenshot-1" class="screenshot-img" alt="Screenshot 1" style="display:none;">
    </div>
    <div class="screenshot-wrapper" id="screenshot-wrapper-2">
        <span class="skeleton-label" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:rgba(255,255,255,0.4); font-size:12px; font-weight:500; text-transform:uppercase; letter-spacing:1px; pointer-events:none;">Screenshot 2</span>
        <img id="screenshot-2" class="screenshot-img" alt="Screenshot 2" style="display:none;">
    </div>
</div>

<!-- SECCIÓN FICHA -->
<div class="ficha-section">
    <h2 class="ficha-section-title">FICHA</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-datos" id="ficha-datos" style="display:none;">
        <!-- Los datos se rellenan por JS -->
    </div>
</div>

<!-- SECCIÓN + INFO -->
<!-- SECCIÓN + INFO -->
<div class="ficha-section" id="masinfo-section" style="display:none;">
    <h2 class="ficha-section-title">+ INFO</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-datos" id="ficha-masinfo">
        <!-- El texto se rellena por JS -->
    </div>
</div>

<!-- SECCIÓN SINOPSIS -->
<div class="ficha-section" id="sinopsis-section" style="display:none;">
    <h2 class="ficha-section-title">SINOPSIS</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-sinopsis" id="ficha-sinopsis">
        <!-- El texto se rellena por JS -->
    </div>
</div>

<!-- SECCIÓN ARGUMENTO -->
<div class="ficha-section" id="argumento-section" style="display:none;">
    <h2 class="ficha-section-title">ARGUMENTO</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-sinopsis" id="ficha-argumento">
        <!-- El texto se rellena por JS -->
    </div>
</div>

<!-- SECCIÓN DATOS TÉCNICOS -->
<div class="ficha-section" id="datos-tecnicos-section" style="display:none;">
    <h2 class="ficha-section-title">DATOS TÉCNICOS</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-datos ficha-datos-tecnicos" id="ficha-datos-tecnicos">
        <!-- Los datos se rellenan por JS -->
    </div>
</div>

   <!-- SECCIÓN GAMEPLAY -->
<div class="ficha-section ficha-section--flush" id="gameplay-section" style="display:none;">
    <h2 class="ficha-section-title">GAMEPLAY</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-gameplay" id="ficha-gameplay">
        <div class="ficha-gameplay-frame" id="ficha-gameplay-frame">
            <div class="ficha-gameplay-placeholder" id="ficha-gameplay-placeholder">
                <div class="ficha-gameplay-play"></div>
            </div>
        </div>
    </div>
</div>
 
    <!-- SECCIÓN IMÁGENES ADICIONALES -->
<div class="ficha-section ficha-section--flush" id="imagenes-section" style="display:none;">
    <h2 class="ficha-section-title">IMÁGENES</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-imagenes" id="ficha-imagenes">
        <div class="ficha-imagenes-frame" id="ficha-imagenes-frame">
            <img id="ficha-imagenes-img" class="ficha-imagenes-img" alt="Imagen adicional" style="display:none;">
        </div>
        <div class="ficha-imagenes-nav" id="ficha-imagenes-nav" style="display:none;">
            <img src="assets/img/ic_back.svg" class="ficha-imagenes-arrow ficha-imagenes-arrow--prev" alt="Anterior">
            <span class="ficha-imagenes-counter">
                <span id="imagenes-current">1</span> / <span id="imagenes-total">1</span>
            </span>
            <img src="assets/img/ic_back.svg" class="ficha-imagenes-arrow ficha-imagenes-arrow--next" alt="Siguiente">
        </div>
    </div>
</div>

</main>

   <script>
    // ============================================
    // CONFIGURACIÓN DE CACHÉ Y PREFETCHING
    // ============================================
    const CACHE_DURATION = 30 * 60 * 1000; // 30 minutos
    const CACHE_VERSION = "v1"; // Cambia esto si actualizas estructura de datos
    const PREFETCH_DELAY = 2000; // 2 segundos - tiempo para que usuario empiece a leer

    // ============================================
    // FUNCIONES DE CACHÉ
    // ============================================
    
    function getCachedData(key) {
        try {
            const cached = sessionStorage.getItem(key);
            if (!cached) return null;
            
            const data = JSON.parse(cached);
            const now = Date.now();
            
            if (now - data.timestamp > CACHE_DURATION) {
                sessionStorage.removeItem(key);
                return null;
            }
            
            return data.value;
        } catch {
            return null;
        }
    }

    function setCachedData(key, value) {
        try {
            sessionStorage.setItem(key, JSON.stringify({
                timestamp: Date.now(),
                version: CACHE_VERSION,
                value: value
            }));
        } catch (e) {
            console.warn("No se pudo guardar en caché:", e);
        }
    }

    // Caché de fichas individuales
    function getCachedFicha(platform, gameId) {
        const key = `ficha_${platform}_${gameId}`;
        return getCachedData(key);
    }

    function setCachedFicha(platform, gameId, gameData) {
        const key = `ficha_${platform}_${gameId}`;
        setCachedData(key, gameData);
    }

    // ============================================
    // CONFIGURACIÓN DE PLATAFORMAS IGDB
    // ============================================
    const PLATFORM_CONFIG = {
PSX: {
  name: "PLAYSTATION",
  shortName: "PSX",
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=405975879&single=true&output=csv",
  listaPage: "igdb-lista.html",
  fichaPage: "igdb-ficha.html",
  formatoCol: "PSX_TIPO_FORMATO",
  ubicacionCol: "PSX_UBICACION"
},
PS2: {
  name: "PLAYSTATION 2",
  shortName: "PS2",
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1412360946&single=true&output=csv",
  listaPage: "igdb-lista.html",
  fichaPage: "igdb-ficha.html",
  formatoCol: "PS2_TIPO_FORMATO",
  ubicacionCol: "PS2_UBICACION"
},
PS3: {
  name: "PlayStation 3",
  shortName: "PS3",
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=511776549&single=true&output=csv",
  listaPage: "igdb-lista.html",
  fichaPage: "igdb-ficha.html",
  formatoCol: "PS3_TIPO_FORMATO",
  ubicacionCol: "PS3_UBICACION"
  },
NES: {
  name: "Nintendo Entertainment System",
  shortName: "NES",
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1428079783&single=true&output=csv",
  listaPage: "igdb-lista.html",
  fichaPage: "igdb-ficha.html",
  formatoCol: "NES_TIPO_FORMATO",
  ubicacionCol: "NES_UBICACION"
},
SNES: {
  name: "Super Nintendo",
  shortName: "SNES",
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=287633811&single=true&output=csv",
  listaPage: "igdb-lista.html",
  fichaPage: "igdb-ficha.html",
  formatoCol: "SNES_TIPO_FORMATO",
  ubicacionCol: "SNES_UBICACION"
},
N64: {
  name: "Nintendo 64",
  shortName: "N64",
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=387524599&single=true&output=csv",
  listaPage: "igdb-lista.html",
  fichaPage: "igdb-ficha.html",
  formatoCol: "N64_TIPO_FORMATO",
  ubicacionCol: "N64_UBICACION"
},
SWITCH: {
  name: "Nintendo Switch",
  shortName: "SWITCH",
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=175745331&single=true&output=csv",
  listaPage: "igdb-lista.html",
  fichaPage: "igdb-ficha.html",
  formatoCol: "SWITCH_TIPO_FORMATO",
  ubicacionCol: "SWITCH_UBICACION"
},
SATURN: {
  name: "SEGA Saturn",
  shortName: "Saturn",
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1892216742&single=true&output=csv",
  listaPage: "igdb-lista.html",
  fichaPage: "igdb-ficha.html",
  formatoCol: "SATURN_TIPO_FORMATO",
  ubicacionCol: "SATURN_UBICACION"
},
PS4: {
  name: "PlayStation 4",
  shortName: "PS4",
  csvUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=555080380&single=true&output=csv",
  listaPage: "igdb-lista.html",
  fichaPage: "igdb-ficha.html",
  formatoCol: "PS4_TIPO_FORMATO",
  ubicacionCol: "PS4_UBICACION"
}
};

    // URL del CSV de colección completa (para navegación desde coleccion.html)
    const COLECCION_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1929298971&single=true&output=csv";

    // Obtener plataforma de la URL
    function getPlatformFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("platform") || "PS3";
    }

    const CURRENT_PLATFORM = getPlatformFromUrl();
    const CONFIG = PLATFORM_CONFIG[CURRENT_PLATFORM] || PLATFORM_CONFIG.PS3;

    // URLs dinámicas según plataforma
    const PS3_CSV_URL = CONFIG.csvUrl;

    // Función para volver a la lista
    function goBackToList() {
      const params = new URLSearchParams(window.location.search);
      const fromColeccion = params.get("from") === "coleccion";
      
      // Si viene de colección, volver a coleccion.html
      if (fromColeccion) {
        window.location.href = "coleccion.html";
        return;
      }
      
      // Si no, volver a la lista de la plataforma
      let url = `${CONFIG.listaPage}?platform=${CURRENT_PLATFORM}`;
      window.location.href = url;
    }

    // Lista ordenada de juegos para navegación
    let sortedGamesList = [];
    let currentGameIndex = -1;
       
    // Imágenes adicionales
    let additionalImages = [];
    let additionalImageIndex = 0;
    let additionalImagesKeydownBound = false;
    let modalAbierta = false;
    let currentGroupLabel = "";

    // Variable global para compartir datos entre funciones
    let allGamesData = [];

    // ============================================
    // UTILIDADES
    // ============================================
    
    function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const ch = line[i];

            if (ch === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (ch === "," && !inQuotes) {
                result.push(current.trim());
                current = "";
            } else {
                current += ch;
            }
        }

        result.push(current.trim());
        return result;
    }

    function findColumnIndex(header, names) {
        for (const name of names) {
            const idx = header.indexOf(name);
            if (idx >= 0) return idx;
        }
        return -1;
    }

    function getColumnValue(cols, idx) {
        return idx >= 0 && cols[idx] !== undefined ? cols[idx].trim() : "";
    }
       
function normalizeUrlValue(value) {
        const trimmed = (value || "").trim();
        return trimmed ? trimmed : "";
    }

    function formatTitleWithArticle(title) {
        if (!title) return "";
        const t = title.trim();
        const re = /^(the|a|an|el|la|los|las|lo)\s+(.*)$/i;
        const match = t.match(re);
        if (!match) return t;
        return match[2] + ", " + match[1];
    }

    function normalizeText(str) {
    return (str || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
}

// ============================================
// PARSER CSV GENERAL (soporta saltos de línea dentro de comillas)
// ============================================
function parseCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentField = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const ch = text[i];

        if (ch === '"') {
            if (inQuotes && text[i + 1] === '"') {
                currentField += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (ch === "," && !inQuotes) {
            currentRow.push(currentField.trim());
            currentField = "";
        } else if ((ch === "\n" || ch === "\r") && !inQuotes) {
            if (ch === "\r" && text[i + 1] === "\n") {
                i++;
            }
            currentRow.push(currentField.trim());
            if (currentRow.some(v => v !== "")) {
                rows.push(currentRow);
            }
            currentRow = [];
            currentField = "";
        } else {
            currentField += ch;
        }
    }

    if (currentField.length > 0 || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.some(v => v !== "")) {
            rows.push(currentRow);
        }
    }

    return rows;
}

function parseScreenshotsList(text) {
    return (text || "")
        .split(",")
        .map(url => url.trim())
        .filter(url => url !== "" && url !== "--");
}

// ============================================
// PARSER CSV - FICHA PS3 (datos completos)
// ============================================
function parsePS3CSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];

    const header = parseCSVLine(lines[0]);
    console.log("Columnas del CSV:", header);
    const expectedCols = header.length;
    const rows = [];

    // Índices de columnas
    const idxID = header.indexOf("ID");
    const idxTitulo = findColumnIndex(header, ["TITULO", "TÍTULO"]);
    const idxAnio = findColumnIndex(header, ["AÑO", "ANO"]);
    const idxPublisher = header.indexOf("PUBLISHER");
    const idxDesarrollo = header.indexOf("DESARROLLO");
    const idxGenero = findColumnIndex(header, ["GENERO", "GÉNERO"]);
    const idxSubgenero = findColumnIndex(header, ["SUBGENERO", "SUBGÉNERO"]);
    const idxCaratula = findColumnIndex(header, ["CARATULA", "CARÁTULA"]);
    const idxScreenshots = header.indexOf("SCREENSHOTS");
    const idxPuntuacion = findColumnIndex(header, ["PUNTUACION", "PUNTUACIÓN"]);
    const idxMasInfo = header.indexOf("MAS_INFO");
    const idxSinopsis = header.indexOf("SINOPSIS");
    const idxArgumento = header.indexOf("ARGUMENTO");
    const idxJugadores = header.indexOf("JUGADORES");
    // Columnas dinámicas según plataforma
    const idxFormato = header.indexOf(CONFIG.formatoCol);
    const idxUbicacion = header.indexOf(CONFIG.ubicacionCol);
    const idxFavorito = header.indexOf("FAVORITO");
    const idxTerminado = header.indexOf("TERMINADO");
    const idxVideo = header.indexOf("VIDEO");

    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;

        let rawLine = lines[i];
        let cols = parseCSVLine(rawLine);

        // Si la fila viene "rota" en varias líneas, vamos pegando
        while (cols.length < expectedCols && i + 1 < lines.length) {
            rawLine += "\n" + lines[i + 1];
            i++;
            cols = parseCSVLine(rawLine);
        }

        const thisId = getColumnValue(cols, idxID);
        const screenshotsRaw = getColumnValue(cols, idxScreenshots);
        const screenshotsList = parseScreenshotsList(screenshotsRaw);

        rows.push({
            id: thisId,
            titulo: getColumnValue(cols, idxTitulo),
            anio: getColumnValue(cols, idxAnio),
            publisher: getColumnValue(cols, idxPublisher),
            desarrollo: getColumnValue(cols, idxDesarrollo),
            genero: getColumnValue(cols, idxGenero),
            subgenero: getColumnValue(cols, idxSubgenero),
            caratula: getColumnValue(cols, idxCaratula),
            screenshotsRaw: screenshotsRaw,
            screenshotsList: screenshotsList,
            puntuacion: getColumnValue(cols, idxPuntuacion),
            masInfo: getColumnValue(cols, idxMasInfo),
            sinopsis: getColumnValue(cols, idxSinopsis),
            argumento: getColumnValue(cols, idxArgumento),
            jugadores: getColumnValue(cols, idxJugadores),
            formato: getColumnValue(cols, idxFormato),
            ubicacion: getColumnValue(cols, idxUbicacion),
            favorito: getColumnValue(cols, idxFavorito),
            terminado: getColumnValue(cols, idxTerminado),
            videoUrl: getColumnValue(cols, idxVideo)
        });
    }

    return rows;
}

// ============================================
// PARSER CSV - COLECCIÓN (para navegación desde coleccion.html)
// ============================================
function parseColeccionCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentField = "";
    let inQuotes = false;

    // Parser robusto que soporta saltos de línea dentro de comillas
    for (let i = 0; i < text.length; i++) {
        const ch = text[i];

        if (ch === '"') {
            if (inQuotes && text[i + 1] === '"') {
                currentField += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (ch === "," && !inQuotes) {
            currentRow.push(currentField.trim());
            currentField = "";
        } else if ((ch === "\n" || ch === "\r") && !inQuotes) {
            if (ch === "\r" && text[i + 1] === "\n") {
                i++;
            }
            currentRow.push(currentField.trim());
            if (currentRow.some(v => v !== "")) {
                rows.push(currentRow);
            }
            currentRow = [];
            currentField = "";
        } else {
            currentField += ch;
        }
    }

    if (currentField.length > 0 || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.some(v => v !== "")) {
            rows.push(currentRow);
        }
    }

    if (rows.length === 0) return [];

    const header = rows[0];
    const games = [];

    const idxID = header.indexOf("ID");
    const idxTitulo = header.indexOf("TITULO_MOSTRAR");
    const idxPlataforma = header.indexOf("PLATAFORMA");
    const idxAnio = header.indexOf("AÑO_MOSTRAR");
    const idxFavorito = header.indexOf("FAVORITO");
    const idxTerminado = header.indexOf("TERMINADO");
    const idxFormato = header.indexOf("FORMATO_MOSTRAR");
    const idxGenero = header.indexOf("GENERO_MOSTRAR");
    const idxSubgenero = header.indexOf("SUBGENERO_MOSTRAR");
    const idxPublisher = header.indexOf("PUBLISHER_MOSTRAR");
    const idxDesarrollo = header.indexOf("DESARROLLO_MOSTRAR");
    const idxFichaPage = header.indexOf("FICHA_PAGE");

    for (let i = 1; i < rows.length; i++) {
        const cols = rows[i];
        const id = idxID >= 0 && cols[idxID] ? cols[idxID].trim() : "";
        const titulo = idxTitulo >= 0 && cols[idxTitulo] ? cols[idxTitulo].trim() : "";

        if (!titulo) continue;

        const displayTitulo = formatTitleWithArticle(titulo);

        games.push({
            id,
            titulo,
            displayTitulo,
            sortKey: displayTitulo.toLowerCase(),
            plataforma: idxPlataforma >= 0 && cols[idxPlataforma] ? cols[idxPlataforma].trim() : "",
            anio: idxAnio >= 0 && cols[idxAnio] ? cols[idxAnio].trim() : "",
            favorito: idxFavorito >= 0 && cols[idxFavorito] ? cols[idxFavorito].trim() : "",
            terminado: idxTerminado >= 0 && cols[idxTerminado] ? cols[idxTerminado].trim() : "",
            formato: idxFormato >= 0 && cols[idxFormato] ? cols[idxFormato].trim() : "",
            genero: idxGenero >= 0 && cols[idxGenero] ? cols[idxGenero].trim() : "",
            subgenero: idxSubgenero >= 0 && cols[idxSubgenero] ? cols[idxSubgenero].trim() : "",
            pub: idxPublisher >= 0 && cols[idxPublisher] ? cols[idxPublisher].trim() : "",
            desarrollo: idxDesarrollo >= 0 && cols[idxDesarrollo] ? cols[idxDesarrollo].trim() : "",
            fichaPage: idxFichaPage >= 0 && cols[idxFichaPage] ? cols[idxFichaPage].trim() : ""
        });
    }

    return games;
}

    // ============================================
    // EXTRACCIÓN DE CARÁTULA
    // ============================================
    
    function getCoverURL(game) {
        if (game.caratula) {
            return game.caratula;
        }
        return "";
    }

    // Convierte cualquier URL de YouTube a formato embed
    function convertToYouTubeEmbed(url) {
        if (!url) return "";
        
        // Si ya es formato embed, devolverla tal cual
        if (url.includes("/embed/")) {
            return url;
        }
        
        // Extraer el ID del video de formato watch?v=
        const watchMatch = url.match(/[?&]v=([^?&#]+)/);
        if (watchMatch && watchMatch[1]) {
            return `https://www.youtube.com/embed/${watchMatch[1]}`;
        }
        
        // Extraer el ID de formato youtu.be/
        const shortMatch = url.match(/youtu\.be\/([^?&#]+)/);
        if (shortMatch && shortMatch[1]) {
            return `https://www.youtube.com/embed/${shortMatch[1]}`;
        }
        
        return url;
    }

    // Extrae el ID del video de cualquier formato de URL de YouTube
    function getYouTubeVideoId(url) {
        if (!url) return "";
        
        // Formato embed
        const embedMatch = url.match(/embed\/([^?&#\/]+)/);
        if (embedMatch && embedMatch[1]) return embedMatch[1];
        
        // Formato watch?v=
        const watchMatch = url.match(/[?&]v=([^?&#]+)/);
        if (watchMatch && watchMatch[1]) return watchMatch[1];
        
        // Formato youtu.be/
        const shortMatch = url.match(/youtu\.be\/([^?&#]+)/);
        if (shortMatch && shortMatch[1]) return shortMatch[1];
        
        return "";
    }

    function getYouTubeThumbnail(url) {
        const videoId = getYouTubeVideoId(url);
        if (videoId) {
            return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        }
        return "";
    }


    // ============================================
    // ACTUALIZACIÓN DE UI
    // ============================================
    
function updateTitle(game) {
    const title = game.titulo || `Juego ${CONFIG.name}`;
    document.title = `${title} – ${CONFIG.name}`;

    const h1 = document.getElementById("ficha-title");
    if (h1) {
        h1.textContent = title;
        h1.classList.remove("loading-title");
    }

    const platformEl = document.getElementById("ficha-platform");
    if (platformEl) {
        platformEl.textContent = CONFIG.name;
        platformEl.style.display = "block";
    }

    // Mostrar sección FICHA
    const fichaSection = document.querySelector(".ficha-section");
    if (fichaSection) {
        fichaSection.style.display = "block";
    }

    document.body.classList.remove("loading");
}

function updateCover(game) {
    const coverImg = document.getElementById("ficha-cover");
    const wrapper = document.querySelector(".ficha-cover-wrapper");
    if (!coverImg || !wrapper) return;

    const fallbackCover = "assets/img/CaratulaNoDisponible.png";
    const coverUrl = (getCoverURL(game) || "").trim();
    const hasValidCover = coverUrl && coverUrl.toLowerCase() !== "null";
    const finalCoverUrl = hasValidCover ? coverUrl : fallbackCover;

    coverImg.style.opacity = "0";
    coverImg.style.display = "block";

    coverImg.onload = function() {
        coverImg.style.opacity = "1";
        const coverLabel = wrapper.querySelector(".skeleton-label");
        if (coverLabel) coverLabel.style.display = "none";
        wrapper.classList.add("loaded");
    };

    coverImg.onerror = function() {
        const fallbackAbsolute = new URL(fallbackCover, window.location.href).href;
        if (coverImg.src !== fallbackAbsolute) {
            coverImg.onerror = null;
            coverImg.src = fallbackCover;
        }
    };

    coverImg.src = finalCoverUrl;
    coverImg.alt = `Carátula de ${game.titulo || `juego ${CONFIG.name}`}`;
    coverImg.style.display = "block";

    // Añadir estrella si es favorito
    const isFavorito = (game.favorito || "").trim().toUpperCase() === "SI";
    const existingStar = wrapper.querySelector(".ficha-favorito-star");
    
    if (isFavorito && !existingStar) {
        const star = document.createElement("img");
        star.src = "assets/img/ic_favorito.svg";
        star.alt = "Favorito";
        star.className = "ficha-favorito-star";
        wrapper.appendChild(star);
    } else if (!isFavorito && existingStar) {
        existingStar.remove();
    }
}

function updatePuntuacion(game) {
    const puntuacionEl = document.getElementById("ficha-puntuacion");
    const ratingEl = document.querySelector(".ficha-rating");
    const starsEl = document.getElementById("ficha-rating-stars");
    if (!puntuacionEl || !ratingEl || !starsEl) return;

    const valor = (game.puntuacion || "").trim();

    if (valor) {
        // Texto debajo de PlayStation 3
        puntuacionEl.innerHTML = `<b>Puntuación:</b> ${valor}`;
        puntuacionEl.style.display = "block";
        ratingEl.style.display = "flex";

        // Sacar la nota (valor de 0 a 100)
        const match = valor.match(/^(\d+)/);
        let nota = 0;
        if (match) {
            nota = parseInt(match[1], 10);
        }

        // Clamp 0–100
        if (isNaN(nota)) nota = 0;
        if (nota < 0) nota = 0;
        if (nota > 100) nota = 100;

        // El porcentaje es directamente la nota (ya es de 0 a 100)
        const porcentaje = nota;

        // Elegir color (adaptado para escala 0-100)
        let color = "#ff4b4b"; // rojo < 50
        if (nota >= 70) {
            color = "#00c853"; // verde >= 70
        } else if (nota >= 50) {
            color = "#ffd600"; // amarillo 50-69
        }

        // Aplicar variables CSS con animación
        starsEl.style.setProperty("--fill", "0%");
        starsEl.style.setProperty("--rating-color", color);
        void starsEl.offsetWidth;
        starsEl.style.setProperty("--fill", porcentaje + "%");

    } else {
        puntuacionEl.innerHTML = "";
        puntuacionEl.style.display = "none";
        ratingEl.style.display = "none";
        starsEl.style.setProperty("--fill", "0%");
    }
}

// ============================================
// SCREENSHOTS
// ============================================

function updateScreenshots(game) {
    const screenshot1 = document.getElementById("screenshot-1");
    const screenshot2 = document.getElementById("screenshot-2");
    const wrapper1 = document.getElementById("screenshot-wrapper-1");
    const wrapper2 = document.getElementById("screenshot-wrapper-2");
    const container = document.getElementById("ficha-screenshots");

    if (!screenshot1 || !screenshot2 || !container) return;

    const screenshots = game.screenshotsList || [];
    const screenshot1Url = screenshots[0] || "";
    const screenshot2Url = screenshots[1] || "";

    // Si no hay ninguna screenshot, ocultar todo el contenedor
    if (!screenshot1Url && !screenshot2Url) {
        container.style.display = "none";
        return;
    }

    container.style.display = "flex";

    // Screenshot 1
    if (screenshot1Url) {
        screenshot1.src = screenshot1Url;
        screenshot1.style.display = "block";
        screenshot1.onclick = () => openModal(screenshot1Url);
        wrapper1.classList.remove("empty");
        wrapper1.style.display = "block";
        const label1 = wrapper1.querySelector(".skeleton-label");
        if (label1) label1.style.display = "none";
    } else {
        screenshot1.style.display = "none";
        wrapper1.style.display = "none";
    }

    // Screenshot 2
    if (screenshot2Url) {
        screenshot2.src = screenshot2Url;
        screenshot2.style.display = "block";
        screenshot2.onclick = () => openModal(screenshot2Url);
        wrapper2.classList.remove("empty");
        wrapper2.style.display = "block";
        const label2 = wrapper2.querySelector(".skeleton-label");
        if (label2) label2.style.display = "none";
    } else {
        screenshot2.style.display = "none";
        wrapper2.style.display = "none";
    }
}

function openModal(src) {
    const modal = document.getElementById("cover-modal");
    const modalImg = document.getElementById("cover-modal-img");
    if (modal && modalImg) {
        modalImg.src = src;
        modal.classList.add("active");
        modalAbierta = true;
    }
}

// ============================================
// DATOS DE LA FICHA
// ============================================
function updateFichaDatos(game) {
    const container = document.getElementById("ficha-datos");
    if (!container) return;

    const campos = [
        { label: "· AÑO", value: game.anio },
        { label: "· EDITOR", value: game.publisher },
        { label: "· DESARROLLO", value: game.desarrollo },
        { label: "· GÉNERO", value: game.genero },
        { label: "· SUBGÉNERO", value: game.subgenero }
    ];

    const camposConValor = campos.filter(c => c.value && c.value.trim() !== "");

    if (camposConValor.length === 0) {
        container.style.display = "none";
        return;
    }

    let html = "";
    camposConValor.forEach(campo => {
        html += `<p class="ficha-dato"><span class="ficha-dato-label">${campo.label}:</span> ${campo.value}</p>`;
    });

    container.innerHTML = html;
    container.style.display = "block";
}

// ============================================
// + INFO
// ============================================
function updateMasInfo(game) {
    const section = document.getElementById("masinfo-section");
    const container = document.getElementById("ficha-masinfo");
    if (!section || !container) return;

    const masInfo = (game.masInfo || "").trim();

    if (!masInfo) {
        section.style.display = "none";
        return;
    }

    // Formatear: cada "- " (excepto el primero) genera un salto de línea
    // Primero quitamos el "- " inicial si existe, luego dividimos por "- "
    let formattedText = masInfo;
    if (formattedText.startsWith("- ")) {
        formattedText = formattedText.substring(2);
    }
    
    // Dividir por "- " y crear elementos
    const items = formattedText.split("- ").map(item => item.trim()).filter(item => item);
    
    const textDiv = document.createElement("div");
    textDiv.className = "ficha-dato"; // Usar misma clase que FICHA para consistencia de espaciado
    
    items.forEach((item, index) => {
        if (index > 0) {
            textDiv.appendChild(document.createElement("br"));
        }
        textDiv.appendChild(document.createTextNode("- " + item));
    });
    
    container.appendChild(textDiv);
    
    section.style.display = "block";
}

// ============================================
// SINOPSIS Y ARGUMENTO CON VOZ
// ============================================
let sinopsisVoiceButton = null;
let sinopsisVoiceOnIcon = null;
let sinopsisVoiceOffIcon = null;
let argumentoVoiceButton = null;
let argumentoVoiceOnIcon = null;
let argumentoVoiceOffIcon = null;
let currentUtterance = null;
let isReadingSinopsis = false;
let isReadingArgumento = false;
const speechSupported =
    typeof window !== "undefined" &&
    "speechSynthesis" in window &&
    typeof SpeechSynthesisUtterance !== "undefined";

function resetSinopsisVoiceIcons() {
    if (!sinopsisVoiceButton) return;
    if (sinopsisVoiceOnIcon && sinopsisVoiceOffIcon) {
        sinopsisVoiceOnIcon.style.display = isReadingSinopsis ? "none" : "block";
        sinopsisVoiceOffIcon.style.display = isReadingSinopsis ? "block" : "none";
    }
}

function resetArgumentoVoiceIcons() {
    if (!argumentoVoiceButton) return;
    if (argumentoVoiceOnIcon && argumentoVoiceOffIcon) {
        argumentoVoiceOnIcon.style.display = isReadingArgumento ? "none" : "block";
        argumentoVoiceOffIcon.style.display = isReadingArgumento ? "block" : "none";
    }
}

function stopAllVoice() {
    if (!speechSupported) return;
    window.speechSynthesis.cancel();
    currentUtterance = null;
    isReadingSinopsis = false;
    isReadingArgumento = false;
    resetSinopsisVoiceIcons();
    resetArgumentoVoiceIcons();
}

function getPreferredSpanishVoice() {
    if (!speechSupported) return null;
    const voices = window.speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;

    const preferred = voices.find(voice =>
        voice.lang && voice.lang.toLowerCase().startsWith("es-es")
    );
    if (preferred) return preferred;

    const anySpanish = voices.find(voice => voice.lang && voice.lang.toLowerCase().startsWith("es"));
    return anySpanish || voices[0];
}

function handleSinopsisVoiceEnd() {
    isReadingSinopsis = false;
    currentUtterance = null;
    resetSinopsisVoiceIcons();
}

function handleArgumentoVoiceEnd() {
    isReadingArgumento = false;
    currentUtterance = null;
    resetArgumentoVoiceIcons();
}

function startSinopsisVoice() {
    if (!speechSupported) return;
    const textEl = document.querySelector(".ficha-sinopsis-texto");
    const text = textEl ? textEl.textContent.trim() : "";
    if (!text) return;

    stopAllVoice();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "es-ES";
    utterance.rate = 1;
    utterance.volume = 1;
    const voice = getPreferredSpanishVoice();
    if (voice) {
        utterance.voice = voice;
    }
    utterance.onend = handleSinopsisVoiceEnd;
    utterance.onerror = handleSinopsisVoiceEnd;

    currentUtterance = utterance;
    isReadingSinopsis = true;
    resetSinopsisVoiceIcons();
    window.speechSynthesis.speak(utterance);
}

function startArgumentoVoice() {
    if (!speechSupported) return;
    const textEl = document.querySelector(".ficha-argumento-texto");
    const text = textEl ? textEl.textContent.trim() : "";
    if (!text) return;

    stopAllVoice();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "es-ES";
    utterance.rate = 1;
    utterance.volume = 1;
    const voice = getPreferredSpanishVoice();
    if (voice) {
        utterance.voice = voice;
    }
    utterance.onend = handleArgumentoVoiceEnd;
    utterance.onerror = handleArgumentoVoiceEnd;

    currentUtterance = utterance;
    isReadingArgumento = true;
    resetArgumentoVoiceIcons();
    window.speechSynthesis.speak(utterance);
}

function toggleSinopsisVoice() {
    if (!speechSupported) return;
    if (isReadingSinopsis) {
        stopAllVoice();
    } else {
        startSinopsisVoice();
    }
}

function toggleArgumentoVoice() {
    if (!speechSupported) return;
    if (isReadingArgumento) {
        stopAllVoice();
    } else {
        startArgumentoVoice();
    }
}

function renderSinopsisVoiceButton(container) {
    sinopsisVoiceButton = document.createElement("button");
    sinopsisVoiceButton.type = "button";
    sinopsisVoiceButton.className = "sinopsis-voice-button";
    sinopsisVoiceButton.setAttribute("aria-label", "Leer sinopsis en voz alta");

    sinopsisVoiceOnIcon = document.createElement("img");
    sinopsisVoiceOnIcon.src = "assets/img/ic_voz_ON.svg";
    sinopsisVoiceOnIcon.alt = "Reproducir voz";
    sinopsisVoiceOnIcon.className = "sinopsis-voice-icon sinopsis-voice-icon--on";

    sinopsisVoiceOffIcon = document.createElement("img");
    sinopsisVoiceOffIcon.src = "assets/img/ic_voz_OFF.svg";
    sinopsisVoiceOffIcon.alt = "Detener voz";
    sinopsisVoiceOffIcon.className = "sinopsis-voice-icon sinopsis-voice-icon--off";

    sinopsisVoiceButton.appendChild(sinopsisVoiceOnIcon);
    sinopsisVoiceButton.appendChild(sinopsisVoiceOffIcon);
    container.appendChild(sinopsisVoiceButton);
    resetSinopsisVoiceIcons();

    if (!speechSupported) {
        sinopsisVoiceButton.style.display = "none";
        return;
    }

    sinopsisVoiceButton.addEventListener("click", toggleSinopsisVoice);
}

function renderArgumentoVoiceButton(container) {
    argumentoVoiceButton = document.createElement("button");
    argumentoVoiceButton.type = "button";
    argumentoVoiceButton.className = "sinopsis-voice-button";
    argumentoVoiceButton.setAttribute("aria-label", "Leer argumento en voz alta");

    argumentoVoiceOnIcon = document.createElement("img");
    argumentoVoiceOnIcon.src = "assets/img/ic_voz_ON.svg";
    argumentoVoiceOnIcon.alt = "Reproducir voz";
    argumentoVoiceOnIcon.className = "sinopsis-voice-icon sinopsis-voice-icon--on";

    argumentoVoiceOffIcon = document.createElement("img");
    argumentoVoiceOffIcon.src = "assets/img/ic_voz_OFF.svg";
    argumentoVoiceOffIcon.alt = "Detener voz";
    argumentoVoiceOffIcon.className = "sinopsis-voice-icon sinopsis-voice-icon--off";

    argumentoVoiceButton.appendChild(argumentoVoiceOnIcon);
    argumentoVoiceButton.appendChild(argumentoVoiceOffIcon);
    container.appendChild(argumentoVoiceButton);
    resetArgumentoVoiceIcons();

    if (!speechSupported) {
        argumentoVoiceButton.style.display = "none";
        return;
    }

    argumentoVoiceButton.addEventListener("click", toggleArgumentoVoice);
}

function updateSinopsis(game) {
    const section = document.getElementById("sinopsis-section");
    const container = document.getElementById("ficha-sinopsis");
    if (!section || !container) return;

    const sinopsis = (game.sinopsis || "").trim();

    if (!sinopsis) {
        section.style.display = "none";
        return;
    }

    const textParagraph = document.createElement("p");
    textParagraph.className = "ficha-sinopsis-texto";
    textParagraph.textContent = sinopsis;
    container.appendChild(textParagraph);
    renderSinopsisVoiceButton(container);
    
    section.style.display = "block";
}

function updateArgumento(game) {
    const section = document.getElementById("argumento-section");
    const container = document.getElementById("ficha-argumento");
    if (!section || !container) return;

    const argumento = (game.argumento || "").trim();

    if (!argumento) {
        section.style.display = "none";
        return;
    }

    const textParagraph = document.createElement("p");
    textParagraph.className = "ficha-argumento-texto";
    textParagraph.textContent = argumento;
    container.appendChild(textParagraph);
    renderArgumentoVoiceButton(container);
    
    section.style.display = "block";
}


// ============================================
// DATOS TÉCNICOS
// ============================================
function updateDatosTecnicos(game) {
    const section = document.getElementById("datos-tecnicos-section");
    const container = document.getElementById("ficha-datos-tecnicos");
    if (!section || !container) return;

    const getStatusClass = (label, value) => {
        const normalized = (value || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");

        const isCompletionField = label.includes("TERMINADO") || label.includes("FAVORITO");

        if (!isCompletionField) return "";

        if (normalized === "no") return "status status--no";
        if (normalized === "si") return "status status--yes";

        return "";
    };
    
    // Construir campos dinámicamente
    const campos = [
        { label: "· MODOS DE JUEGO", value: game.jugadores },
        { label: "· FORMATO", value: game.formato }
    ];

    // Ubicación solo si tiene contenido real (no vacío ni solo guiones)
    const ubicacionVal = (game.ubicacion || "").trim();
    const esVacioOGuiones = !ubicacionVal || /^[-–—]+$/.test(ubicacionVal);
    if (!esVacioOGuiones) {
        campos.push({ label: "· UBICACIÓN", value: game.ubicacion });
    }

    // Favorito solo si es "SI"
    if (game.favorito && game.favorito.trim().toUpperCase() === "SI") {
        campos.push({ label: "· FAVORITO", value: game.favorito });
    }

    // Terminado siempre
    campos.push({ label: "· TERMINADO", value: game.terminado });

    const camposConValor = campos.filter(campo => campo.value && campo.value.trim() !== "");

    if (!camposConValor.length) {
        section.style.display = "none";
        return;
    }

    const html = camposConValor
        .map(campo => {
            const statusClass = getStatusClass(campo.label, campo.value);
            const valueHtml = statusClass
                ? `<span class="${statusClass}">${campo.value}</span>`
                : campo.value;

            return `<p class="ficha-dato"><span class="ficha-dato-label">${campo.label}:</span> ${valueHtml}</p>`;
        })
        .join("");

    container.innerHTML = html;
    section.style.display = "block";
}

// ============================================
// GAMEPLAY
// ============================================
function updateGameplay(game) {
    const section = document.getElementById("gameplay-section");
    const frame = document.getElementById("ficha-gameplay-frame");
    const placeholder = document.getElementById("ficha-gameplay-placeholder");

    if (!section || !frame || !placeholder) return;

    const rawVideoUrl = (game.videoUrl || "").trim();

    if (!rawVideoUrl) {
        section.style.display = "none";
        return;
    }

    // Convertir a formato embed
    const videoUrl = convertToYouTubeEmbed(rawVideoUrl);

    const thumbnail = getYouTubeThumbnail(rawVideoUrl);
    if (thumbnail) {
        placeholder.style.backgroundImage = `url('${thumbnail}')`;
    } else {
        placeholder.style.backgroundImage = "";
    }

    if (!placeholder.dataset.bound) {
        placeholder.dataset.bound = "true";
        placeholder.addEventListener("click", () => {
            const iframe = document.createElement("iframe");
            const separator = videoUrl.includes("?") ? "&" : "?";
            iframe.src = `${videoUrl}${separator}autoplay=1`;
            iframe.className = "ficha-gameplay-iframe";
            iframe.title = "Gameplay";
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
            iframe.allowFullscreen = true;
            iframe.loading = "lazy";

            frame.innerHTML = "";
            frame.appendChild(iframe);
        });
    }

    section.style.display = "block";
}

// ============================================
// IMÁGENES ADICIONALES (a partir de la 3ª screenshot)
// ============================================
function renderAdditionalImage() {
    if (!additionalImages.length) return;

    const imgEl = document.getElementById("ficha-imagenes-img");
    const counterCurrent = document.getElementById("imagenes-current");
    const counterTotal = document.getElementById("imagenes-total");
    const modal = document.getElementById("imagenes-modal");
    const modalImg = document.getElementById("imagenes-modal-img");

    if (!imgEl || !counterCurrent || !counterTotal) return;

    const url = additionalImages[additionalImageIndex];

    imgEl.src = url;
    imgEl.style.display = "block";
    counterCurrent.textContent = (additionalImageIndex + 1).toString();
    counterTotal.textContent = additionalImages.length.toString();

    if (modal && modal.classList.contains("active") && modalImg) {
        modalImg.src = url;
    }
}

function changeAdditionalImage(step) {
    if (!additionalImages.length) return;

    additionalImageIndex = (additionalImageIndex + step + additionalImages.length) % additionalImages.length;
    renderAdditionalImage();
}

function openAdditionalImagesModal() {
    const modal = document.getElementById("imagenes-modal");
    if (!modal || !additionalImages.length) return;

    modal.classList.add("active");
    renderAdditionalImage();
    modalAbierta = true;
}

function closeAdditionalImagesModal() {
    const modal = document.getElementById("imagenes-modal");
    if (modal) {
        modal.classList.remove("active");
    }
    modalAbierta = false;
}

function setupAdditionalImagesModalControls() {
    const modal = document.getElementById("imagenes-modal");
    const closeBtn = document.querySelector(".imagenes-modal-close");
    const prevArrow = document.querySelector(".imagenes-modal-arrow--prev");
    const nextArrow = document.querySelector(".imagenes-modal-arrow--next");

    if (closeBtn && !closeBtn.dataset.bound) {
        closeBtn.dataset.bound = "true";
        closeBtn.addEventListener("click", closeAdditionalImagesModal);
    }

    if (modal && !modal.dataset.bound) {
        modal.dataset.bound = "true";
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                closeAdditionalImagesModal();
            }
        });

        ["touchstart", "touchmove", "touchend"].forEach(eventName => {
            modal.addEventListener(eventName, (e) => {
                e.stopPropagation();
            }, { passive: true });
        });
    }

    if (prevArrow && !prevArrow.dataset.bound) {
        prevArrow.dataset.bound = "true";
        prevArrow.addEventListener("click", () => changeAdditionalImage(-1));
    }

    if (nextArrow && !nextArrow.dataset.bound) {
        nextArrow.dataset.bound = "true";
        nextArrow.addEventListener("click", () => changeAdditionalImage(1));
    }

    if (!additionalImagesKeydownBound) {
        additionalImagesKeydownBound = true;
        document.addEventListener("keydown", (e) => {
            if (!modal || !modal.classList.contains("active")) return;

            if (e.key === "Escape") {
                closeAdditionalImagesModal();
            } else if (e.key === "ArrowLeft") {
                changeAdditionalImage(-1);
            } else if (e.key === "ArrowRight") {
                changeAdditionalImage(1);
            }
        });
    }

    let touchStartX = 0;
    let touchEndX = 0;
    const minSwipeDistance = 40;

    if (modal && !modal.dataset.swipeBound) {
        modal.dataset.swipeBound = "true";
        modal.addEventListener("touchstart", (e) => {
            e.stopPropagation();
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        modal.addEventListener("touchend", (e) => {
            e.stopPropagation();
            touchEndX = e.changedTouches[0].screenX;
            const distance = touchEndX - touchStartX;

            if (Math.abs(distance) < minSwipeDistance) return;

            if (distance < 0) {
                changeAdditionalImage(1);
            } else {
                changeAdditionalImage(-1);
            }
        }, { passive: true });
    }
}

function updateImagenesAdicionales(game) {
    const section = document.getElementById("imagenes-section");
    const nav = document.getElementById("ficha-imagenes-nav");
    const imgEl = document.getElementById("ficha-imagenes-img");
    if (!section || !nav || !imgEl) return;

    // Coger screenshots a partir de la 3ª (índice 2 en adelante)
    const allScreenshots = game.screenshotsList || [];
    additionalImages = allScreenshots.slice(2); // Desde la 3ª en adelante
    additionalImageIndex = 0;

    // Si hay 2 o menos screenshots, no mostrar la sección
    if (additionalImages.length === 0) {
        section.style.display = "none";
        nav.style.display = "none";
        imgEl.style.display = "none";
        return;
    }

    const prevArrow = nav.querySelector(".ficha-imagenes-arrow--prev");
    const nextArrow = nav.querySelector(".ficha-imagenes-arrow--next");

    section.style.display = "block";
    nav.style.display = "flex";
    imgEl.style.display = "block";

    if (prevArrow && !prevArrow.dataset.bound) {
        prevArrow.dataset.bound = "true";
        prevArrow.addEventListener("click", () => changeAdditionalImage(-1));
    }

    if (nextArrow && !nextArrow.dataset.bound) {
        nextArrow.dataset.bound = "true";
        nextArrow.addEventListener("click", () => changeAdditionalImage(1));
    }

    if (!imgEl.dataset.bound) {
        imgEl.dataset.bound = "true";
        imgEl.addEventListener("click", openAdditionalImagesModal);
    }

    setupAdditionalImagesModalControls();
    renderAdditionalImage();
}

    function showError(message) {
        const h1 = document.getElementById("ficha-title");
        if (h1) {
            h1.textContent = message;
        }
    }

    // ============================================
    // PREFETCHING DE FICHAS ADYACENTES
    // ============================================

    function prefetchAdjacentGames() {
        // Esperar 2 segundos para que el usuario empiece a leer
        setTimeout(() => {
            const prevIndex = currentGameIndex - 1;
            const nextIndex = currentGameIndex + 1;
            
            console.log(`[Prefetch] Precargando fichas adyacentes...`);
            
            // Prefetch anterior
            if (prevIndex >= 0 && prevIndex < sortedGamesList.length) {
                const prevGame = sortedGamesList[prevIndex];
                const prevPlatform = prevGame.plataforma || CURRENT_PLATFORM;
                prefetchGameData(prevPlatform, prevGame.id);
            }
            
            // Prefetch siguiente
            if (nextIndex >= 0 && nextIndex < sortedGamesList.length) {
                const nextGame = sortedGamesList[nextIndex];
                const nextPlatform = nextGame.plataforma || CURRENT_PLATFORM;
                prefetchGameData(nextPlatform, nextGame.id);
            }
        }, PREFETCH_DELAY);
    }

    async function prefetchGameData(platform, gameId) {
        // Verificar si ya está cacheada
        const cached = getCachedFicha(platform, gameId);
        if (cached) {
            console.log(`[Prefetch] Ficha ${gameId} ya en caché ✓`);
            return;
        }
        
        try {
            // Obtener datos del CSV (que ya está cacheado)
            const cacheKey = `ficha_${platform}_${CACHE_VERSION}`;
            let games = getCachedData(cacheKey);
            
            if (!games) {
                // Si por alguna razón no está cacheado, descargarlo
                const platformConfig = PLATFORM_CONFIG[platform];
                if (!platformConfig) return;
                
                const response = await fetch(platformConfig.csvUrl);
                if (!response.ok) return;
                
                const text = await response.text();
                games = parsePS3CSV(text);
                setCachedData(cacheKey, games);
            }
            
            // Buscar el juego específico
            const game = games.find(row => row.id === gameId);
            if (game) {
                // Cachear la ficha individual
                setCachedFicha(platform, gameId, game);
                console.log(`[Prefetch] Ficha ${gameId} precargada ✓`);
            }
            
        } catch (err) {
            console.warn(`[Prefetch] Error precargando ${gameId}:`, err);
        }
    }

    // ============================================
    // NAVEGACIÓN ENTRE JUEGOS
    // ============================================

    function computeGroupLabel() {
    const filterField = (getQueryParam("filterField") || "").toLowerCase();
    const filterValue = (getQueryParam("filterValue") || "").trim();
    const searchQuery = getQueryParam("search");
    const fromColeccion = getQueryParam("from") === "coleccion";

    // Si viene de colección, mostrar etiqueta especial
    if (fromColeccion) {
        if (searchQuery) {
            const qNorm = normalizeText(searchQuery);
            const singleCharMatch = searchQuery.match(/^([a-zA-ZñÑáéíóúüÁÉÍÓÚÜ0-9])$/);
            if (singleCharMatch) {
                return `Letra ${searchQuery.toUpperCase()}`;
            }
            if (qNorm === "fav") return "Favoritos";
            if (qNorm === "terminado") return "Terminados";
            if (qNorm === "fisico") return "Formato Físico";
            return `"${searchQuery}"`;
        }
        return "Mi Colección";
    }

    if (filterField === "subgenero" && filterValue) {
        return `Subgénero ${filterValue}`;
    }

    if (filterField === "favorito" && filterValue) {
        return `Favoritos`;
    }

    if (searchQuery) {
        const singleCharMatch = searchQuery.match(/^([a-zA-ZñÑáéíóúüÁÉÍÓÚÜ0-9])$/);
        if (singleCharMatch) {
            return `Letra ${searchQuery.toUpperCase()}`;
        }
        return `"${searchQuery}"`;
    }

    return `Juegos ${CONFIG.shortName}`;
}

    function updateNavCounter() {
    const counterEl = document.querySelector(".game-nav-counter");
    const titleEl = document.querySelector(".game-nav-title");
    
    if (counterEl && currentGameIndex >= 0) {
        const position = currentGameIndex + 1;
        const total = sortedGamesList.length;
        const counterText = `${position.toLocaleString("es-ES")}/${total.toLocaleString("es-ES")}`;
        counterEl.textContent = counterText;
        sessionStorage.setItem("navCounter", counterText);
    }
    
    if (titleEl) {
        const label = currentGroupLabel || computeGroupLabel();
        titleEl.textContent = label;
    }
}

function attachVoiceStopToNavigation() {
    const navSelectors = [
        ".top-bar-back",
        ".top-bar-home",
        ".game-nav-arrow--prev",
        ".game-nav-arrow--next"
    ];

    navSelectors.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.addEventListener("click", () => stopAllVoice(), { capture: true });
        }
    });

    window.addEventListener("beforeunload", () => {
        stopAllVoice();
    });
}

       
    function setupNavigation() {
    const prevArrow = document.querySelector(".game-nav-arrow--prev");
    const nextArrow = document.querySelector(".game-nav-arrow--next");
    const counterEl = document.querySelector(".game-nav-counter");
    
    const searchQuery = getQueryParam("search");
    const filterField = getQueryParam("filterField");
    const filterValue = getQueryParam("filterValue");
    const fromColeccion = getQueryParam("from");

    if (prevArrow) {
        prevArrow.addEventListener("click", () => {
            if (currentGameIndex > 0) {
                stopAllVoice();
                const newPosition = currentGameIndex;
                const total = sortedGamesList.length;
                const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                if (counterEl) {
                    counterEl.textContent = counterText;
                }
                sessionStorage.setItem("navCounter", counterText);
                
                const prevGame = sortedGamesList[currentGameIndex - 1];
                // Determinar la plataforma del juego anterior
                const targetPlatform = prevGame.plataforma || CURRENT_PLATFORM;
                let url = `igdb-ficha.html?platform=${targetPlatform}&id=${encodeURIComponent(prevGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                if (filterField) {
                    url += `&filterField=${encodeURIComponent(filterField)}`;
                }
                if (filterValue) {
                    url += `&filterValue=${encodeURIComponent(filterValue)}`;
                }
                if (fromColeccion) {
                    url += `&from=${encodeURIComponent(fromColeccion)}`;
                }
                window.location.href = url;
            }
        });
        prevArrow.style.cursor = "pointer";
    }

    if (nextArrow) {
        nextArrow.addEventListener("click", () => {
            if (currentGameIndex < sortedGamesList.length - 1) {
                stopAllVoice();
                const newPosition = currentGameIndex + 2;
                const total = sortedGamesList.length;
                const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                if (counterEl) {
                    counterEl.textContent = counterText;
                }
                sessionStorage.setItem("navCounter", counterText);
                
                const nextGame = sortedGamesList[currentGameIndex + 1];
                // Determinar la plataforma del juego siguiente
                const targetPlatform = nextGame.plataforma || CURRENT_PLATFORM;
                let url = `igdb-ficha.html?platform=${targetPlatform}&id=${encodeURIComponent(nextGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                if (filterField) {
                    url += `&filterField=${encodeURIComponent(filterField)}`;
                }
                if (filterValue) {
                    url += `&filterValue=${encodeURIComponent(filterValue)}`;
                }
                if (fromColeccion) {
                    url += `&from=${encodeURIComponent(fromColeccion)}`;
                }
                window.location.href = url;
            }
        });
        nextArrow.style.cursor = "pointer";
    }
}

    async function loadGamesList(gameId) {
    try {
        const fromColeccion = getQueryParam("from") === "coleccion";
        const searchQuery = getQueryParam("search");
        const filterField = (getQueryParam("filterField") || "").toLowerCase();
        const filterValue = (getQueryParam("filterValue") || "").trim();

        let games;
        
        if (fromColeccion) {
            // Solo en colección necesitamos descargar CSV especial
            const cacheKey = `coleccion_${CACHE_VERSION}`;
            games = getCachedData(cacheKey);
            
            if (!games) {
                const response = await fetch(COLECCION_CSV_URL);
                if (!response.ok) throw new Error("No se pudo cargar colección");
                
                const text = await response.text();
                games = parseColeccionCSV(text);
                setCachedData(cacheKey, games);
            }
        } else {
            // Si allGamesData está vacío (caso de ficha cacheada), cargar CSV
            if (!allGamesData || allGamesData.length === 0) {
                const cacheKey = `ficha_${CURRENT_PLATFORM}_${CACHE_VERSION}`;
                allGamesData = getCachedData(cacheKey);
                
                if (!allGamesData) {
                    const response = await fetch(CONFIG.csvUrl);
                    if (!response.ok) throw new Error("No se pudo cargar el CSV");
                    
                    const text = await response.text();
                    allGamesData = parsePS3CSV(text);
                    setCachedData(cacheKey, allGamesData);
                }
            }
            
            // REUTILIZAR datos ya cargados - NO DESCARGA NADA
            games = allGamesData.map(g => ({
                id: g.id,
                titulo: g.titulo,
                displayTitulo: formatTitleWithArticle(g.titulo),
                sortKey: formatTitleWithArticle(g.titulo).toLowerCase(),
                pub: g.publisher,
                anio: g.anio,
                genero: g.genero,
                subgenero: g.subgenero,
                favorito: g.favorito,
                jugadores: g.jugadores,
                terminado: g.terminado,
                desarrollo: g.desarrollo
            }));
        }

        games.sort((a, b) => (a.sortKey || "").localeCompare(b.sortKey || "", "es-ES"));

        let filteredGames = games;
        currentGroupLabel = "";

        if (fromColeccion) {
            currentGroupLabel = "Mi Colección";

            if (searchQuery) {
                const qNorm = normalizeText(searchQuery);
                const singleCharMatch = searchQuery.match(/^([a-zñáéíóúü0-9])$/i);

                if (singleCharMatch) {
                    const char = normalizeText(singleCharMatch[1]);
                    filteredGames = games.filter(game => {
                        const titleNorm = normalizeText(game.sortKey || "");
                        return titleNorm.startsWith(char);
                    });
                    currentGroupLabel = `Letra ${searchQuery.toUpperCase()}`;
                } else if (qNorm === "fav") {
                    filteredGames = games.filter(game => normalizeText(game.favorito || "") === "si");
                    currentGroupLabel = "Favoritos";
                } else if (qNorm === "terminado") {
                    filteredGames = games.filter(game => normalizeText(game.terminado || "") === "si");
                    currentGroupLabel = "Terminados";
                } else if (qNorm === "fisico") {
                    filteredGames = games.filter(game => normalizeText(game.formato || "").includes("fisico"));
                    currentGroupLabel = "Formato Físico";
                } else {
                    const platformKeys = Object.keys(PLATFORM_CONFIG).map(k => k.toLowerCase());
                    if (platformKeys.includes(qNorm)) {
                        filteredGames = games.filter(game => 
                            normalizeText(game.plataforma || "") === qNorm
                        );
                        currentGroupLabel = qNorm.toUpperCase();
                    } else {
                        filteredGames = games.filter(game => {
                            const titleNorm = normalizeText(game.sortKey || "");
                            const plataformaNorm = normalizeText(game.plataforma || "");
                            const pubNorm = normalizeText(game.pub || "");
                            const yearNorm = normalizeText(game.anio || "");
                            const generoNorm = normalizeText(game.genero || "");
                            const subgeneroNorm = normalizeText(game.subgenero || "");
                            const desarrolloNorm = normalizeText(game.desarrollo || "");

                            return (
                                titleNorm.includes(qNorm) ||
                                plataformaNorm.includes(qNorm) ||
                                pubNorm.includes(qNorm) ||
                                yearNorm.includes(qNorm) ||
                                generoNorm.includes(qNorm) ||
                                subgeneroNorm.includes(qNorm) ||
                                desarrolloNorm.includes(qNorm)
                            );
                        });
                        currentGroupLabel = `"${searchQuery}"`;
                    }
                }
            }
        } else if (filterField === "subgenero" && filterValue) {
            const qNorm = normalizeText(filterValue);
            filteredGames = games.filter(game => normalizeText(game.subgenero || "").includes(qNorm));
            currentGroupLabel = `Subgénero ${filterValue}`;
        } else if (filterField === "favorito") {
            filteredGames = games.filter(game => normalizeText(game.favorito || "") === "si");
            currentGroupLabel = `Favoritos`;
        } else if (searchQuery) {
            const qNorm = normalizeText(searchQuery);
            const singleCharMatch = searchQuery.match(/^([a-zñáéíóúü0-9])$/i);
            
            if (singleCharMatch) {
                const char = normalizeText(singleCharMatch[1]);
                filteredGames = games.filter(game => {
                    const titleNorm = normalizeText(game.sortKey || "");
                    return titleNorm.startsWith(char);
                });
            } else if (qNorm === "fav") {
                filteredGames = games.filter(game => normalizeText(game.favorito || "") === "si");
                currentGroupLabel = `Favoritos`;
            } else {
                filteredGames = games.filter(game => {
                    const titleNorm = normalizeText(game.sortKey || "");
                    const pubNorm = normalizeText(game.pub || "");
                    const yearNorm = normalizeText(game.anio || "");
                    const generoNorm = normalizeText(game.genero || "");
                    const subgeneroNorm = normalizeText(game.subgenero || "");
                    const jugadoresNorm = normalizeText(game.jugadores || "");
                    const terminadoNorm = normalizeText(game.terminado || "");
                    const desarrolloNorm = normalizeText(game.desarrollo || "");

                    return (
                        titleNorm.includes(qNorm) ||
                        pubNorm.includes(qNorm) ||
                        yearNorm.includes(qNorm) ||
                        generoNorm.includes(qNorm) ||
                        subgeneroNorm.includes(qNorm) ||
                        jugadoresNorm.includes(qNorm) ||
                        terminadoNorm.includes(qNorm) ||
                        desarrolloNorm.includes(qNorm)
                    );
                });
                currentGroupLabel = `"${searchQuery}"`;
            }
        } else {
            currentGroupLabel = `Juegos ${CONFIG.shortName}`;
        }

        sortedGamesList = filteredGames;
        currentGameIndex = filteredGames.findIndex(g => g.id === gameId);
        updateNavCounter();
        setupNavigation();

    } catch (err) {
        console.error("Error cargando lista para navegación:", err);
    }
}

    // ============================================
    // CARGA PRINCIPAL
    // ============================================
    
    async function loadPS3Ficha() {
        const gameId = (getQueryParam("id") || "").trim();
        
        if (!gameId) {
            console.warn("No hay ID en la URL.");
            showError("ID no especificado");
            return;
        }

        try {
            // PASO 1: Intentar obtener ficha individual cacheada
            let game = getCachedFicha(CURRENT_PLATFORM, gameId);
            
            if (game) {
                console.log(`[Caché] Ficha ${gameId} cargada desde caché ⚡`);
            } else {
                // PASO 2: Si no está cacheada, buscar en CSV
                const cacheKey = `ficha_${CURRENT_PLATFORM}_${CACHE_VERSION}`;
                let games = getCachedData(cacheKey);
                
                if (!games) {
                    const response = await fetch(CONFIG.csvUrl);
                    if (!response.ok) throw new Error("No se pudo cargar el CSV");
                    
                    const text = await response.text();
                    games = parsePS3CSV(text);
                    setCachedData(cacheKey, games);
                    console.log(`[Caché] CSV ${CURRENT_PLATFORM} guardado en caché`);
                }
                
                allGamesData = games;
                game = games.find(row => row.id === gameId);
                
                // Cachear esta ficha para futuras visitas
                if (game) {
                    setCachedFicha(CURRENT_PLATFORM, gameId, game);
                }
            }
            
            if (game) {
                // Renderizar ficha actual
                updateTitle(game);
                updateCover(game);
                updatePuntuacion(game);
                updateScreenshots(game);
                updateFichaDatos(game);
                updateMasInfo(game);
                updateSinopsis(game);
                updateArgumento(game);
                updateDatosTecnicos(game);
                updateGameplay(game);
                updateImagenesAdicionales(game);
            } else {
                showError("Juego no encontrado");
            }

            // PASO 3: Cargar lista para navegación
            await loadGamesList(gameId);
            
            // PASO 4: Prefetch de fichas adyacentes (en background)
            prefetchAdjacentGames();

        } catch (err) {
            console.error(`Error cargando ${CONFIG.shortName}:`, err);
            showError("Error cargando datos");
        }
    }

    // ============================================
    // INICIALIZACIÓN
    // ============================================
    
    document.addEventListener("DOMContentLoaded", () => {
    const titleEl = document.querySelector(".game-nav-title");
    if (titleEl) {
        titleEl.textContent = computeGroupLabel();
    }

    const savedCounter = sessionStorage.getItem("navCounter");
    if (savedCounter) {
        const counterEl = document.querySelector(".game-nav-counter");
        if (counterEl) {
            counterEl.textContent = savedCounter;
        }
    }
    
    loadPS3Ficha();
    setupCoverModal();
    setupSwipeNavigation();
    attachVoiceStopToNavigation();
});

// ============================================
// MODAL CARÁTULA
// ============================================

function setupCoverModal() {
    const coverImg = document.getElementById("ficha-cover");
    const modal = document.getElementById("cover-modal");
    const modalImg = document.getElementById("cover-modal-img");
    const closeBtn = document.querySelector(".cover-modal-close");

    if (!coverImg || !modal || !modalImg || !closeBtn) return;

    coverImg.addEventListener("click", function() {
        modalImg.src = coverImg.src;
        modal.classList.add("active");
        modalAbierta = true;
    });

    closeBtn.addEventListener("click", function() {
        modal.classList.remove("active");
        modalAbierta = false;
    });

    modal.addEventListener("click", function(e) {
        if (e.target === modal) {
            modal.classList.remove("active");
            modalAbierta = false;
        }
    });
     ["touchstart", "touchmove", "touchend"].forEach(eventName => {
        modal.addEventListener(eventName, (e) => {
            e.stopPropagation();
        }, { passive: true });
    });

    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape" && modal.classList.contains("active")) {
            modal.classList.remove("active");
            modalAbierta = false;
        }
    });
}

// ============================================
// SWIPE PARA NAVEGACIÓN EN MÓVIL
// ============================================

function setupSwipeNavigation() {
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    let touchStartTime = 0;
    
    const minSwipeDistance = 100;
    const maxSwipeTime = 500;
    const maxVerticalRatio = 0.5;
    
    const searchQuery = getQueryParam("search");
    const filterField = getQueryParam("filterField");
    const filterValue = getQueryParam("filterValue");
    const fromColeccion = getQueryParam("from");

    document.addEventListener("touchstart", function(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        touchStartTime = Date.now();
    }, { passive: true });

    document.addEventListener("touchend", function(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
    }, { passive: true });

    function handleSwipe() {
        if (modalAbierta) return;
        
        const distanceX = touchEndX - touchStartX;
        const distanceY = touchEndY - touchStartY;
        const elapsedTime = Date.now() - touchStartTime;
        
        if (Math.abs(distanceX) < minSwipeDistance) return;
        if (elapsedTime > maxSwipeTime) return;
        if (Math.abs(distanceY) > Math.abs(distanceX) * maxVerticalRatio) return;

        if (distanceX < 0) {
            // Swipe izquierda -> siguiente
            if (currentGameIndex < sortedGamesList.length - 1) {
                const nextGame = sortedGamesList[currentGameIndex + 1];
                const targetPlatform = nextGame.plataforma || CURRENT_PLATFORM;
                let url = `igdb-ficha.html?platform=${targetPlatform}&id=${encodeURIComponent(nextGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                if (filterField) {
                    url += `&filterField=${encodeURIComponent(filterField)}`;
                }
                if (filterValue) {
                    url += `&filterValue=${encodeURIComponent(filterValue)}`;
                }
                if (fromColeccion) {
                    url += `&from=${encodeURIComponent(fromColeccion)}`;
                }
                stopAllVoice();
                window.location.href = url;
            }
        } else {
            // Swipe derecha -> anterior
            if (currentGameIndex > 0) {
                const prevGame = sortedGamesList[currentGameIndex - 1];
                const targetPlatform = prevGame.plataforma || CURRENT_PLATFORM;
                let url = `igdb-ficha.html?platform=${targetPlatform}&id=${encodeURIComponent(prevGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                if (filterField) {
                    url += `&filterField=${encodeURIComponent(filterField)}`;
                }
                if (filterValue) {
                    url += `&filterValue=${encodeURIComponent(filterValue)}`;
                }
                if (fromColeccion) {
                    url += `&from=${encodeURIComponent(fromColeccion)}`;
                }
                stopAllVoice();
                window.location.href = url;
            }
        }
    }
}
</script>

    <script src="assets/js/app.js"></script>

    <!-- MODAL CARÁTULA -->
<div id="cover-modal" class="cover-modal">
    <span class="cover-modal-close">&times;</span>
    <img class="cover-modal-img" id="cover-modal-img" alt="Carátula ampliada">
</div>
    
<!-- MODAL IMÁGENES ADICIONALES -->
<div id="imagenes-modal" class="imagenes-modal">
    <span class="imagenes-modal-close">&times;</span>
    <img class="imagenes-modal-img" id="imagenes-modal-img" alt="Imagen adicional ampliada">
    <img src="assets/img/ic_back.svg" class="imagenes-modal-arrow imagenes-modal-arrow--prev" alt="Anterior">
    <img src="assets/img/ic_back.svg" class="imagenes-modal-arrow imagenes-modal-arrow--next" alt="Siguiente">
</div>
</body>
</html>
