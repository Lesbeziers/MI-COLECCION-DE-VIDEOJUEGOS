<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZX Spectrum</title>
    <link rel="stylesheet" href="assets/css/global.css">
</head>

<body>

    <!-- BANDA SUPERIOR -->
    <header class="top-bar top-bar--spectrum">

        <!-- FILA 1: ATRÁS + TÍTULO + HOME -->
        <div class="top-bar-row">
            <img src="assets/img/ic_back.svg"
                 class="top-bar-back"
                 alt="Atrás"
                 onclick="history.back()">

            <h1 class="top-bar-title">ZX SPECTRUM</h1>

            <img src="assets/img/ic_home.svg"
                 class="top-bar-home"
                 alt="Home"
                 onclick="window.location.href='index.html'">
        </div>

        <!-- FILA 2: BUSCADOR -->
        <div class="spectrum-header-box">
            <div class="spectrum-search-wrapper">
                <div class="spectrum-search-box">
                    <input type="text"
                           class="spectrum-search-input"
                           placeholder="Buscar">

                    <img src="assets/img/ic_search.svg"
                         class="spectrum-search-icon"
                         alt="Buscar">
                </div>
            </div>
        </div>

        <!-- FILA 3: CONTADOR -->
        <div class="spectrum-records-block">
            <p class="spectrum-records-text">Cargando registros...</p>
        </div>

    </header>

    <!-- CONTENIDO DE LA PÁGINA ZX SPECTRUM -->
    <main class="platforms-content">

        <!-- =========================================
             LISTA ZX SPECTRUM
        ========================================== -->
        <section class="zx-list-wrapper">
            <!-- Contenedor donde se inyectarán las tarjetas vía JS -->
            <div id="zx-spectrum-list" class="zx-list-grid">
                <p class="zx-list-loading">Cargando listado de juegos...</p>
            </div>
        </section>

    </main>

    <script>
  // =========================================
  // URL DEL FEED CSV ZX_LISTA
  // =========================================
  const ZX_LISTA_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1313999074&single=true&output=csv";

  // Lista global con TODOS los juegos (para el buscador)
  let allGames = [];

  // =========================================
  // PARSER DE UNA LÍNEA CSV (RESPETA COMILLAS)
  // =========================================
  function parseCSVLine(line) {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];

      if (ch === '"') {
        // Si estamos dentro de comillas y vemos "" → comilla escapada
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++; // saltamos la segunda
        } else {
          inQuotes = !inQuotes; // abrir/cerrar bloque de comillas
        }
      } else if (ch === "," && !inQuotes) {
        // Separador de campo real
        result.push(current.trim());
        current = "";
      } else {
        current += ch;
      }
    }

    // Último campo
    result.push(current.trim());
    return result;
  }

  // =========================================
  // UTILIDAD PARA PARSEAR EL CSV COMPLETO
  // =========================================
  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (lines.length === 0) return [];

    const header = parseCSVLine(lines[0]);
    const rows = [];

    const idxID     = header.indexOf("ID");
    const idxTitulo = header.indexOf("TITULO_MOSTRAR");
    const idxPub    = header.indexOf("PUBLISHER_MOSTRAR");
    const idxAnio   = header.indexOf("AÑO_MOSTRAR");
    const idxThumb  = header.indexOf("THUMB_URL");

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i];
      if (!line.trim()) continue;

      const cols = parseCSVLine(line);

      const id    = (idxID     >= 0 && cols[idxID]     !== undefined) ? cols[idxID].trim()     : "";
      const titulo= (idxTitulo >= 0 && cols[idxTitulo] !== undefined) ? cols[idxTitulo].trim() : "";
      const pub   = (idxPub    >= 0 && cols[idxPub]    !== undefined) ? cols[idxPub].trim()    : "";
      const anio  = (idxAnio   >= 0 && cols[idxAnio]   !== undefined) ? cols[idxAnio].trim()   : "";
      const thumb = (idxThumb  >= 0 && cols[idxThumb]  !== undefined) ? cols[idxThumb].trim()  : "";

      // Si no hay título, descartamos la fila
      if (!titulo) continue;

      // Título SOLO para mostrar (con artículo al final)
      const displayTitulo = formatTitleWithArticle(titulo);

      rows.push({
        id,
        titulo,
        displayTitulo,
        pub,
        anio,
        thumb,
        sortKey: displayTitulo.toLowerCase()
      });
    }

    return rows;
  }

  // =========================================
  // FORMATEO DE TÍTULOS CON ARTÍCULO AL FINAL
  // Ej: "The Great Escape" → "Great Escape, The"
  //     "La Abadía del Crimen" → "Abadía del Crimen, La"
  // =========================================
  function formatTitleWithArticle(title) {
    if (!title) return "";
    const t = title.trim();

    // Artículos que queremos mover al final
    const re = /^(the|a|an|el|la|los|las|lo)\s+(.*)$/i;
    const match = t.match(re);

    if (!match) {
      return t;  // Sin artículo al principio → se deja igual
    }

    const article = match[1]; // “The”, “La”, etc.
    const rest    = match[2]; // El resto
    return rest + ", " + article;
  }

  // =========================================
  // NORMALIZAR TEXTO (minúsculas + sin tildes)
  // para que el buscador sea más amable
  // =========================================
  function normalizeText(str) {
    return (str || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, ""); // quita acentos
  }

  // =========================================
  // CREACIÓN DE UNA TARJETA DE JUEGO
  // =========================================
  function createGameCard(game) {
    const card = document.createElement("article");
    card.className = "zx-card";

    // --- Thumb ---
    const thumbWrapper = document.createElement("div");
    thumbWrapper.className = "zx-thumb-wrapper";

    // Normalizamos el thumb: si viene con varias URLs separadas por coma, usamos la primera
    let thumbUrl = (game.thumb || "").trim();
    if (thumbUrl.includes(",")) {
      thumbUrl = thumbUrl.split(",")[0].trim();
    }

    if (thumbUrl) {
      const img = document.createElement("img");
      img.className = "zx-thumb-img";
      img.src = thumbUrl;
      img.alt = game.titulo || "Screenshot";
      thumbWrapper.appendChild(img);
    } else {
      const placeholder = document.createElement("div");
      placeholder.className = "zx-thumb-placeholder";
      placeholder.textContent = "SIN SCREENSHOT";
      thumbWrapper.appendChild(placeholder);
    }

    // --- Meta (textos) ---
    const meta = document.createElement("div");
    meta.className = "zx-meta";

    const titleEl = document.createElement("h3");
    titleEl.className = "zx-title";
    titleEl.textContent = game.displayTitulo || game.titulo;
    meta.appendChild(titleEl);

    // Publisher en su propia línea
    if (game.pub) {
      const pubEl = document.createElement("p");
      pubEl.className = "zx-subtitle";
      pubEl.textContent = game.pub.replace(/[\"“”«»„‟]+/g, "");
      meta.appendChild(pubEl);
    }

    // Año en su propia línea
    if (game.anio) {
      const yearEl = document.createElement("p");
      yearEl.className = "zx-subtitle";
      yearEl.textContent = game.anio.replace(/[\"“”«»„‟]+/g, "");
      meta.appendChild(yearEl);
    }

    card.appendChild(thumbWrapper);
    card.appendChild(meta);

    return card;
  }

  // =========================================
  // PINTAR LISTA + ACTUALIZAR CONTADOR
  // =========================================
  function renderGames(gamesToRender, query = "") {
    const container = document.getElementById("zx-spectrum-list");
    if (!container) return;

    container.innerHTML = "";

    if (!gamesToRender.length) {
      container.innerHTML = '<p class="zx-list-loading">No se han encontrado juegos que coincidan con la búsqueda.</p>';
    } else {
      gamesToRender.forEach(game => {
        const card = createGameCard(game);
        container.appendChild(card);
      });
    }

    // Actualizar contador "X REGISTROS" o "N DE X REGISTROS"
    const recordsEl = document.querySelector(".spectrum-records-text");
    if (recordsEl) {
      const total = allGames.length;
      if (!query.trim()) {
        recordsEl.textContent = total.toLocaleString("es-ES") + " REGISTROS";
      } else {
        const current = gamesToRender.length;
        recordsEl.textContent =
          current.toLocaleString("es-ES") +
          " DE " +
          total.toLocaleString("es-ES") +
          " REGISTROS";
      }
    }
  }

  // =========================================
  // CONFIGURAR BUSCADOR
  // =========================================
  function setupSearch() {
    const searchInput = document.querySelector(".spectrum-search-input");
    if (!searchInput) return;

    searchInput.addEventListener("input", () => {
      const query = searchInput.value || "";
      const trimmed = query.trim();

      if (!trimmed) {
        // Sin texto → lista completa
        renderGames(allGames, "");
        return;
      }

      const qNorm = normalizeText(trimmed);

      const filtered = allGames.filter(game => {
        const titleNorm = normalizeText(game.displayTitulo || game.titulo);
        const pubNorm   = normalizeText(game.pub);
        const yearNorm  = normalizeText(game.anio);

        return (
          titleNorm.includes(qNorm) ||
          pubNorm.includes(qNorm) ||
          yearNorm.includes(qNorm)
        );
      });

      renderGames(filtered, query);
    });
  }

  // =========================================
  // CARGA INICIAL DE LA LISTA
  // =========================================
  async function loadZXList() {
    const container = document.getElementById("zx-spectrum-list");
    if (!container) return;

    try {
      container.innerHTML = '<p class="zx-list-loading">Cargando listado de juegos...</p>';

      const response = await fetch(ZX_LISTA_CSV_URL);
      if (!response.ok) {
        throw new Error("No se pudo cargar el CSV");
      }

      const text = await response.text();
      const games = parseCSV(text);

      // Ordenar alfabéticamente usando sortKey (ya en minúsculas)
      games.sort((a, b) => (a.sortKey || "").localeCompare(b.sortKey || "", "es-ES"));

      // Guardamos la lista completa para el buscador
      allGames = games;

      // Pintamos la lista completa (estado inicial, sin filtro)
      renderGames(allGames, "");

      // Configuramos el buscador (una sola vez)
      setupSearch();

    } catch (err) {
      console.error("Error al cargar la lista ZX:", err);
      container.innerHTML = '<p class="zx-list-loading">Error al cargar la lista de juegos.</p>';
    }
  }

  document.addEventListener("DOMContentLoaded", loadZXList);
</script>


</body>
</html>
