<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZX Spectrum ‚Äì Ficha</title>
    <link rel="stylesheet" href="assets/css/global.css">
</head>

<body class="ficha-final">

    <!-- CABECERA -->
    <header class="top-bar top-bar--spectrum">
        <div class="top-bar-inner top-bar-inner--ficha">

            <!-- Bot√≥n ATR√ÅS (izquierda) -->
            <img src="assets/img/ic_back.svg"
                 class="top-bar-back"
                 alt="Atr√°s"
                 onclick="history.back()">

            <!-- Navegaci√≥n juego a juego (centrada) -->
            <div class="game-nav-bar game-nav-bar--inline">
                <div class="game-nav-center">
                    <img src="assets/img/ic_back.svg"
                         class="game-nav-arrow game-nav-arrow--prev"
                         alt="Anterior">

                    <span class="game-nav-counter">10 / 7.800</span>

                    <img src="assets/img/ic_back.svg"
                         class="game-nav-arrow game-nav-arrow--next game-nav-arrow--next-real"
                         alt="Siguiente">
                </div>
            </div>

            <!-- Bot√≥n HOME (derecha) -->
            <img src="assets/img/ic_home.svg"
                 class="top-bar-home"
                 alt="Home"
                 onclick="window.location.href='index.html'">

        </div>
    </header>

    <!-- CONTENIDO -->
    <main class="platforms-content">
        <h1 id="ficha-title">Cargando juego...</h1>
        <div class="ficha-cover-wrapper">
            <img id="ficha-cover"
                 class="ficha-cover"
                 alt="Car√°tula del juego"
                 style="display:none;">
        </div>
        <p>Aqu√≠ montaremos la ficha completa con todos los datos.</p>
    </main>

    <!-- ===========================================
         SCRIPT DE LA FICHA ‚Äî LEE ID Y CARGA CSV
    ============================================ -->
    <script>
        /* URL del CSV de ZX_SPECTRUM */
        const ZX_SPECTRUM_CSV_URL =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1890916807&single=true&output=csv";

        /* Leer par√°metro ?id= de la URL */
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        /* Parser de una l√≠nea CSV (respeta comillas) */
        function parseCSVLine(line) {
            const result = [];
            let current = "";
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const ch = line[i];

                if (ch === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (ch === "," && !inQuotes) {
                    result.push(current.trim());
                    current = "";
                } else {
                    current += ch;
                }
            }

            result.push(current.trim());
            return result;
        }

function parseSpectrumCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (lines.length === 0) return [];

    const header = parseCSVLine(lines[0]);
    const rows = [];

    // Columnas importantes ya existentes
    const idxID          = header.indexOf("ID");
    const idxTitMostrar  = header.indexOf("TITULO_MOSTRAR");
    const idxTitConTilde = header.indexOf("T√çTULO");

    // Elegimos columna de t√≠tulo
    let idxTit = -1;
    if (idxTitMostrar >= 0) {
        idxTit = idxTitMostrar;
    } else if (idxTitConTilde >= 0) {
        idxTit = idxTitConTilde;
    } else {
        idxTit = header.indexOf("TITULO");
    }

    const idxPub  = header.indexOf("PUBLISHER_MOSTRAR");
    const idxAnio = header.indexOf("A√ëO_MOSTRAR");

    // üÜï Nuevas columnas para la car√°tula
    let idxCaratula = header.indexOf("CAR√ÅTULA");   // nombre real con tilde
    if (idxCaratula < 0) {
        // Fallback por si alg√∫n d√≠a la exportas sin tilde
        idxCaratula = header.indexOf("CARATULA");
    }

    // üÜï Columna donde guardas las im√°genes extra
    // Prioridad:
    // 1) IMAGENES
    // 2) IMAGENES_ADICIONALES
    // 3) IM√ÅGENES_ADICIONALES
    let idxImgAdic = header.indexOf("IMAGENES");
    if (idxImgAdic < 0) {
        idxImgAdic = header.indexOf("IMAGENES_ADICIONALES");
    }
    if (idxImgAdic < 0) {
        idxImgAdic = header.indexOf("IM√ÅGENES_ADICIONALES");
    }

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;

        const cols = parseCSVLine(line);

        rows.push({
            id:     idxID   >= 0 && cols[idxID]   !== undefined ? cols[idxID].trim()   : "",
            titulo: idxTit  >= 0 && cols[idxTit]  !== undefined ? cols[idxTit].trim()  : "",
            pub:    idxPub  >= 0 && cols[idxPub]  !== undefined ? cols[idxPub].trim()  : "",
            anio:   idxAnio >= 0 && cols[idxAnio] !== undefined ? cols[idxAnio].trim() : "",
            // üÜï Nuevos campos
            caratula:            idxCaratula >= 0 && cols[idxCaratula] !== undefined ? cols[idxCaratula].trim() : "",
            imagenesAdicionales: idxImgAdic  >= 0 && cols[idxImgAdic]  !== undefined ? cols[idxImgAdic].trim()  : ""
        });
    }

    return rows;
}



        /* Cargar datos y actualizar ficha */
      async function loadSpectrumFicha() {

    const gameId = (getQueryParam("id") || "").trim();
    if (!gameId) {
        console.warn("No hay ID en la URL.");
        return;
    }

    const h1Content   = document.getElementById("ficha-title");
    const coverImg    = document.getElementById("ficha-cover");

    try {
        const response = await fetch(ZX_SPECTRUM_CSV_URL);
        if (!response.ok) throw new Error("No se pudo cargar el CSV");

        const text  = await response.text();
        const games = parseSpectrumCSV(text);

        const game = games.find(row => row.id === gameId);
        alert("GAME OBJ: " + JSON.stringify(game));

        if (game) {
            // T√≠tulo del navegador (pesta√±a)
            document.title = (game.titulo || "Juego ZX Spectrum") + " ‚Äì ZX Spectrum";

            // T√≠tulo grande dentro de la ficha
            if (h1Content) {
                h1Content.textContent = game.titulo || "Juego ZX Spectrum";
            }

            // ==============================
            //   L√ìGICA DE CAR√ÅTULA
            // ==============================
            if (coverImg) {
                let coverUrl = "";

                // 1) Prioridad absoluta: columna CAR√ÅTULA (dato metido a mano)
                if (game.caratula) {
                    coverUrl = game.caratula;
                }
                // 2) Si no hay CAR√ÅTULA, intentamos sacar una buena portada
                //    desde IM√ÅGENES ADICIONALES (priorizando "Inlay Front")
                else if (game.imagenesAdicionales) {
                    const textIA = game.imagenesAdicionales;
                    const urlRegex = /https?:\/\/[^\s,]+/g;
                    const urls = [];
                    let m;

                    // Sacamos TODAS las URLs + su posici√≥n en el texto
                    while ((m = urlRegex.exec(textIA)) !== null) {
                        const urlLimpia = m[0].replace(/["',]+$/g, "");
                        urls.push({
                            url: urlLimpia,
                            index: m.index
                        });
                    }

                    if (urls.length > 0) {
                        // Por defecto, nos quedamos con la primera
                        let elegida = urls[0].url;

                        // Pero si alguna va precedida de "inlay front", la preferimos
                        for (const item of urls) {
                            const contextStart = Math.max(0, item.index - 80);
                            const context = textIA
                                .slice(contextStart, item.index)
                                .toLowerCase();

                            if (context.includes("inlay") && context.includes("front")) {
                                elegida = item.url;
                                break;
                            }
                        }

                        coverUrl = elegida;
                        alert("DEBUG COVER URL: " + coverUrl);   // ‚Üê pega esta l√≠nea
                    }
                }

                if (coverUrl) {
                    coverImg.src = coverUrl;
                    coverImg.alt = "Car√°tula de " + (game.titulo || "juego ZX Spectrum");
                    coverImg.style.display = "block";
                } else {
                    // Si no hay car√°tula, ocultamos el contenedor
                    coverImg.style.display = "none";
                }
            }


        } else {
            // Juego no encontrado
            if (h1Content) {
                h1Content.textContent = "Juego no encontrado";
            }
        }

    } catch (err) {
        console.error("Error cargando ZX_SPECTRUM:", err);
        if (h1Content) {
            h1Content.textContent = "Error cargando datos";
        }
    }
}


        document.addEventListener("DOMContentLoaded", loadSpectrumFicha);
    </script>

    <script src="assets/js/app.js"></script>

</body>
</html>
