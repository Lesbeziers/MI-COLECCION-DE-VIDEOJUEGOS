<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZX Spectrum – Ficha</title>
    <link rel="stylesheet" href="assets/css/global.css">
</head>

<body class="ficha-final">

    <!-- CABECERA -->
    <header class="top-bar top-bar--spectrum">
        <div class="top-bar-inner top-bar-inner--ficha">

            <!-- Botón ATRÁS (izquierda) -->
            <img src="assets/img/ic_back.svg"
                 class="top-bar-back"
                 alt="Atrás"
                 onclick="history.back()">

            <!-- Navegación juego a juego (centrada) -->
            <div class="game-nav-bar game-nav-bar--inline">
                <div class="game-nav-center">
                    <img src="assets/img/ic_back.svg"
                         class="game-nav-arrow game-nav-arrow--prev"
                         alt="Anterior">

                    <span class="game-nav-counter">- / -</span>

                    <img src="assets/img/ic_back.svg"
                         class="game-nav-arrow game-nav-arrow--next game-nav-arrow--next-real"
                         alt="Siguiente">
                </div>
            </div>

            <!-- Botón HOME (derecha) -->
            <img src="assets/img/ic_home.svg"
                 class="top-bar-home"
                 alt="Home"
                 onclick="window.location.href='index.html'">

        </div>
    </header>

    <!-- CONTENIDO -->
<main class="platforms-content">
    
    <!-- BLOQUE SUPERIOR: Carátula + Info básica -->
    <div class="ficha-hero">
        <div class="ficha-cover-wrapper">
            <img id="ficha-cover"
                 class="ficha-cover"
                 alt="Carátula del juego"
                 style="display:none;">
        </div>
        <div class="ficha-hero-info">
    <h1 id="ficha-title">Cargando juego...</h1>
    <p class="ficha-platform">ZX Spectrum</p>
    <p class="ficha-puntuacion" id="ficha-puntuacion"></p>
    <div class="ficha-rating">
        <span class="ficha-rating-stars" id="ficha-rating-stars">★★★★★</span>
    </div>
</div>
    </div>

    <p>Aquí montaremos la ficha completa con todos los datos.</p>
</main>

   <script>
    // ============================================
    // CONFIGURACIÓN
    // ============================================
    const ZX_SPECTRUM_CSV_URL = 
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1890916807&single=true&output=csv";

    const ZX_LISTA_CSV_URL = 
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1313999074&single=true&output=csv";

    // Lista ordenada de juegos para navegación
    let sortedGamesList = [];
    let currentGameIndex = -1;

    // ============================================
    // UTILIDADES
    // ============================================
    
    function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const ch = line[i];

            if (ch === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (ch === "," && !inQuotes) {
                result.push(current.trim());
                current = "";
            } else {
                current += ch;
            }
        }

        result.push(current.trim());
        return result;
    }

    function findColumnIndex(header, names) {
        for (const name of names) {
            const idx = header.indexOf(name);
            if (idx >= 0) return idx;
        }
        return -1;
    }

    function getColumnValue(cols, idx) {
        return idx >= 0 && cols[idx] !== undefined ? cols[idx].trim() : "";
    }

    function formatTitleWithArticle(title) {
        if (!title) return "";
        const t = title.trim();
        const re = /^(the|a|an|el|la|los|las|lo)\s+(.*)$/i;
        const match = t.match(re);
        if (!match) return t;
        return match[2] + ", " + match[1];
    }

    // ============================================
    // PARSER CSV - FICHA (datos completos)
    // ============================================
    
    function parseSpectrumCSV(text) {
        const lines = text.trim().split(/\r?\n/);
        if (lines.length === 0) return [];

        const header = parseCSVLine(lines[0]);
        const rows = [];

        const idxID = header.indexOf("ID");
        const idxTit = findColumnIndex(header, ["TITULO_MOSTRAR", "TÍTULO", "TITULO"]);
        const idxPub = header.indexOf("PUBLISHER_MOSTRAR");
        const idxAnio = header.indexOf("AÑO_MOSTRAR");
        const idxCaratula = findColumnIndex(header, ["CARÁTULA", "CARATULA"]);
        const idxImgAdic = findColumnIndex(header, [
            "IMÁGENES", 
            "IMAGENES", 
            "IMAGENES_ADICIONALES", 
            "IMÁGENES_ADICIONALES"
        ]);
        const idxPuntuacion = findColumnIndex(header, ["PUNTUACIÓN", "PUNTUACION"]);

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if (!line.trim()) continue;

            const cols = parseCSVLine(line);

            rows.push({
    id: getColumnValue(cols, idxID),
    titulo: getColumnValue(cols, idxTit),
    pub: getColumnValue(cols, idxPub),
    anio: getColumnValue(cols, idxAnio),
    caratula: getColumnValue(cols, idxCaratula),
    imagenesAdicionales: getColumnValue(cols, idxImgAdic),
    puntuacion: getColumnValue(cols, idxPuntuacion)
});
        }

        return rows;
    }

    // ============================================
    // PARSER CSV - LISTA (para navegación)
    // ============================================
    
    function parseListaCSV(text) {
        const lines = text.trim().split(/\r?\n/);
        if (lines.length === 0) return [];

        const header = parseCSVLine(lines[0]);
        const rows = [];

        const idxID = header.indexOf("ID");
        const idxTitulo = header.indexOf("TITULO_MOSTRAR");

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if (!line.trim()) continue;

            const cols = parseCSVLine(line);
            const id = getColumnValue(cols, idxID);
            const titulo = getColumnValue(cols, idxTitulo);

            if (!titulo) continue;

            const displayTitulo = formatTitleWithArticle(titulo);

            rows.push({
                id,
                titulo,
                displayTitulo,
                sortKey: displayTitulo.toLowerCase()
            });
        }

        return rows;
    }

    // ============================================
    // EXTRACCIÓN DE CARÁTULA
    // ============================================
    
    function extractURLs(text) {
        const urlRegex = /https?:\/\/[^\s,]+/g;
        const urls = [];
        let match;

        while ((match = urlRegex.exec(text)) !== null) {
            const cleanUrl = match[0].replace(/["',]+$/g, "");
            urls.push({
                url: cleanUrl,
                index: match.index
            });
        }

        return urls;
    }

    function findBestCover(imagenesText) {
        const urls = extractURLs(imagenesText);
        if (urls.length === 0) return "";

        let bestUrl = urls[0].url;

        for (const item of urls) {
            const contextStart = Math.max(0, item.index - 80);
            const context = imagenesText
                .slice(contextStart, item.index)
                .toLowerCase();

            if (context.includes("inlay") && context.includes("front")) {
                bestUrl = item.url;
                break;
            }
        }

        return bestUrl;
    }

    function getCoverURL(game) {
        if (game.caratula) {
            return game.caratula;
        }

        if (game.imagenesAdicionales) {
            return findBestCover(game.imagenesAdicionales);
        }

        return "";
    }

    // ============================================
    // ACTUALIZACIÓN DE UI
    // ============================================
    
    function updateTitle(game) {
        const title = game.titulo || "Juego ZX Spectrum";
        document.title = `${title} – ZX Spectrum`;
        
        const h1 = document.getElementById("ficha-title");
        if (h1) {
            h1.textContent = title;
        }
    }

    function updateCover(game) {
        const coverImg = document.getElementById("ficha-cover");
        if (!coverImg) return;

        const coverUrl = getCoverURL(game);

        if (coverUrl) {
            coverImg.src = coverUrl;
            coverImg.alt = `Carátula de ${game.titulo || "juego ZX Spectrum"}`;
            coverImg.style.display = "block";
        } else {
            coverImg.style.display = "none";
        }
    }

    function updatePuntuacion(game) {
    const puntuacionEl = document.getElementById("ficha-puntuacion");
    if (!puntuacionEl) return;
    console.log("Puntuación del juego:", game.puntuacion);
    if (game.puntuacion && game.puntuacion.trim()) {
        puntuacionEl.innerHTML = `· <b>Puntuación:</b> ${game.puntuacion}`;
    } else {
        puntuacionEl.innerHTML = "";
    }
}   

    function showError(message) {
        const h1 = document.getElementById("ficha-title");
        if (h1) {
            h1.textContent = message;
        }
    }

    // ============================================
    // NAVEGACIÓN ENTRE JUEGOS
    // ============================================

    function updateNavCounter() {
        const counterEl = document.querySelector(".game-nav-counter");
        if (counterEl && currentGameIndex >= 0) {
            const position = currentGameIndex + 1;
            const total = sortedGamesList.length;
            const counterText = `${position.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
            counterEl.textContent = counterText;
            // Guardar en sessionStorage para la próxima carga
            sessionStorage.setItem("navCounter", counterText);
        }
    }

    function setupNavigation() {
        const prevArrow = document.querySelector(".game-nav-arrow--prev");
        const nextArrow = document.querySelector(".game-nav-arrow--next");
        const counterEl = document.querySelector(".game-nav-counter");

        if (prevArrow) {
            prevArrow.addEventListener("click", () => {
                if (currentGameIndex > 0) {
                    // Actualizar contador inmediatamente y guardarlo
                    const newPosition = currentGameIndex;
                    const total = sortedGamesList.length;
                    const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                    if (counterEl) {
                        counterEl.textContent = counterText;
                    }
                    sessionStorage.setItem("navCounter", counterText);
                    
                    const prevGame = sortedGamesList[currentGameIndex - 1];
                    window.location.href = `spectrum-ficha.html?id=${encodeURIComponent(prevGame.id)}`;
                }
            });
            prevArrow.style.cursor = "pointer";
        }

        if (nextArrow) {
            nextArrow.addEventListener("click", () => {
                if (currentGameIndex < sortedGamesList.length - 1) {
                    // Actualizar contador inmediatamente y guardarlo
                    const newPosition = currentGameIndex + 2;
                    const total = sortedGamesList.length;
                    const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                    if (counterEl) {
                        counterEl.textContent = counterText;
                    }
                    sessionStorage.setItem("navCounter", counterText);
                    
                    const nextGame = sortedGamesList[currentGameIndex + 1];
                    window.location.href = `spectrum-ficha.html?id=${encodeURIComponent(nextGame.id)}`;
                }
            });
            nextArrow.style.cursor = "pointer";
        }
    }

    async function loadGamesList(gameId) {
        try {
            const response = await fetch(ZX_LISTA_CSV_URL);
            if (!response.ok) {
                throw new Error("No se pudo cargar la lista");
            }

            const text = await response.text();
            const games = parseListaCSV(text);

            // Ordenar alfabéticamente
            games.sort((a, b) => (a.sortKey || "").localeCompare(b.sortKey || "", "es-ES"));

            sortedGamesList = games;

            // Encontrar posición del juego actual
            currentGameIndex = games.findIndex(g => g.id === gameId);

            // Actualizar contador
            updateNavCounter();

            // Configurar flechas
            setupNavigation();

        } catch (err) {
            console.error("Error cargando lista para navegación:", err);
        }
    }

    // ============================================
    // CARGA PRINCIPAL
    // ============================================
    
    async function loadSpectrumFicha() {
        const gameId = (getQueryParam("id") || "").trim();
        
        if (!gameId) {
            console.warn("No hay ID en la URL.");
            showError("ID no especificado");
            return;
        }

        try {
            // Cargar datos del juego
            const response = await fetch(ZX_SPECTRUM_CSV_URL);
            if (!response.ok) {
                throw new Error("No se pudo cargar el CSV");
            }

            const text = await response.text();
            const games = parseSpectrumCSV(text);
            const game = games.find(row => row.id === gameId);

            if (game) {
                updateTitle(game);
                updateCover(game);
                updatePuntuacion(game);
            } else {
                showError("Juego no encontrado");
            }

            // Cargar lista para navegación
            await loadGamesList(gameId);

        } catch (err) {
            console.error("Error cargando ZX_SPECTRUM:", err);
            showError("Error cargando datos");
        }
    }

    // ============================================
    // INICIALIZACIÓN
    // ============================================
    
    document.addEventListener("DOMContentLoaded", () => {
        // Recuperar contador guardado mientras carga
        const savedCounter = sessionStorage.getItem("navCounter");
        if (savedCounter) {
            const counterEl = document.querySelector(".game-nav-counter");
            if (counterEl) {
                counterEl.textContent = savedCounter;
            }
        }
        
        loadSpectrumFicha();
    });
</script>

    <script src="assets/js/app.js"></script>

</body>
</html>
