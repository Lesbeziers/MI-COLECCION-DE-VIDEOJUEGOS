<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZX Spectrum – Ficha</title>
    <link rel="stylesheet" href="assets/css/global.css">
</head>

<body class="ficha-final loading">

    <!-- CABECERA -->
    <header class="top-bar top-bar--spectrum">
        <div class="top-bar-inner top-bar-inner--ficha">

<img src="assets/img/ic_back.svg"
     class="top-bar-back"
     alt="Atrás"
     onclick="window.location.href='spectrum-lista.html'">

           <!-- Navegación juego a juego (centrada) -->
<div class="game-nav-bar game-nav-bar--inline">
    <div class="game-nav-center">
        <img src="assets/img/ic_back.svg"
             class="game-nav-arrow game-nav-arrow--prev"
             alt="Anterior">

        <span class="game-nav-title"></span>

        <img src="assets/img/ic_back.svg"
             class="game-nav-arrow game-nav-arrow--next game-nav-arrow--next-real"
             alt="Siguiente">
    </div>
    <div class="game-nav-counter-line">
        <span class="game-nav-counter">- / -</span>
    </div>
</div>

            <!-- Botón HOME (derecha) -->
            <img src="assets/img/ic_home.svg"
                 class="top-bar-home"
                 alt="Home"
                 onclick="window.location.href='index.html'">

        </div>
    </header>

    <!-- CONTENIDO -->
<main class="platforms-content">
    
<!-- BLOQUE SUPERIOR: Carátula + Info básica -->
<div class="ficha-hero">
    <div class="ficha-cover-wrapper">
        <img id="ficha-cover"
             class="ficha-cover"
             alt="Carátula del juego"
             style="display:none;">
    </div>
    <div class="ficha-hero-info">
        <h1 id="ficha-title" class="loading-title">Cargando ficha...</h1>

        <!-- Estos empiezan ocultos -->
        <p class="ficha-platform" style="display:none;">ZX Spectrum</p>
        <p class="ficha-puntuacion" id="ficha-puntuacion" style="display:none;"></p>

        <div class="ficha-rating" style="display:none;">
            <span class="ficha-rating-stars" id="ficha-rating-stars">★★★★★</span>
        </div>
    </div>
</div>

<!-- SCREENSHOTS -->
<div class="ficha-screenshots" style="display:none;">
    <div class="screenshot-wrapper">
        <img id="screenshot-1" class="screenshot-img" alt="Screenshot 1" style="display:none;">
    </div>
    <div class="screenshot-wrapper">
        <img id="screenshot-2" class="screenshot-img" alt="Screenshot 2" style="display:none;">
    </div>
</div>

<!-- SECCIÓN FICHA -->
<div class="ficha-section">
    <h2 class="ficha-section-title">FICHA</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-datos" id="ficha-datos" style="display:none;">
        <!-- Los datos se rellenan por JS -->
    </div>
</div>

<!-- SECCIÓN SINOPSIS -->
<div class="ficha-section" id="sinopsis-section" style="display:none;">
    <h2 class="ficha-section-title">SINOPSIS</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-sinopsis" id="ficha-sinopsis">
        <!-- El texto se rellena por JS -->
    </div>
</div>

<!-- SECCIÓN DATOS TÉCNICOS -->
<div class="ficha-section" id="datos-tecnicos-section" style="display:none;">
    <h2 class="ficha-section-title">DATOS TÉCNICOS</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-datos ficha-datos-tecnicos" id="ficha-datos-tecnicos">
        <!-- Los datos se rellenan por JS -->
    </div>
</div>

   <!-- SECCIÓN GAMEPLAY -->
<div class="ficha-section" id="gameplay-section" style="display:none;">
    <h2 class="ficha-section-title">GAMEPLAY</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-gameplay" id="ficha-gameplay">
        <div class="ficha-gameplay-frame" id="ficha-gameplay-frame">
            <div class="ficha-gameplay-placeholder" id="ficha-gameplay-placeholder">
                <div class="ficha-gameplay-play"></div>
            </div>
        </div>
    </div>
</div>
 
    <!-- SECCIÓN IMÁGENES ADICIONALES -->
<div class="ficha-section" id="imagenes-section" style="display:none;">
    <h2 class="ficha-section-title">IMÁGENES</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-imagenes" id="ficha-imagenes">
        <div class="ficha-imagenes-frame" id="ficha-imagenes-frame">
            <img id="ficha-imagenes-img" class="ficha-imagenes-img" alt="Imagen adicional" style="display:none;">
        </div>
        <div class="ficha-imagenes-nav" id="ficha-imagenes-nav" style="display:none;">
            <img src="assets/img/ic_back.svg" class="ficha-imagenes-arrow ficha-imagenes-arrow--prev" alt="Anterior">
            <span class="ficha-imagenes-counter">
                <span id="imagenes-current">1</span> / <span id="imagenes-total">1</span>
            </span>
            <img src="assets/img/ic_back.svg" class="ficha-imagenes-arrow ficha-imagenes-arrow--next" alt="Siguiente">
        </div>
    </div>
</div>

<!-- SECCIÓN REVISTAS -->
<div class="ficha-section" id="revistas-section" style="display:none;">
    <h2 class="ficha-section-title">REVISTAS</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-revistas" id="ficha-revistas"></div>
</div>


    
</main>

   <script>
    // ============================================
    // CONFIGURACIÓN
    // ============================================
    const ZX_SPECTRUM_CSV_URL = 
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1890916807&single=true&output=csv";

    const ZX_LISTA_CSV_URL = 
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1313999074&single=true&output=csv";

    // Lista ordenada de juegos para navegación
    let sortedGamesList = [];
    let currentGameIndex = -1;
       
    // Imágenes adicionales
    let additionalImages = [];
    let additionalImageIndex = 0;
    let additionalImagesKeydownBound = false;

    // ============================================
    // UTILIDADES
    // ============================================
    
    function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const ch = line[i];

            if (ch === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (ch === "," && !inQuotes) {
                result.push(current.trim());
                current = "";
            } else {
                current += ch;
            }
        }

        result.push(current.trim());
        return result;
    }

    function findColumnIndex(header, names) {
        for (const name of names) {
            const idx = header.indexOf(name);
            if (idx >= 0) return idx;
        }
        return -1;
    }

    function getColumnValue(cols, idx) {
        return idx >= 0 && cols[idx] !== undefined ? cols[idx].trim() : "";
    }

    function formatTitleWithArticle(title) {
        if (!title) return "";
        const t = title.trim();
        const re = /^(the|a|an|el|la|los|las|lo)\s+(.*)$/i;
        const match = t.match(re);
        if (!match) return t;
        return match[2] + ", " + match[1];
    }

    function normalizeText(str) {
    return (str || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
}

// ============================================
// PARSER CSV GENERAL (soporta saltos de línea dentro de comillas)
// ============================================
function parseCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentField = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const ch = text[i];

        if (ch === '"') {
            if (inQuotes && text[i + 1] === '"') {
                // Doble comilla dentro de campo: se convierte en una comilla
                currentField += '"';
                i++;
            } else {
                // Entramos o salimos de comillas
                inQuotes = !inQuotes;
            }
        } else if (ch === "," && !inQuotes) {
            // Fin de campo
            currentRow.push(currentField.trim());
            currentField = "";
        } else if ((ch === "\n" || ch === "\r") && !inQuotes) {
            // Fin de fila (solo si no estamos dentro de comillas)
            // Manejo de \r\n
            if (ch === "\r" && text[i + 1] === "\n") {
                i++;
            }
            currentRow.push(currentField.trim());
            // Evitar filas totalmente vacías
            if (currentRow.some(v => v !== "")) {
                rows.push(currentRow);
            }
            currentRow = [];
            currentField = "";
        } else {
            currentField += ch;
        }
    }

    // Último campo/fila si no termina en salto de línea
    if (currentField.length > 0 || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.some(v => v !== "")) {
            rows.push(currentRow);
        }
    }

    return rows;
}

       function parseAdditionalImagesList(text) {
    return (text || "")
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(line => line !== "");
}

function parseRevistasList(text) {
    return (text || "")
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(line => line !== "")
        .map(line => {
            const markdownMatch = line.match(/^\s*\[([^\]]+)\]\(([^)]+)\)\s*$/);
            if (markdownMatch) {
                return {
                    texto: markdownMatch[1].trim(),
                    url: markdownMatch[2].trim()
                };
            }

            return {
                texto: line,
                url: ""
            };
        })
        .filter(entry => entry.texto);
}

       
// ============================================
// PARSER CSV - FICHA (datos completos) con soporte de filas partidas
// ============================================
function parseSpectrumCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];

    const header = parseCSVLine(lines[0]);
    console.log("Columnas del CSV:", header);
    const expectedCols = header.length;
    const rows = [];

    const idxID = header.indexOf("ID");
    const idxTit = findColumnIndex(header, ["TITULO_MOSTRAR", "TÍTULO", "TITULO"]);
    const idxPub = header.indexOf("PUBLISHER_MOSTRAR");
    const idxAnio = header.indexOf("AÑO_MOSTRAR");
    const idxCaratula = findColumnIndex(header, ["CARÁTULA", "CARATULA"]);
    const idxImgAdic = findColumnIndex(header, [
        "IMÁGENES",
        "IMAGENES",
        "IMAGENES_ADICIONALES",
        "IMÁGENES_ADICIONALES"
    ]);
    const idxPuntuacion = findColumnIndex(header, ["PUNTUACIÓN", "PUNTUACION"]);
    const idxScreenshots = findColumnIndex(header, ["SCREENSHOTS"]);
    
    // Nuevos campos para la sección FICHA
    const idxAnioFicha = findColumnIndex(header, ["AÑO"]);
    const idxEditor = findColumnIndex(header, ["PUBLISHER"]);
    const idxDesarrollo = findColumnIndex(header, ["DESARROLLADOR"]);
    const idxAutor = findColumnIndex(header, ["AUTOR"]);
    const idxContribuciones = findColumnIndex(header, ["CONTRIBUCIONES"]);
    const idxGenero = findColumnIndex(header, ["GÉNERO", "GENERO"]);
    const idxSubgenero = findColumnIndex(header, ["SUBGÉNERO", "SUBGENERO"]);
    const idxDistribuidoras = findColumnIndex(header, ["DISTRIBUIDORAS"]);
    const idxSinopsis = findColumnIndex(header, ["SINOPSIS"]);
    const idxJugadores = findColumnIndex(header, ["JUGADORES"]);
    const idxControles = findColumnIndex(header, ["CONTROLES"]);
    const idxVersion = findColumnIndex(header, ["VERSIÓN", "VERSION"]);
    const idxFormato = findColumnIndex(header, ["FORMATO"]);
    const idxZx2a = findColumnIndex(header, ["ZX +2A", "ZX+2A"]);
    const idxTspec = findColumnIndex(header, ["TSPEC"]);
    const idxTerminado = findColumnIndex(header, ["TERMINADO"]);
    const idxVideo = findColumnIndex(header, ["VIDEO"]);
    const idxRevistas = findColumnIndex(header, ["REVISTAS"]);

    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;

        let rawLine = lines[i];
        let cols = parseCSVLine(rawLine);

        // Si la fila viene "rota" en varias líneas (REVISTAS, SINOPSIS, etc.),
        // vamos pegando líneas hasta tener el número correcto de columnas
        while (cols.length < expectedCols && i + 1 < lines.length) {
            rawLine += "\n" + lines[i + 1];
            i++;
            cols = parseCSVLine(rawLine);
        }

        const thisId = getColumnValue(cols, idxID);
        const rawAdditionalImages = getColumnValue(cols, idxImgAdic);
        const additionalImagesList = parseAdditionalImagesList(rawAdditionalImages);

        rows.push({
            id: thisId,
            titulo: getColumnValue(cols, idxTit),
            pub: getColumnValue(cols, idxPub),
            anio: getColumnValue(cols, idxAnio),
            caratula: getColumnValue(cols, idxCaratula),
            imagenesAdicionales: getColumnValue(cols, idxImgAdic),
            imagenesAdicionales: rawAdditionalImages,
            imagenesArray: additionalImagesList,
            puntuacion: getColumnValue(cols, idxPuntuacion),
            screenshots: getColumnValue(cols, idxScreenshots),
            // Campos Ficha
            anioFicha: getColumnValue(cols, idxAnioFicha),
            editor: getColumnValue(cols, idxEditor),
            desarrollo: getColumnValue(cols, idxDesarrollo),
            autor: getColumnValue(cols, idxAutor),
            contribuciones: getColumnValue(cols, idxContribuciones),
            genero: getColumnValue(cols, idxGenero),
            subgenero: getColumnValue(cols, idxSubgenero),
            distribuidoras: getColumnValue(cols, idxDistribuidoras),
            // Campo Sinopsis
            sinopsis: getColumnValue(cols, idxSinopsis),
            // Campos Datos Técnicos
            jugadores: getColumnValue(cols, idxJugadores),
            controles: getColumnValue(cols, idxControles),
            version: getColumnValue(cols, idxVersion),
            formato: getColumnValue(cols, idxFormato),
            zx2a: getColumnValue(cols, idxZx2a),
            tspec: getColumnValue(cols, idxTspec),
            terminado: getColumnValue(cols, idxTerminado),
            videoUrl: getColumnValue(cols, idxVideo),
            revistasTexto: getColumnValue(cols, idxRevistas),
            revistas: parseRevistasList(getColumnValue(cols, idxRevistas))
        });
    }

    return rows;
}

    // ============================================
    // PARSER CSV - LISTA (para navegación)
    // ============================================
    // ============================================
// PARSER CSV - LISTA (para navegación)
// ============================================
function parseListaCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];

    const header = parseCSVLine(lines[0]);
    const rows = [];

    const idxID     = header.indexOf("ID");
    const idxTitulo = header.indexOf("TITULO_MOSTRAR");
    const idxPub    = header.indexOf("PUBLISHER_MOSTRAR");
    const idxAnio   = header.indexOf("AÑO_MOSTRAR");
    const idxAutor  = header.indexOf("AUTOR_MOSTRAR");
    const idxDes    = header.indexOf("DESARROLLO");
    const idxContr  = header.indexOf("CONTRIBUCIONES");
    const idxGenero = header.indexOf("GENERO_MOSTRAR");

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;

        const cols = parseCSVLine(line);
        const id     = getColumnValue(cols, idxID);
        const titulo = getColumnValue(cols, idxTitulo);

        if (!titulo) continue;

        const displayTitulo = formatTitleWithArticle(titulo);

        rows.push({
            id,
            titulo,
            displayTitulo,
            sortKey: displayTitulo.toLowerCase(),
            pub:    getColumnValue(cols, idxPub),
            anio:   getColumnValue(cols, idxAnio),
            autor:  getColumnValue(cols, idxAutor),
            des:    getColumnValue(cols, idxDes),
            contr:  getColumnValue(cols, idxContr),
            genero: getColumnValue(cols, idxGenero)
        });
    }

    return rows;
}



    // ============================================
    // EXTRACCIÓN DE CARÁTULA
    // ============================================
    
    function extractURLs(text) {
        const urlRegex = /https?:\/\/[^\s,]+/g;
        const urls = [];
        let match;

        while ((match = urlRegex.exec(text)) !== null) {
            const cleanUrl = match[0].replace(/["',]+$/g, "");
            urls.push({
                url: cleanUrl,
                index: match.index
            });
        }

        return urls;
    }

    function findBestCover(imagenesText) {
        const urls = extractURLs(imagenesText);
        if (urls.length === 0) return "";

        let bestUrl = urls[0].url;

        for (const item of urls) {
            const contextStart = Math.max(0, item.index - 80);
            const context = imagenesText
                .slice(contextStart, item.index)
                .toLowerCase();

            if (context.includes("inlay") && context.includes("front")) {
                bestUrl = item.url;
                break;
            }
        }

        return bestUrl;
    }

    function getCoverURL(game) {
        if (game.caratula) {
            return game.caratula;
        }

        if (game.imagenesAdicionales) {
            return findBestCover(game.imagenesAdicionales);
        }

        return "";
    }

       function getYouTubeThumbnail(embedUrl) {
        if (!embedUrl) return "";
        const match = embedUrl.match(/embed\/([^?&#\/]+)/);
        if (match && match[1]) {
            return `https://img.youtube.com/vi/${match[1]}/hqdefault.jpg`;
        }
        return "";
    }


    // ============================================
    // ACTUALIZACIÓN DE UI
    // ============================================
    
function updateTitle(game) {
    const title = game.titulo || "Juego ZX Spectrum";
    document.title = `${title} – ZX Spectrum`;

    const h1 = document.getElementById("ficha-title");
    if (h1) {
        h1.textContent = title;
        h1.classList.remove("loading-title");
    }

    const platformEl = document.querySelector(".ficha-platform");
    if (platformEl) {
        platformEl.style.display = "block";
    }

    // Mostrar sección FICHA
    const fichaSection = document.querySelector(".ficha-section");
    if (fichaSection) {
        fichaSection.style.display = "block";
    }

    document.body.classList.remove("loading");
}

 function updateCover(game) {
    const coverImg = document.getElementById("ficha-cover");
    const wrapper = document.querySelector(".ficha-cover-wrapper");
    if (!coverImg || !wrapper) return;

    const coverUrl = getCoverURL(game);

    if (coverUrl) {
        coverImg.onload = function() {
            const naturalW = coverImg.naturalWidth;
            const naturalH = coverImg.naturalHeight;
            const aspectRatio = naturalW / naturalH;
            
            // Obtener tamaño REAL del wrapper (funciona en móvil y PC)
            const wrapperWidth = wrapper.offsetWidth;
            const wrapperHeight = wrapper.offsetHeight;
            const targetRatio = wrapperWidth / wrapperHeight;
            
            // Calcular qué ancho tendría al escalar al alto del wrapper
            const scaledWidth = wrapperHeight * aspectRatio;

            // ====================================
            // VALOR AJUSTABLE: compresión horizontal
            // 1.0 = sin comprimir, 0.9 = 90% del ancho, 0.85 = 85%, etc.
            // ====================================
            const squeezeRatio = 0.97;

            if (scaledWidth < wrapperWidth) {
                // Imagen MUY ESTRECHA → estirar para rellenar
                coverImg.style.width = "100%";
                coverImg.style.height = "100%";
                coverImg.style.objectFit = "fill";
                coverImg.style.left = "0";
                coverImg.style.right = "auto";
                coverImg.style.transform = "none";
            } else if (aspectRatio > targetRatio) {
                // Imagen CUADRADA u HORIZONTAL → comprimir horizontalmente
                const compressedWidth = scaledWidth * squeezeRatio;
                coverImg.style.width = compressedWidth + "px";
                coverImg.style.height = "100%";
                coverImg.style.objectFit = "fill";
                coverImg.style.left = "auto";
                coverImg.style.right = "0";
                coverImg.style.transform = "none";
            } else {
                // Proporción CORRECTA → sin tocar
                coverImg.style.width = "auto";
                coverImg.style.height = "100%";
                coverImg.style.objectFit = "cover";
                coverImg.style.left = "auto";
                coverImg.style.right = "0";
                coverImg.style.transform = "none";
            }
            wrapper.classList.add("loaded");
        };

        coverImg.src = coverUrl;
        coverImg.alt = `Carátula de ${game.titulo || "juego ZX Spectrum"}`;
        coverImg.style.display = "block";
    } else {
        coverImg.style.display = "none";
    }
}

function updatePuntuacion(game) {
    const puntuacionEl = document.getElementById("ficha-puntuacion");
    const ratingEl = document.querySelector(".ficha-rating");
    const starsEl = document.getElementById("ficha-rating-stars");
    if (!puntuacionEl || !ratingEl || !starsEl) return;

    const valor = (game.puntuacion || "").trim();
    console.log("Puntuación del juego:", valor);

    if (valor) {
        // 1) Texto debajo de ZX Spectrum
        puntuacionEl.innerHTML = `<b>Puntuación:</b> ${valor}`;
        puntuacionEl.style.display = "block";
        ratingEl.style.display = "flex";

        // 2) Sacar la nota ("5,8" de "5,8 (5 votos)")
        const match = valor.match(/^(\d+[.,]?\d*)/);
        let nota = 0;
        if (match) {
            nota = parseFloat(match[1].replace(",", "."));
        }

        // 3) Clamp 0–10
        if (isNaN(nota)) nota = 0;
        if (nota < 0) nota = 0;
        if (nota > 10) nota = 10;

        // 4) Pasar a porcentaje 0–100
        const porcentaje = (nota / 10) * 100;
        console.log("Nota numérica:", nota, "→ porcentaje barra:", porcentaje);

        // 5) Elegir color
        let color = "#ff4b4b"; // rojo
        if (nota >= 7) {
            color = "#00c853"; // verde
        } else if (nota >= 5) {
            color = "#ffd600"; // amarillo
        }

        // 6) Aplicar variables CSS al span con animación garantizada

// Primero reseteamos a 0% para que siempre haya "viaje"
starsEl.style.setProperty("--fill", "0%");
starsEl.style.setProperty("--rating-color", color);

// Forzamos reflow para que el navegador pinte el 0%
void starsEl.offsetWidth;

// Ahora sí, llevamos el relleno al porcentaje final (se anima)
starsEl.style.setProperty("--fill", porcentaje + "%");


    } else {
        // Sin puntuación → ocultar
        puntuacionEl.innerHTML = "";
        puntuacionEl.style.display = "none";
        ratingEl.style.display = "none";

        starsEl.style.setProperty("--fill", "0%");
    }
}

// ============================================
// SCREENSHOTS
// ============================================

function updateScreenshots(game) {
    const screenshot1 = document.getElementById("screenshot-1");
    const screenshot2 = document.getElementById("screenshot-2");
    const wrapper1 = screenshot1?.parentElement;
    const wrapper2 = screenshot2?.parentElement;
    const container = document.querySelector(".ficha-screenshots");

    if (!screenshot1 || !screenshot2 || !container) return;

    // Parsear URLs separadas por ", "
    const screenshotsRaw = (game.screenshots || "").trim();
    const urls = screenshotsRaw ? screenshotsRaw.split(", ").map(u => u.trim()).filter(u => u) : [];

    // Si hay al menos una URL, mostrar el contenedor
    if (urls.length > 0) {
        container.style.display = "flex";
    } else {
        container.style.display = "none";
        return;
    }

    // Screenshot 1
    if (urls[0]) {
        screenshot1.src = urls[0];
        screenshot1.style.display = "block";
        screenshot1.onclick = () => openModal(urls[0]);
        wrapper1.classList.remove("empty");
    } else {
        screenshot1.style.display = "none";
        wrapper1.classList.add("empty");
    }

    // Screenshot 2
    if (urls[1]) {
        screenshot2.src = urls[1];
        screenshot2.style.display = "block";
        screenshot2.onclick = () => openModal(urls[1]);
        wrapper2.classList.remove("empty");
    } else {
        screenshot2.style.display = "none";
        wrapper2.classList.add("empty");
    }
}

function openModal(src) {
    const modal = document.getElementById("cover-modal");
    const modalImg = document.getElementById("cover-modal-img");
    if (modal && modalImg) {
        modalImg.src = src;
        modal.classList.add("active");
    }
}

// ============================================
// DATOS DE LA FICHA
// ============================================
function updateFichaDatos(game) {
    const container = document.getElementById("ficha-datos");
    if (!container) return;

    // Definir los campos a mostrar (etiqueta, valor)
    const campos = [
        { label: "· AÑO", value: game.anioFicha },
        { label: "· EDITOR", value: game.editor },
        { label: "· DESARROLLO", value: game.desarrollo },
        { label: "· AUTOR", value: game.autor },
        { label: "· CONTRIBUCIONES", value: game.contribuciones },
        { label: "· GÉNERO", value: game.genero },
        { label: "· SUBGÉNERO", value: game.subgenero },
        { label: "· DISTRIBUIDORAS", value: game.distribuidoras }
    ];

    // Filtrar solo los que tienen valor
    const camposConValor = campos.filter(c => c.value && c.value.trim() !== "");

    if (camposConValor.length === 0) {
        container.style.display = "none";
        return;
    }

    // Generar HTML
    let html = "";
    camposConValor.forEach(campo => {
        html += `<p class="ficha-dato"><span class="ficha-dato-label">${campo.label}:</span> ${campo.value}</p>`;
    });

    container.innerHTML = html;
    container.style.display = "block";
}

// ============================================
// SINOPSIS
// ============================================
let sinopsisVoiceButton = null;
let sinopsisVoiceOnIcon = null;
let sinopsisVoiceOffIcon = null;
let currentUtterance = null;
let isReadingSinopsis = false;
const speechSupported =
    typeof window !== "undefined" &&
    "speechSynthesis" in window &&
    typeof SpeechSynthesisUtterance !== "undefined";

function resetVoiceIcons() {
    if (!sinopsisVoiceButton) return;
    if (sinopsisVoiceOnIcon && sinopsisVoiceOffIcon) {
        sinopsisVoiceOnIcon.style.display = isReadingSinopsis ? "none" : "block";
        sinopsisVoiceOffIcon.style.display = isReadingSinopsis ? "block" : "none";
    }
}

function stopSynopsisVoice() {
    if (!speechSupported) return;
    window.speechSynthesis.cancel();
    currentUtterance = null;
    isReadingSinopsis = false;
    resetVoiceIcons();
}

function getPreferredSpanishVoice() {
    if (!speechSupported) return null;
    const voices = window.speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;

    const preferred = voices.find(voice =>
        voice.lang && voice.lang.toLowerCase().startsWith("es-es")
    );
    if (preferred) return preferred;

    const anySpanish = voices.find(voice => voice.lang && voice.lang.toLowerCase().startsWith("es"));
    return anySpanish || voices[0];
}

function handleVoiceEnd() {
    isReadingSinopsis = false;
    currentUtterance = null;
    resetVoiceIcons();
}

function startSynopsisVoice() {
    if (!speechSupported) return;
    const text = getSynopsisText();
    if (!text) return;

    stopSynopsisVoice();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "es-ES";
    utterance.rate = 1;
    utterance.volume = 1;
    const voice = getPreferredSpanishVoice();
    if (voice) {
        utterance.voice = voice;
    }
    utterance.onend = handleVoiceEnd;
    utterance.onerror = handleVoiceEnd;

    currentUtterance = utterance;
    isReadingSinopsis = true;
    resetVoiceIcons();
    window.speechSynthesis.speak(utterance);
}

function toggleSynopsisVoice() {
    if (!speechSupported) return;
    if (isReadingSinopsis) {
        stopSynopsisVoice();
    } else {
        startSynopsisVoice();
    }
}

function setupVoiceButton() {
    if (!sinopsisVoiceButton || !speechSupported) return;
    sinopsisVoiceButton.addEventListener("click", toggleSynopsisVoice);

    window.speechSynthesis.addEventListener("voiceschanged", () => {
        if (isReadingSinopsis && currentUtterance) {
            const updatedVoice = getPreferredSpanishVoice();
            if (updatedVoice) {
                currentUtterance.voice = updatedVoice;
            }
        }
    });
}

function renderVoiceButton(container) {
    sinopsisVoiceButton = document.createElement("button");
    sinopsisVoiceButton.type = "button";
    sinopsisVoiceButton.className = "sinopsis-voice-button";
    sinopsisVoiceButton.setAttribute("aria-label", "Leer sinopsis en voz alta");

    sinopsisVoiceOnIcon = document.createElement("img");
    sinopsisVoiceOnIcon.src = "assets/img/ic_voz_ON.svg";
    sinopsisVoiceOnIcon.alt = "Reproducir voz";
    sinopsisVoiceOnIcon.className = "sinopsis-voice-icon sinopsis-voice-icon--on";

    sinopsisVoiceOffIcon = document.createElement("img");
    sinopsisVoiceOffIcon.src = "assets/img/ic_voz_OFF.svg";
    sinopsisVoiceOffIcon.alt = "Detener voz";
    sinopsisVoiceOffIcon.className = "sinopsis-voice-icon sinopsis-voice-icon--off";

    sinopsisVoiceButton.appendChild(sinopsisVoiceOnIcon);
    sinopsisVoiceButton.appendChild(sinopsisVoiceOffIcon);
    container.appendChild(sinopsisVoiceButton);
    resetVoiceIcons();

    if (!speechSupported) {
        sinopsisVoiceButton.style.display = "none";
        return;
    }

    setupVoiceButton();
}

function getSynopsisText() {
    const textEl = document.querySelector(".ficha-sinopsis-texto");
    return textEl ? textEl.textContent.trim() : "";
}

function updateSinopsis(game) {
    const section = document.getElementById("sinopsis-section");
    const container = document.getElementById("ficha-sinopsis");
    if (!section || !container) return;

    const sinopsis = (game.sinopsis || "").trim();

    if (!sinopsis) {
        section.style.display = "none";
        return;
    }

    const textParagraph = document.createElement("p");
    textParagraph.className = "ficha-sinopsis-texto";
    textParagraph.textContent = sinopsis;
    container.appendChild(textParagraph);
    renderVoiceButton(container);
    
    section.style.display = "block";
}


// ============================================
// DATOS TÉCNICOS
// ============================================
function updateDatosTecnicos(game) {
    const section = document.getElementById("datos-tecnicos-section");
    const container = document.getElementById("ficha-datos-tecnicos");
    if (!section || !container) return;

    const getStatusClass = (label, value) => {
        const normalized = (value || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");

        const isCompatibilityField =
            label.includes("ZX +2A") || label.includes("THE SPECTRUM");
            const isCompletionField = label.includes("TERMINADO");

        if (!isCompatibilityField && !isCompletionField) return "";

        if (normalized === "no probado" && isCompatibilityField) return "status status--pending";
        if (normalized === "no") return "status status--no";
        if (normalized === "si") return "status status--yes";

        return "";
    };
    
    const campos = [
        { label: "· JUGADORES", value: game.jugadores },
        { label: "· CONTROLES", value: game.controles },
        { label: "· VERSIÓN", value: game.version },
        { label: "· FORMATO", value: game.formato },
        { label: "· ZX +2A", value: game.zx2a },
        { label: "· THE SPECTRUM", value: game.tspec },
        { label: "· TERMINADO", value: game.terminado }
    ];

    const camposConValor = campos.filter(campo => campo.value && campo.value.trim() !== "");

    if (!camposConValor.length) {
        section.style.display = "none";
        return;
    }

    const html = camposConValor
        .map(campo => {
            const statusClass = getStatusClass(campo.label, campo.value);
            const valueHtml = statusClass
                ? `<span class="${statusClass}">${campo.value}</span>`
                : campo.value;

            return `<p class="ficha-dato"><span class="ficha-dato-label">${campo.label}:</span> ${valueHtml}</p>`;
        })
        .join("");

    container.innerHTML = html;
    section.style.display = "block";
}

// ============================================
// GAMEPLAY
// ============================================
function updateGameplay(game) {
    const section = document.getElementById("gameplay-section");
    const frame = document.getElementById("ficha-gameplay-frame");
    const placeholder = document.getElementById("ficha-gameplay-placeholder");

    if (!section || !frame || !placeholder) return;

    const videoUrl = (game.videoUrl || "").trim();

    if (!videoUrl) {
        section.style.display = "none";
        return;
    }

    const thumbnail = getYouTubeThumbnail(videoUrl);
    if (thumbnail) {
        placeholder.style.backgroundImage = `url('${thumbnail}')`;
    } else {
        placeholder.style.backgroundImage = "";
    }

    if (!placeholder.dataset.bound) {
        placeholder.dataset.bound = "true";
        placeholder.addEventListener("click", () => {
            const iframe = document.createElement("iframe");
            const separator = videoUrl.includes("?") ? "&" : "?";
            iframe.src = `${videoUrl}${separator}autoplay=1`;
            iframe.className = "ficha-gameplay-iframe";
            iframe.title = "Gameplay";
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
            iframe.allowFullscreen = true;
            iframe.loading = "lazy";

            frame.innerHTML = "";
            frame.appendChild(iframe);
        });
    }

    section.style.display = "block";
}

// ============================================
// IMÁGENES ADICIONALES
// ============================================
function renderAdditionalImage() {
    if (!additionalImages.length) return;

    const imgEl = document.getElementById("ficha-imagenes-img");
    const counterCurrent = document.getElementById("imagenes-current");
    const counterTotal = document.getElementById("imagenes-total");
    const modal = document.getElementById("imagenes-modal");
    const modalImg = document.getElementById("imagenes-modal-img");

    if (!imgEl || !counterCurrent || !counterTotal) return;

    const url = additionalImages[additionalImageIndex];

    imgEl.src = url;
    imgEl.style.display = "block";
    counterCurrent.textContent = (additionalImageIndex + 1).toString();
    counterTotal.textContent = additionalImages.length.toString();

    if (modal && modal.classList.contains("active") && modalImg) {
        modalImg.src = url;
    }
}

function changeAdditionalImage(step) {
    if (!additionalImages.length) return;

    additionalImageIndex = (additionalImageIndex + step + additionalImages.length) % additionalImages.length;
    renderAdditionalImage();
}

function openAdditionalImagesModal() {
    const modal = document.getElementById("imagenes-modal");
    if (!modal || !additionalImages.length) return;

    modal.classList.add("active");
    renderAdditionalImage();
}

function closeAdditionalImagesModal() {
    const modal = document.getElementById("imagenes-modal");
    if (modal) {
        modal.classList.remove("active");
    }
}

function setupAdditionalImagesModalControls() {
    const modal = document.getElementById("imagenes-modal");
    const closeBtn = document.querySelector(".imagenes-modal-close");
    const prevArrow = document.querySelector(".imagenes-modal-arrow--prev");
    const nextArrow = document.querySelector(".imagenes-modal-arrow--next");

    if (closeBtn && !closeBtn.dataset.bound) {
        closeBtn.dataset.bound = "true";
        closeBtn.addEventListener("click", closeAdditionalImagesModal);
    }

    if (modal && !modal.dataset.bound) {
        modal.dataset.bound = "true";
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                closeAdditionalImagesModal();
            }
        });
    }

    if (prevArrow && !prevArrow.dataset.bound) {
        prevArrow.dataset.bound = "true";
        prevArrow.addEventListener("click", () => changeAdditionalImage(-1));
    }

    if (nextArrow && !nextArrow.dataset.bound) {
        nextArrow.dataset.bound = "true";
        nextArrow.addEventListener("click", () => changeAdditionalImage(1));
    }

    if (!additionalImagesKeydownBound) {
        additionalImagesKeydownBound = true;
        document.addEventListener("keydown", (e) => {
            if (!modal || !modal.classList.contains("active")) return;

            if (e.key === "Escape") {
                closeAdditionalImagesModal();
            } else if (e.key === "ArrowLeft") {
                changeAdditionalImage(-1);
            } else if (e.key === "ArrowRight") {
                changeAdditionalImage(1);
            }
        });
    }

    let touchStartX = 0;
    let touchEndX = 0;
    const minSwipeDistance = 40;

    if (modal && !modal.dataset.swipeBound) {
        modal.dataset.swipeBound = "true";
        modal.addEventListener("touchstart", (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        modal.addEventListener("touchend", (e) => {
            touchEndX = e.changedTouches[0].screenX;
            const distance = touchEndX - touchStartX;

            if (Math.abs(distance) < minSwipeDistance) return;

            if (distance < 0) {
                changeAdditionalImage(1);
            } else {
                changeAdditionalImage(-1);
            }
        }, { passive: true });
    }
}

function updateImagenesAdicionales(game) {
    const section = document.getElementById("imagenes-section");
    const nav = document.getElementById("ficha-imagenes-nav");
    const imgEl = document.getElementById("ficha-imagenes-img");
    if (!section || !nav || !imgEl) return;

    additionalImages = Array.isArray(game.imagenesArray)
        ? game.imagenesArray
        : parseAdditionalImagesList(game.imagenesAdicionales);
    additionalImageIndex = 0;

    if (!additionalImages.length) {
        section.style.display = "none";
        nav.style.display = "none";
        imgEl.style.display = "none";
        return;
    }

    const prevArrow = nav.querySelector(".ficha-imagenes-arrow--prev");
    const nextArrow = nav.querySelector(".ficha-imagenes-arrow--next");

    section.style.display = "block";
    nav.style.display = "flex";
    imgEl.style.display = "block";

    if (prevArrow && !prevArrow.dataset.bound) {
        prevArrow.dataset.bound = "true";
        prevArrow.addEventListener("click", () => changeAdditionalImage(-1));
    }

    if (nextArrow && !nextArrow.dataset.bound) {
        nextArrow.dataset.bound = "true";
        nextArrow.addEventListener("click", () => changeAdditionalImage(1));
    }

    if (!imgEl.dataset.bound) {
        imgEl.dataset.bound = "true";
        imgEl.addEventListener("click", openAdditionalImagesModal);
    }

    setupAdditionalImagesModalControls();
    renderAdditionalImage();
}

function splitRevistaTexto(texto) {
    const separator = " - ";
    const idx = texto.indexOf(separator);

    if (idx >= 0) {
        return {
            titulo: texto.slice(0, idx).trim(),
            detalle: texto.slice(idx + separator.length).trim()
        };
    }

    return {
        titulo: (texto || "").trim(),
        detalle: ""
    };
}

function updateRevistas(game) {
    const section = document.getElementById("revistas-section");
    const container = document.getElementById("ficha-revistas");
    if (!section || !container) return;

    const revistas = Array.isArray(game.revistas)
        ? game.revistas
        : parseRevistasList(game.revistasTexto);

    const revistasValidas = (revistas || []).filter(entry => entry && entry.texto);

    if (!revistasValidas.length) {
        section.style.display = "none";
        container.innerHTML = "";
        return;
    }

    container.innerHTML = "";

    revistasValidas.forEach((entry) => {
        const { titulo, detalle } = splitRevistaTexto(entry.texto || "");

        const linea = document.createElement("p");
        linea.className = "ficha-revista-item";

        const enlace = entry.url ? document.createElement("a") : document.createElement("span");
        enlace.className = "ficha-revista-link";
        if (entry.url) {
            enlace.href = entry.url;
            enlace.target = "_blank";
            enlace.rel = "noopener noreferrer";
        }

        enlace.appendChild(document.createTextNode("· "));

        const strong = document.createElement("strong");
        strong.textContent = titulo;
        enlace.appendChild(strong);

        if (detalle) {
            enlace.appendChild(document.createTextNode(` – ${detalle}`));
        }

        linea.appendChild(enlace);
        container.appendChild(linea);
    });

    section.style.display = "block";
}

    function showError(message) {
        const h1 = document.getElementById("ficha-title");
        if (h1) {
            h1.textContent = message;
        }
    }

       

    // ============================================
    // NAVEGACIÓN ENTRE JUEGOS
    // ============================================

    function updateNavCounter() {
    const counterEl = document.querySelector(".game-nav-counter");
    const titleEl = document.querySelector(".game-nav-title");
    
    if (counterEl && currentGameIndex >= 0) {
        const position = currentGameIndex + 1;
        const total = sortedGamesList.length;
        const counterText = `${position.toLocaleString("es-ES")}/${total.toLocaleString("es-ES")}`;
        counterEl.textContent = counterText;
        sessionStorage.setItem("navCounter", counterText);
    }
    
    // Actualizar título según si hay búsqueda o no
    if (titleEl) {
        const searchQuery = getQueryParam("search");
        if (searchQuery) {
            // Capitalizar primera letra de la búsqueda
            const searchCapitalized = searchQuery.charAt(0).toUpperCase() + searchQuery.slice(1).toLowerCase();
            titleEl.textContent = `Juegos ${searchCapitalized}`;
        } else {
            titleEl.textContent = "Juegos ZX Spectrum";
        }
    }
}

function attachVoiceStopToNavigation() {
    const navSelectors = [
        ".top-bar-back",
        ".top-bar-home",
        ".game-nav-arrow--prev",
        ".game-nav-arrow--next"
    ];

    navSelectors.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.addEventListener("click", () => stopSynopsisVoice(), { capture: true });
        }
    });

    window.addEventListener("beforeunload", () => {
        stopSynopsisVoice();
    });
}

       
    function setupNavigation() {
    const prevArrow = document.querySelector(".game-nav-arrow--prev");
    const nextArrow = document.querySelector(".game-nav-arrow--next");
    const counterEl = document.querySelector(".game-nav-counter");
    
    // Obtener el parámetro search actual para mantenerlo en la navegación
    const searchQuery = getQueryParam("search");

    if (prevArrow) {
        prevArrow.addEventListener("click", () => {
            if (currentGameIndex > 0) {
                stopSynopsisVoice();
                const newPosition = currentGameIndex;
                const total = sortedGamesList.length;
                const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                if (counterEl) {
                    counterEl.textContent = counterText;
                }
                sessionStorage.setItem("navCounter", counterText);
                
                const prevGame = sortedGamesList[currentGameIndex - 1];
                let url = `spectrum-ficha.html?id=${encodeURIComponent(prevGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                window.location.href = url;
            }
        });
        prevArrow.style.cursor = "pointer";
    }

    if (nextArrow) {
        nextArrow.addEventListener("click", () => {
            if (currentGameIndex < sortedGamesList.length - 1) {
                stopSynopsisVoice();
                const newPosition = currentGameIndex + 2;
                const total = sortedGamesList.length;
                const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                if (counterEl) {
                    counterEl.textContent = counterText;
                }
                sessionStorage.setItem("navCounter", counterText);
                
                const nextGame = sortedGamesList[currentGameIndex + 1];
                let url = `spectrum-ficha.html?id=${encodeURIComponent(nextGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                window.location.href = url;
            }
        });
        nextArrow.style.cursor = "pointer";
    }
}

    async function loadGamesList(gameId) {
    try {
        const response = await fetch(ZX_LISTA_CSV_URL);
        if (!response.ok) {
            throw new Error("No se pudo cargar la lista");
        }

        const text = await response.text();
        const games = parseListaCSV(text);

        // Ordenar alfabéticamente
        games.sort((a, b) => (a.sortKey || "").localeCompare(b.sortKey || "", "es-ES"));

        // Comprobar si hay filtro de búsqueda
        const searchQuery = getQueryParam("search");
        
        let filteredGames = games;
        
        if (searchQuery) {
            const qNorm = normalizeText(searchQuery);
            
            // Comprobar si es búsqueda por letra (ej: "B+")
            const letterMatch = searchQuery.match(/^([a-zñáéíóúü])\+$/i);
            
            if (letterMatch) {
                const letter = normalizeText(letterMatch[1]);
                filteredGames = games.filter(game => {
                    const titleNorm = normalizeText(game.sortKey || "");
                    return titleNorm.startsWith(letter);
                });
            } else {
                // Búsqueda normal en todos los campos
                filteredGames = games.filter(game => {
                    const titleNorm = normalizeText(game.sortKey || "");
                    const pubNorm = normalizeText(game.pub || "");
                    const yearNorm = normalizeText(game.anio || "");
                    const autorNorm = normalizeText(game.autor || "");
                    const desNorm = normalizeText(game.des || "");
                    const contrNorm = normalizeText(game.contr || "");
                    const generoNorm = normalizeText(game.genero || "");

                    return (
                        titleNorm.includes(qNorm) ||
                        pubNorm.includes(qNorm) ||
                        yearNorm.includes(qNorm) ||
                        autorNorm.includes(qNorm) ||
                        desNorm.includes(qNorm) ||
                        contrNorm.includes(qNorm) ||
                        generoNorm.includes(qNorm)
                    );
                });
            }
        }

        sortedGamesList = filteredGames;

        // Encontrar posición del juego actual
        currentGameIndex = filteredGames.findIndex(g => g.id === gameId);

        // Actualizar contador
        updateNavCounter();

        // Configurar flechas
        setupNavigation();

    } catch (err) {
        console.error("Error cargando lista para navegación:", err);
    }
}

    // ============================================
    // CARGA PRINCIPAL
    // ============================================
    
    async function loadSpectrumFicha() {
        const gameId = (getQueryParam("id") || "").trim();
        
        if (!gameId) {
            console.warn("No hay ID en la URL.");
            showError("ID no especificado");
            return;
        }

        try {
            // Cargar datos del juego
            const response = await fetch(ZX_SPECTRUM_CSV_URL);
            if (!response.ok) {
                throw new Error("No se pudo cargar el CSV");
            }

            const text = await response.text();
            const games = parseSpectrumCSV(text);
            const game = games.find(row => row.id === gameId);

                if (game) {
                updateTitle(game);
                updateCover(game);
                updatePuntuacion(game);
                updateScreenshots(game);
                updateFichaDatos(game);
                updateSinopsis(game);
                updateDatosTecnicos(game);
                updateGameplay(game);
                updateImagenesAdicionales(game);
                updateRevistas(game);
                } else {
                showError("Juego no encontrado");
                }

            // Cargar lista para navegación
            await loadGamesList(gameId);

        } catch (err) {
            console.error("Error cargando ZX_SPECTRUM:", err);
            showError("Error cargando datos");
        }
    }

    // ============================================
    // INICIALIZACIÓN
    // ============================================
    
    document.addEventListener("DOMContentLoaded", () => {
    // Mostrar título correcto desde el inicio (evita parpadeo)
    const titleEl = document.querySelector(".game-nav-title");
    if (titleEl) {
        const searchQuery = getQueryParam("search");
        if (searchQuery) {
            const searchCapitalized = searchQuery.charAt(0).toUpperCase() + searchQuery.slice(1).toLowerCase();
            titleEl.textContent = `Juegos ${searchCapitalized}`;
        } else {
            titleEl.textContent = "Juegos ZX Spectrum";
        }
    }

    // Recuperar contador guardado mientras carga
    const savedCounter = sessionStorage.getItem("navCounter");
    if (savedCounter) {
        const counterEl = document.querySelector(".game-nav-counter");
        if (counterEl) {
            counterEl.textContent = savedCounter;
        }
    }
    
    loadSpectrumFicha();
    setupCoverModal();
    setupSwipeNavigation();
    attachVoiceStopToNavigation();
});
       // ============================================
// MODAL CARÁTULA
// ============================================

function setupCoverModal() {
    const coverImg = document.getElementById("ficha-cover");
    const modal = document.getElementById("cover-modal");
    const modalImg = document.getElementById("cover-modal-img");
    const closeBtn = document.querySelector(".cover-modal-close");

    if (!coverImg || !modal || !modalImg || !closeBtn) return;

    // Abrir modal al clicar carátula
    coverImg.addEventListener("click", function() {
        modalImg.src = coverImg.src;
        modal.classList.add("active");
    });

    // Cerrar con la X
    closeBtn.addEventListener("click", function() {
        modal.classList.remove("active");
    });

    // Cerrar clicando fuera de la imagen
    modal.addEventListener("click", function(e) {
        if (e.target === modal) {
            modal.classList.remove("active");
        }
    });

    // Cerrar con ESC
    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape" && modal.classList.contains("active")) {
            modal.classList.remove("active");
        }
    });
}
       // ============================================
// SWIPE PARA NAVEGACIÓN EN MÓVIL
// ============================================

function setupSwipeNavigation() {
    let touchStartX = 0;
    let touchEndX = 0;
    const minSwipeDistance = 50;
    
    // Obtener el parámetro search actual
    const searchQuery = getQueryParam("search");

    document.addEventListener("touchstart", function(e) {
        touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    document.addEventListener("touchend", function(e) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }, { passive: true });

    function handleSwipe() {
        const distance = touchEndX - touchStartX;

        if (Math.abs(distance) < minSwipeDistance) return;

        if (distance < 0) {
            // Swipe hacia la izquierda → siguiente ficha
            if (currentGameIndex < sortedGamesList.length - 1) {
                const nextGame = sortedGamesList[currentGameIndex + 1];
                let url = `spectrum-ficha.html?id=${encodeURIComponent(nextGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                stopSynopsisVoice();
                window.location.href = url;
            }
        } else {
            // Swipe hacia la derecha → ficha anterior
            if (currentGameIndex > 0) {
                const prevGame = sortedGamesList[currentGameIndex - 1];
                let url = `spectrum-ficha.html?id=${encodeURIComponent(prevGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                stopSynopsisVoice();
                window.location.href = url;
            }
        }
    }
}
</script>

    <script src="assets/js/app.js"></script>

    <!-- MODAL CARÁTULA -->
<div id="cover-modal" class="cover-modal">
    <span class="cover-modal-close">&times;</span>
    <img class="cover-modal-img" id="cover-modal-img" alt="Carátula ampliada">
</div>
    
<!-- MODAL IMÁGENES ADICIONALES -->
<div id="imagenes-modal" class="imagenes-modal">
    <span class="imagenes-modal-close">&times;</span>
    <img class="imagenes-modal-img" id="imagenes-modal-img" alt="Imagen adicional ampliada">
    <img src="assets/img/ic_back.svg" class="imagenes-modal-arrow imagenes-modal-arrow--prev" alt="Anterior">
    <img src="assets/img/ic_back.svg" class="imagenes-modal-arrow imagenes-modal-arrow--next" alt="Siguiente">
</div>
</body>
</html>
