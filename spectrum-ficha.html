<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZX Spectrum – Ficha</title>
    <link rel="stylesheet" href="assets/css/global.css">
</head>

<body class="ficha-final loading">

    <!-- CABECERA -->
    <header class="top-bar top-bar--spectrum">
        <div class="top-bar-inner top-bar-inner--ficha">

            <!-- Botón ATRÁS (izquierda) -->
            <img src="assets/img/ic_back.svg"
                 class="top-bar-back"
                 alt="Atrás"
                 onclick="history.back()">

            <!-- Navegación juego a juego (centrada) -->
            <div class="game-nav-bar game-nav-bar--inline">
                <div class="game-nav-center">
                    <img src="assets/img/ic_back.svg"
                         class="game-nav-arrow game-nav-arrow--prev"
                         alt="Anterior">

                    <span class="game-nav-counter">- / -</span>

                    <img src="assets/img/ic_back.svg"
                         class="game-nav-arrow game-nav-arrow--next game-nav-arrow--next-real"
                         alt="Siguiente">
                </div>
            </div>

            <!-- Botón HOME (derecha) -->
            <img src="assets/img/ic_home.svg"
                 class="top-bar-home"
                 alt="Home"
                 onclick="window.location.href='index.html'">

        </div>
    </header>

    <!-- CONTENIDO -->
<main class="platforms-content">
    
    <!-- BLOQUE SUPERIOR: Carátula + Info básica -->
<div class="ficha-hero">
    <div class="ficha-cover-wrapper">
        <img id="ficha-cover"
             class="ficha-cover"
             alt="Carátula del juego"
             style="display:none;">
    </div>
    <div class="ficha-hero-info">
 <h1 id="ficha-title" class="loading-title">Cargando ficha...</h1>

        <!-- Estos empiezan ocultos -->
        <p class="ficha-platform" style="display:none;">ZX Spectrum</p>
        <p class="ficha-puntuacion" id="ficha-puntuacion" style="display:none;"></p>

        <div class="ficha-rating" style="display:none;">
            <span class="ficha-rating-stars" id="ficha-rating-stars">★★★★★</span>
        </div>
    </div>
</div>
<!-- Eliminamos el párrafo de "Aquí montaremos la ficha..." -->


</main>

   <script>
    // ============================================
    // CONFIGURACIÓN
    // ============================================
    const ZX_SPECTRUM_CSV_URL = 
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1890916807&single=true&output=csv";

    const ZX_LISTA_CSV_URL = 
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1313999074&single=true&output=csv";

    // Lista ordenada de juegos para navegación
    let sortedGamesList = [];
    let currentGameIndex = -1;

    // ============================================
    // UTILIDADES
    // ============================================
    
    function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const ch = line[i];

            if (ch === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (ch === "," && !inQuotes) {
                result.push(current.trim());
                current = "";
            } else {
                current += ch;
            }
        }

        result.push(current.trim());
        return result;
    }

    function findColumnIndex(header, names) {
        for (const name of names) {
            const idx = header.indexOf(name);
            if (idx >= 0) return idx;
        }
        return -1;
    }

    function getColumnValue(cols, idx) {
        return idx >= 0 && cols[idx] !== undefined ? cols[idx].trim() : "";
    }

    function formatTitleWithArticle(title) {
        if (!title) return "";
        const t = title.trim();
        const re = /^(the|a|an|el|la|los|las|lo)\s+(.*)$/i;
        const match = t.match(re);
        if (!match) return t;
        return match[2] + ", " + match[1];
    }

// ============================================
// PARSER CSV GENERAL (soporta saltos de línea dentro de comillas)
// ============================================
function parseCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentField = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const ch = text[i];

        if (ch === '"') {
            if (inQuotes && text[i + 1] === '"') {
                // Doble comilla dentro de campo: se convierte en una comilla
                currentField += '"';
                i++;
            } else {
                // Entramos o salimos de comillas
                inQuotes = !inQuotes;
            }
        } else if (ch === "," && !inQuotes) {
            // Fin de campo
            currentRow.push(currentField.trim());
            currentField = "";
        } else if ((ch === "\n" || ch === "\r") && !inQuotes) {
            // Fin de fila (solo si no estamos dentro de comillas)
            // Manejo de \r\n
            if (ch === "\r" && text[i + 1] === "\n") {
                i++;
            }
            currentRow.push(currentField.trim());
            // Evitar filas totalmente vacías
            if (currentRow.some(v => v !== "")) {
                rows.push(currentRow);
            }
            currentRow = [];
            currentField = "";
        } else {
            currentField += ch;
        }
    }

    // Último campo/fila si no termina en salto de línea
    if (currentField.length > 0 || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.some(v => v !== "")) {
            rows.push(currentRow);
        }
    }

    return rows;
}

       // ============================================
    // PARSER CSV - FICHA (datos completos) con soporte de filas partidas
    // ============================================
    function parseSpectrumCSV(text) {
        const lines = text.trim().split(/\r?\n/);
        if (!lines.length) return [];

        const header = parseCSVLine(lines[0]);
        console.log("Columnas del CSV:", header);
        const expectedCols = header.length;
        const rows = [];

        const idxID = header.indexOf("ID");
        const idxTit = findColumnIndex(header, ["TITULO_MOSTRAR", "TÍTULO", "TITULO"]);
        const idxPub = header.indexOf("PUBLISHER_MOSTRAR");
        const idxAnio = header.indexOf("AÑO_MOSTRAR");
        const idxCaratula = findColumnIndex(header, ["CARÁTULA", "CARATULA"]);
        const idxImgAdic = findColumnIndex(header, [
            "IMÁGENES",
            "IMAGENES",
            "IMAGENES_ADICIONALES",
            "IMÁGENES_ADICIONALES"
        ]);
        const idxPuntuacion = findColumnIndex(header, ["PUNTUACIÓN", "PUNTUACION"]);
        console.log("Índice de PUNTUACIÓN:", idxPuntuacion);

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;

            let rawLine = lines[i];
            let cols = parseCSVLine(rawLine);

            // Si la fila viene "rota" en varias líneas (REVISTAS, SINOPSIS, etc.),
            // vamos pegando líneas hasta tener el número correcto de columnas
            while (cols.length < expectedCols && i + 1 < lines.length) {
                rawLine += "\n" + lines[i + 1];
                i++;
                cols = parseCSVLine(rawLine);
            }

            const thisId = getColumnValue(cols, idxID);

            // DEBUG opcional: dejamos "3" mientras probamos con 10th frame
            const debugId = "3";
            if (thisId === debugId) {
                console.log("===== DEBUG FILA PUNTUACIÓN =====");
                console.log("ID de la fila:", thisId);
                console.log("Array completo de columnas:", cols);
                console.log("Nº columnas:", cols.length);
                console.log("Valor en índice PUNTUACIÓN (" + idxPuntuacion + "):", cols[idxPuntuacion]);
                console.log("=================================");
            }

            rows.push({
                id: thisId,
                titulo: getColumnValue(cols, idxTit),
                pub: getColumnValue(cols, idxPub),
                anio: getColumnValue(cols, idxAnio),
                caratula: getColumnValue(cols, idxCaratula),
                imagenesAdicionales: getColumnValue(cols, idxImgAdic),
                puntuacion: getColumnValue(cols, idxPuntuacion)
            });
        }

        return rows;
    }

    // ============================================
    // PARSER CSV - LISTA (para navegación)
    // ============================================
    function parseListaCSV(text) {
        const lines = text.trim().split(/\r?\n/);
        if (!lines.length) return [];

        const header = parseCSVLine(lines[0]);
        const rows = [];

        const idxID = header.indexOf("ID");
        const idxTitulo = header.indexOf("TITULO_MOSTRAR");

        for (let i = 1; i < lines.length; i++) {
            const line = lines[i];
            if (!line.trim()) continue;

            const cols = parseCSVLine(line);
            const id = getColumnValue(cols, idxID);
            const titulo = getColumnValue(cols, idxTitulo);

            if (!titulo) continue;

            const displayTitulo = formatTitleWithArticle(titulo);

            rows.push({
                id,
                titulo,
                displayTitulo,
                sortKey: displayTitulo.toLowerCase()
            });
        }

        return rows;
    }



    // ============================================
    // EXTRACCIÓN DE CARÁTULA
    // ============================================
    
    function extractURLs(text) {
        const urlRegex = /https?:\/\/[^\s,]+/g;
        const urls = [];
        let match;

        while ((match = urlRegex.exec(text)) !== null) {
            const cleanUrl = match[0].replace(/["',]+$/g, "");
            urls.push({
                url: cleanUrl,
                index: match.index
            });
        }

        return urls;
    }

    function findBestCover(imagenesText) {
        const urls = extractURLs(imagenesText);
        if (urls.length === 0) return "";

        let bestUrl = urls[0].url;

        for (const item of urls) {
            const contextStart = Math.max(0, item.index - 80);
            const context = imagenesText
                .slice(contextStart, item.index)
                .toLowerCase();

            if (context.includes("inlay") && context.includes("front")) {
                bestUrl = item.url;
                break;
            }
        }

        return bestUrl;
    }

    function getCoverURL(game) {
        if (game.caratula) {
            return game.caratula;
        }

        if (game.imagenesAdicionales) {
            return findBestCover(game.imagenesAdicionales);
        }

        return "";
    }

    // ============================================
    // ACTUALIZACIÓN DE UI
    // ============================================
    
function updateTitle(game) {
    const title = game.titulo || "Juego ZX Spectrum";
    document.title = `${title} – ZX Spectrum`;

    const h1 = document.getElementById("ficha-title");
    if (h1) {
        h1.textContent = title;
        h1.classList.remove("loading-title");   // ① quitamos la clase del título
    }

    // Mostrar "ZX Spectrum" cuando ya tenemos juego
    const platformEl = document.querySelector(".ficha-platform");
    if (platformEl) {
        platformEl.style.display = "block";
    }

    // ② salimos del modo "loading" en todo el body
    document.body.classList.remove("loading");
}

    function updateCover(game) {
    const coverImg = document.getElementById("ficha-cover");
    console.log("1. coverImg encontrado:", coverImg);
    if (!coverImg) return;

    const coverUrl = getCoverURL(game);
    console.log("2. URL de carátula:", coverUrl);

    if (coverUrl) {
        coverImg.onload = function() {
            console.log("3. Imagen cargada correctamente");
            console.log("4. Dimensiones naturales:", coverImg.naturalWidth, "x", coverImg.naturalHeight);
            
            const aspectRatio = coverImg.naturalWidth / coverImg.naturalHeight;
            const scaledWidth = 320 * aspectRatio;
            console.log("5. Ancho escalado:", scaledWidth);

            if (scaledWidth < 220) {
                console.log("6. Imagen ESTRECHA → aplicando fill");
                coverImg.style.width = "100%";
                coverImg.style.height = "100%";
                coverImg.style.objectFit = "fill";
                coverImg.style.left = "0";
                coverImg.style.right = "auto";
            } else {
                console.log("6. Imagen ANCHA → aplicando cover");
                coverImg.style.width = "auto";
                coverImg.style.height = "100%";
                coverImg.style.objectFit = "cover";
                coverImg.style.left = "auto";
                coverImg.style.right = "0";
            }
        };

        coverImg.onerror = function() {
            console.error("ERROR: No se pudo cargar la imagen:", coverUrl);
        };

        coverImg.src = coverUrl;
        coverImg.alt = `Carátula de ${game.titulo || "juego ZX Spectrum"}`;
        coverImg.style.display = "block";
        console.log("7. src asignado y display:block aplicado");
    } else {
        console.log("Sin URL de carátula");
        coverImg.style.display = "none";
    }
}

function updatePuntuacion(game) {
    const puntuacionEl = document.getElementById("ficha-puntuacion");
    const ratingEl = document.querySelector(".ficha-rating");
    const starsEl = document.getElementById("ficha-rating-stars");
    if (!puntuacionEl || !ratingEl || !starsEl) return;

    const valor = (game.puntuacion || "").trim();
    console.log("Puntuación del juego:", valor);

    if (valor) {
        // 1) Texto debajo de ZX Spectrum
        puntuacionEl.innerHTML = `<b>Puntuación:</b> ${valor}`;
        puntuacionEl.style.display = "block";
        ratingEl.style.display = "flex";

        // 2) Sacar la nota ("5,8" de "5,8 (5 votos)")
        const match = valor.match(/^(\d+[.,]?\d*)/);
        let nota = 0;
        if (match) {
            nota = parseFloat(match[1].replace(",", "."));
        }

        // 3) Clamp 0–10
        if (isNaN(nota)) nota = 0;
        if (nota < 0) nota = 0;
        if (nota > 10) nota = 10;

        // 4) Pasar a porcentaje 0–100
        const porcentaje = (nota / 10) * 100;
        console.log("Nota numérica:", nota, "→ porcentaje barra:", porcentaje);

        // 5) Elegir color
        let color = "#ff4b4b"; // rojo
        if (nota >= 7) {
            color = "#00c853"; // verde
        } else if (nota >= 5) {
            color = "#ffd600"; // amarillo
        }

        // 6) Aplicar variables CSS al span con animación garantizada

// Primero reseteamos a 0% para que siempre haya "viaje"
starsEl.style.setProperty("--fill", "0%");
starsEl.style.setProperty("--rating-color", color);

// Forzamos reflow para que el navegador pinte el 0%
void starsEl.offsetWidth;

// Ahora sí, llevamos el relleno al porcentaje final (se anima)
starsEl.style.setProperty("--fill", porcentaje + "%");


    } else {
        // Sin puntuación → ocultar
        puntuacionEl.innerHTML = "";
        puntuacionEl.style.display = "none";
        ratingEl.style.display = "none";

        starsEl.style.setProperty("--fill", "0%");
    }
}




    function showError(message) {
        const h1 = document.getElementById("ficha-title");
        if (h1) {
            h1.textContent = message;
        }
    }

    // ============================================
    // NAVEGACIÓN ENTRE JUEGOS
    // ============================================

    function updateNavCounter() {
        const counterEl = document.querySelector(".game-nav-counter");
        if (counterEl && currentGameIndex >= 0) {
            const position = currentGameIndex + 1;
            const total = sortedGamesList.length;
            const counterText = `${position.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
            counterEl.textContent = counterText;
            // Guardar en sessionStorage para la próxima carga
            sessionStorage.setItem("navCounter", counterText);
        }
    }

    function setupNavigation() {
        const prevArrow = document.querySelector(".game-nav-arrow--prev");
        const nextArrow = document.querySelector(".game-nav-arrow--next");
        const counterEl = document.querySelector(".game-nav-counter");

        if (prevArrow) {
            prevArrow.addEventListener("click", () => {
                if (currentGameIndex > 0) {
                    // Actualizar contador inmediatamente y guardarlo
                    const newPosition = currentGameIndex;
                    const total = sortedGamesList.length;
                    const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                    if (counterEl) {
                        counterEl.textContent = counterText;
                    }
                    sessionStorage.setItem("navCounter", counterText);
                    
                    const prevGame = sortedGamesList[currentGameIndex - 1];
                    window.location.href = `spectrum-ficha.html?id=${encodeURIComponent(prevGame.id)}`;
                }
            });
            prevArrow.style.cursor = "pointer";
        }

        if (nextArrow) {
            nextArrow.addEventListener("click", () => {
                if (currentGameIndex < sortedGamesList.length - 1) {
                    // Actualizar contador inmediatamente y guardarlo
                    const newPosition = currentGameIndex + 2;
                    const total = sortedGamesList.length;
                    const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                    if (counterEl) {
                        counterEl.textContent = counterText;
                    }
                    sessionStorage.setItem("navCounter", counterText);
                    
                    const nextGame = sortedGamesList[currentGameIndex + 1];
                    window.location.href = `spectrum-ficha.html?id=${encodeURIComponent(nextGame.id)}`;
                }
            });
            nextArrow.style.cursor = "pointer";
        }
    }

    async function loadGamesList(gameId) {
        try {
            const response = await fetch(ZX_LISTA_CSV_URL);
            if (!response.ok) {
                throw new Error("No se pudo cargar la lista");
            }

            const text = await response.text();
            const games = parseListaCSV(text);

            // Ordenar alfabéticamente
            games.sort((a, b) => (a.sortKey || "").localeCompare(b.sortKey || "", "es-ES"));

            sortedGamesList = games;

            // Encontrar posición del juego actual
            currentGameIndex = games.findIndex(g => g.id === gameId);

            // Actualizar contador
            updateNavCounter();

            // Configurar flechas
            setupNavigation();

        } catch (err) {
            console.error("Error cargando lista para navegación:", err);
        }
    }

    // ============================================
    // CARGA PRINCIPAL
    // ============================================
    
    async function loadSpectrumFicha() {
        const gameId = (getQueryParam("id") || "").trim();
        
        if (!gameId) {
            console.warn("No hay ID en la URL.");
            showError("ID no especificado");
            return;
        }

        try {
            // Cargar datos del juego
            const response = await fetch(ZX_SPECTRUM_CSV_URL);
            if (!response.ok) {
                throw new Error("No se pudo cargar el CSV");
            }

            const text = await response.text();
            const games = parseSpectrumCSV(text);
            const game = games.find(row => row.id === gameId);

            if (game) {
    updateTitle(game);
    updateCover(game);
    updatePuntuacion(game);
} else {
    showError("Juego no encontrado");
}

            // Cargar lista para navegación
            await loadGamesList(gameId);

        } catch (err) {
            console.error("Error cargando ZX_SPECTRUM:", err);
            showError("Error cargando datos");
        }
    }

    // ============================================
    // INICIALIZACIÓN
    // ============================================
    
    document.addEventListener("DOMContentLoaded", () => {
        // Recuperar contador guardado mientras carga
        const savedCounter = sessionStorage.getItem("navCounter");
        if (savedCounter) {
            const counterEl = document.querySelector(".game-nav-counter");
            if (counterEl) {
                counterEl.textContent = savedCounter;
            }
        }
        
        loadSpectrumFicha();
    });
</script>

    <script src="assets/js/app.js"></script>

</body>
</html>
