<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZX Spectrum – Ficha</title>
    <link rel="stylesheet" href="assets/css/global.css">
</head>

<body class="ficha-final">

    <!-- CABECERA -->
    <header class="top-bar top-bar--spectrum">
        <div class="top-bar-inner top-bar-inner--ficha">

            <!-- Botón ATRÁS (izquierda) -->
            <img src="assets/img/ic_back.svg"
                 class="top-bar-back"
                 alt="Atrás"
                 onclick="history.back()">

            <!-- Navegación juego a juego (centrada) -->
            <div class="game-nav-bar game-nav-bar--inline">
                <div class="game-nav-center">
                    <img src="assets/img/ic_back.svg"
                         class="game-nav-arrow game-nav-arrow--prev"
                         alt="Anterior">

                    <span class="game-nav-counter">10 / 7.800</span>

                    <img src="assets/img/ic_back.svg"
                         class="game-nav-arrow game-nav-arrow--next game-nav-arrow--next-real"
                         alt="Siguiente">
                </div>
            </div>

            <!-- Botón HOME (derecha) -->
            <img src="assets/img/ic_home.svg"
                 class="top-bar-home"
                 alt="Home"
                 onclick="window.location.href='index.html'">

        </div>
    </header>

    <!-- CONTENIDO -->
    <main class="platforms-content">
        <h1 id="ficha-title">Cargando juego...</h1>
        <div class="ficha-cover-wrapper">
            <img id="ficha-cover"
                 class="ficha-cover"
                 alt="Carátula del juego"
                 style="display:none;">
        </div>
        <p>Aquí montaremos la ficha completa con todos los datos.</p>
    </main>

    <script>
        // ============================================
        // CONFIGURACIÓN
        // ============================================
        const ZX_SPECTRUM_CSV_URL = 
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1890916807&single=true&output=csv";

        // ============================================
        // UTILIDADES
        // ============================================
        
        /**
         * Obtiene un parámetro de la URL
         * @param {string} name - Nombre del parámetro
         * @returns {string|null}
         */
        function getQueryParam(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        /**
         * Parser de línea CSV que respeta comillas
         * @param {string} line - Línea CSV a parsear
         * @returns {string[]}
         */
        function parseCSVLine(line) {
            const result = [];
            let current = "";
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const ch = line[i];

                if (ch === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (ch === "," && !inQuotes) {
                    result.push(current.trim());
                    current = "";
                } else {
                    current += ch;
                }
            }

            result.push(current.trim());
            return result;
        }

        /**
         * Busca índice de columna con fallbacks
         * @param {string[]} header - Array de encabezados
         * @param {string[]} names - Nombres a buscar (en orden de prioridad)
         * @returns {number}
         */
        function findColumnIndex(header, names) {
            for (const name of names) {
                const idx = header.indexOf(name);
                if (idx >= 0) return idx;
            }
            return -1;
        }

        /**
         * Obtiene valor de columna de forma segura
         * @param {string[]} cols - Array de valores
         * @param {number} idx - Índice de columna
         * @returns {string}
         */
        function getColumnValue(cols, idx) {
            return idx >= 0 && cols[idx] !== undefined ? cols[idx].trim() : "";
        }

        // ============================================
        // PARSER CSV
        // ============================================
        
        /**
         * Parsea el CSV de ZX Spectrum
         * @param {string} text - Contenido del CSV
         * @returns {Array<Object>}
         */
        function parseSpectrumCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length === 0) return [];

            const header = parseCSVLine(lines[0]);
            const rows = [];

            // Localizar índices de columnas
            const idxID = header.indexOf("ID");
            const idxTit = findColumnIndex(header, ["TITULO_MOSTRAR", "TÍTULO", "TITULO"]);
            const idxPub = header.indexOf("PUBLISHER_MOSTRAR");
            const idxAnio = header.indexOf("AÑO_MOSTRAR");
            const idxCaratula = findColumnIndex(header, ["CARÁTULA", "CARATULA"]);
            const idxImgAdic = findColumnIndex(header, [
                "IMÁGENES", 
                "IMAGENES", 
                "IMAGENES_ADICIONALES", 
                "IMÁGENES_ADICIONALES"
            ]);

            // Procesar filas
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;

                const cols = parseCSVLine(line);

                rows.push({
                    id: getColumnValue(cols, idxID),
                    titulo: getColumnValue(cols, idxTit),
                    pub: getColumnValue(cols, idxPub),
                    anio: getColumnValue(cols, idxAnio),
                    caratula: getColumnValue(cols, idxCaratula),
                    imagenesAdicionales: getColumnValue(cols, idxImgAdic)
                });
            }

            return rows;
        }

        // ============================================
        // EXTRACCIÓN DE CARÁTULA
        // ============================================
        
        /**
         * Extrae URLs de un texto
         * @param {string} text - Texto con URLs
         * @returns {Array<{url: string, index: number}>}
         */
        function extractURLs(text) {
            const urlRegex = /https?:\/\/[^\s,]+/g;
            const urls = [];
            let match;

            while ((match = urlRegex.exec(text)) !== null) {
                const cleanUrl = match[0].replace(/["',]+$/g, "");
                urls.push({
                    url: cleanUrl,
                    index: match.index
                });
            }

            return urls;
        }

        /**
         * Busca la mejor carátula en las imágenes adicionales
         * @param {string} imagenesText - Texto con URLs de imágenes
         * @returns {string}
         */
        function findBestCover(imagenesText) {
            const urls = extractURLs(imagenesText);
            if (urls.length === 0) return "";

            // Por defecto, la primera URL
            let bestUrl = urls[0].url;

            // Buscar "Inlay Front" cerca de alguna URL
            for (const item of urls) {
                const contextStart = Math.max(0, item.index - 80);
                const context = imagenesText
                    .slice(contextStart, item.index)
                    .toLowerCase();

                if (context.includes("inlay") && context.includes("front")) {
                    bestUrl = item.url;
                    break;
                }
            }

            return bestUrl;
        }

        /**
         * Obtiene la URL de carátula del juego
         * @param {Object} game - Datos del juego
         * @returns {string}
         */
        function getCoverURL(game) {
            // 1. Prioridad: columna CARÁTULA
            if (game.caratula) {
                return game.caratula;
            }

            // 2. Buscar en imágenes adicionales
            if (game.imagenesAdicionales) {
                return findBestCover(game.imagenesAdicionales);
            }

            return "";
        }

        // ============================================
        // ACTUALIZACIÓN DE UI
        // ============================================
        
        /**
         * Actualiza el título de la página
         * @param {Object} game - Datos del juego
         */
        function updateTitle(game) {
            const title = game.titulo || "Juego ZX Spectrum";
            document.title = `${title} – ZX Spectrum`;
            
            const h1 = document.getElementById("ficha-title");
            if (h1) {
                h1.textContent = title;
            }
        }

        /**
         * Actualiza la carátula
         * @param {Object} game - Datos del juego
         */
        function updateCover(game) {
            const coverImg = document.getElementById("ficha-cover");
            if (!coverImg) return;

            const coverUrl = getCoverURL(game);

            if (coverUrl) {
                coverImg.src = coverUrl;
                coverImg.alt = `Carátula de ${game.titulo || "juego ZX Spectrum"}`;
                coverImg.style.display = "block";
            } else {
                coverImg.style.display = "none";
            }
        }

        /**
         * Muestra mensaje de error
         * @param {string} message - Mensaje a mostrar
         */
        function showError(message) {
            const h1 = document.getElementById("ficha-title");
            if (h1) {
                h1.textContent = message;
            }
        }

        // ============================================
        // CARGA PRINCIPAL
        // ============================================
        
        /**
         * Carga y muestra los datos del juego
         */
        async function loadSpectrumFicha() {
            const gameId = (getQueryParam("id") || "").trim();
            
            if (!gameId) {
                console.warn("No hay ID en la URL.");
                showError("ID no especificado");
                return;
            }

            try {
                const response = await fetch(ZX_SPECTRUM_CSV_URL);
                if (!response.ok) {
                    throw new Error("No se pudo cargar el CSV");
                }

                const text = await response.text();
                const games = parseSpectrumCSV(text);
                const game = games.find(row => row.id === gameId);

                if (game) {
                    updateTitle(game);
                    updateCover(game);
                } else {
                    showError("Juego no encontrado");
                }

            } catch (err) {
                console.error("Error cargando ZX_SPECTRUM:", err);
                showError("Error cargando datos");
            }
        }

        // ============================================
        // INICIALIZACIÓN
        // ============================================
        
        document.addEventListener("DOMContentLoaded", loadSpectrumFicha);
    </script>

    <script src="assets/js/app.js"></script>

</body>
</html>
