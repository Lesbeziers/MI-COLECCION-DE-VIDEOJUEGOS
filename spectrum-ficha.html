<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ZX Spectrum – Ficha</title>
    <link rel="stylesheet" href="assets/css/global.css">
</head>

<body class="ficha-final loading">

    <!-- CABECERA -->
    <header class="top-bar top-bar--spectrum">
        <div class="top-bar-inner top-bar-inner--ficha">

<img src="assets/img/ic_back.svg"
     class="top-bar-back"
     alt="Atrás"
     onclick="goBackToList()">

           <!-- Navegación juego a juego (centrada) -->
<div class="game-nav-bar game-nav-bar--inline">
    <div class="game-nav-center">
        <img src="assets/img/ic_back.svg"
             class="game-nav-arrow game-nav-arrow--prev"
             alt="Anterior">

        <span class="game-nav-title"></span>

        <img src="assets/img/ic_back.svg"
             class="game-nav-arrow game-nav-arrow--next game-nav-arrow--next-real"
             alt="Siguiente">
    </div>
    <div class="game-nav-counter-line">
        <span class="game-nav-counter">- / -</span>
    </div>
</div>

            <!-- Botón HOME (derecha) -->
            <img src="assets/img/ic_home.svg"
                 class="top-bar-home"
                 alt="Home"
                 onclick="window.location.href='index.html'">

        </div>
    </header>

    <!-- CONTENIDO -->
<main class="platforms-content">
    
<!-- BLOQUE SUPERIOR: Carátula + Info básica -->
<div class="ficha-hero">
    <div class="ficha-cover-wrapper">
        <span class="skeleton-label" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:rgba(255,255,255,0.4); font-size:14px; font-weight:500; text-transform:uppercase; letter-spacing:1px; pointer-events:none;">Carátula</span>
        <img id="ficha-cover"
             class="ficha-cover"
             alt="Carátula del juego"
             style="display:none; opacity:0; transition:opacity 0.2s ease-in-out;">
    </div>
    <div class="ficha-hero-info">
        <h1 id="ficha-title" class="loading-title">Cargando ficha...</h1>

        <!-- Estos empiezan ocultos -->
        <p class="ficha-platform" style="display:none;">ZX Spectrum</p>
        <p class="ficha-puntuacion" id="ficha-puntuacion" style="display:none;"></p>

        <div class="ficha-rating" style="display:none;">
            <span class="ficha-rating-stars" id="ficha-rating-stars">★★★★★</span>
        </div>
    </div>
</div>

<!-- SCREENSHOTS -->
<div class="ficha-screenshots" style="display:none;">
    <div class="screenshot-wrapper">
        <span class="skeleton-label" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:rgba(255,255,255,0.4); font-size:12px; font-weight:500; text-transform:uppercase; letter-spacing:1px; pointer-events:none;">Loading Screen</span>
        <img id="screenshot-1" class="screenshot-img" alt="Screenshot 1" style="display:none;">
    </div>
    <div class="screenshot-wrapper">
        <span class="skeleton-label" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:rgba(255,255,255,0.4); font-size:12px; font-weight:500; text-transform:uppercase; letter-spacing:1px; pointer-events:none;">Gameplay Screen</span>
        <img id="screenshot-2" class="screenshot-img" alt="Screenshot 2" style="display:none;">
    </div>
</div>

<!-- SECCIÓN FICHA -->
<div class="ficha-section">
    <h2 class="ficha-section-title">FICHA</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-datos" id="ficha-datos" style="display:none;">
        <!-- Los datos se rellenan por JS -->
    </div>
</div>

<!-- SECCIÓN SINOPSIS -->
<div class="ficha-section" id="sinopsis-section" style="display:none;">
    <h2 class="ficha-section-title">SINOPSIS</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-sinopsis" id="ficha-sinopsis">
        <!-- El texto se rellena por JS -->
    </div>
</div>

<!-- SECCIÓN DATOS TÉCNICOS -->
<div class="ficha-section" id="datos-tecnicos-section" style="display:none;">
    <h2 class="ficha-section-title">DATOS TÉCNICOS</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-datos ficha-datos-tecnicos" id="ficha-datos-tecnicos">
        <!-- Los datos se rellenan por JS -->
    </div>
</div>

   <!-- SECCIÓN GAMEPLAY -->
<div class="ficha-section ficha-section--flush" id="gameplay-section" style="display:none;">
    <h2 class="ficha-section-title">GAMEPLAY</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-gameplay" id="ficha-gameplay">
        <div class="ficha-gameplay-frame" id="ficha-gameplay-frame">
            <div class="ficha-gameplay-placeholder" id="ficha-gameplay-placeholder">
                <div class="ficha-gameplay-play"></div>
            </div>
        </div>
    </div>
</div>
 
    <!-- SECCIÓN IMÁGENES ADICIONALES -->
<div class="ficha-section ficha-section--flush" id="imagenes-section" style="display:none;">
    <h2 class="ficha-section-title">IMÁGENES</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-imagenes" id="ficha-imagenes">
        <div class="ficha-imagenes-frame" id="ficha-imagenes-frame">
            <img id="ficha-imagenes-img" class="ficha-imagenes-img" alt="Imagen adicional" style="display:none;">
        </div>
        <div class="ficha-imagenes-nav" id="ficha-imagenes-nav" style="display:none;">
            <img src="assets/img/ic_back.svg" class="ficha-imagenes-arrow ficha-imagenes-arrow--prev" alt="Anterior">
            <span class="ficha-imagenes-counter">
                <span id="imagenes-current">1</span> / <span id="imagenes-total">1</span>
            </span>
            <img src="assets/img/ic_back.svg" class="ficha-imagenes-arrow ficha-imagenes-arrow--next" alt="Siguiente">
        </div>
    </div>
</div>

<!-- SECCIÓN REVISTAS -->
<div class="ficha-section" id="revistas-section" style="display:none;">
    <h2 class="ficha-section-title">REVISTAS</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-revistas" id="ficha-revistas"></div>
</div>


   <!-- SECCIÓN ÚTILES -->
<div class="ficha-section" id="utiles-section" style="display:none;">
    <h2 class="ficha-section-title">ÚTILES</h2>
    <div class="ficha-section-line"></div>
    <div class="ficha-utiles" id="ficha-utiles">
            <div class="utiles-buttons-row">
            <div class="utiles-button" data-type="mapa">
                <div class="utiles-icon"></div>
                <div class="utiles-label">MAPA</div>
            </div>
            <div class="utiles-button" data-type="instrucciones">
                <div class="utiles-icon"></div>
                <div class="utiles-label">INSTRUCCIONES</div>
            </div>
            <div class="utiles-button" data-type="enlace">
                <div class="utiles-icon"></div>
                <div class="utiles-label">ENLACE</div>
            </div>
        </div>
    </div>
</div>


 
</main>

   <script>
    // ============================================
    // CONFIGURACIÓN DE CACHÉ Y PREFETCHING
    // ============================================
    const CACHE_DURATION = 30 * 60 * 1000; // 30 minutos
    const CACHE_VERSION = "v1";
    const PREFETCH_DELAY = 2000; // 2 segundos

    // ============================================
    // FUNCIONES DE CACHÉ
    // ============================================
    
    function getCachedData(key) {
        try {
            const cached = sessionStorage.getItem(key);
            if (!cached) return null;
            
            const data = JSON.parse(cached);
            const now = Date.now();
            
            if (now - data.timestamp > CACHE_DURATION) {
                sessionStorage.removeItem(key);
                return null;
            }
            
            return data.value;
        } catch {
            return null;
        }
    }

    function setCachedData(key, value) {
        try {
            sessionStorage.setItem(key, JSON.stringify({
                timestamp: Date.now(),
                version: CACHE_VERSION,
                value: value
            }));
        } catch (e) {
            console.warn("No se pudo guardar en caché:", e);
        }
    }

    // Caché de fichas individuales
    function getCachedFicha(gameId) {
        const key = `ficha_spectrum_${gameId}`;
        return getCachedData(key);
    }

    function setCachedFicha(gameId, gameData) {
        const key = `ficha_spectrum_${gameId}`;
        setCachedData(key, gameData);
    }

    // ============================================
    // CONFIGURACIÓN
    // ============================================
    const ZX_SPECTRUM_CSV_URL = 
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1890916807&single=true&output=csv";

    // URL del CSV de colección completa (para navegación desde coleccion.html)
    const COLECCION_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQbmbDObrrqQMmeAM2zMIYNzMFRW8Hqf3_lEfmQh-K1carYW-Q7s66Wvum2XEepYJMVaJGswnUuxG4w/pub?gid=1929298971&single=true&output=csv";

    // Lista ordenada de juegos para navegación
    let sortedGamesList = [];
    let currentGameIndex = -1;
       
    // Imágenes adicionales
    let additionalImages = [];
    let additionalImageIndex = 0;
    let additionalImagesKeydownBound = false;
    let modalAbierta = false;
    let currentGroupLabel = "";

    // Variable global para compartir datos
    let allGamesData = [];

    // Función para volver a la lista
    function goBackToList() {
      const params = new URLSearchParams(window.location.search);
      const fromColeccion = params.get("from") === "coleccion";
      
      // Si viene de colección, volver a coleccion.html
      if (fromColeccion) {
        window.location.href = "coleccion.html";
        return;
      }
      
      // Si no, volver a la lista de Spectrum
      window.location.href = "spectrum-lista.html";
    }

    // ============================================
    // UTILIDADES
    // ============================================
    
    function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const ch = line[i];

            if (ch === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (ch === "," && !inQuotes) {
                result.push(current.trim());
                current = "";
            } else {
                current += ch;
            }
        }

        result.push(current.trim());
        return result;
    }

    function findColumnIndex(header, names) {
        for (const name of names) {
            const idx = header.indexOf(name);
            if (idx >= 0) return idx;
        }
        return -1;
    }

    function getColumnValue(cols, idx) {
        return idx >= 0 && cols[idx] !== undefined ? cols[idx].trim() : "";
    }
       
function normalizeUrlValue(value) {
        const trimmed = (value || "").trim();
        return trimmed ? trimmed : "";
    }

    function formatTitleWithArticle(title) {
        if (!title) return "";
        const t = title.trim();
        const re = /^(the|a|an|el|la|los|las|lo)\s+(.*)$/i;
        const match = t.match(re);
        if (!match) return t;
        return match[2] + ", " + match[1];
    }

    function normalizeText(str) {
    return (str || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
}

// ============================================
// PARSER CSV GENERAL (soporta saltos de línea dentro de comillas)
// ============================================
function parseCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentField = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const ch = text[i];

        if (ch === '"') {
            if (inQuotes && text[i + 1] === '"') {
                currentField += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (ch === "," && !inQuotes) {
            currentRow.push(currentField.trim());
            currentField = "";
        } else if ((ch === "\n" || ch === "\r") && !inQuotes) {
            if (ch === "\r" && text[i + 1] === "\n") {
                i++;
            }
            currentRow.push(currentField.trim());
            if (currentRow.some(v => v !== "")) {
                rows.push(currentRow);
            }
            currentRow = [];
            currentField = "";
        } else {
            currentField += ch;
        }
    }

    if (currentField.length > 0 || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.some(v => v !== "")) {
            rows.push(currentRow);
        }
    }

    return rows;
}

       function parseAdditionalImagesList(text) {
    return (text || "")
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(line => line !== "");
}

function parseRevistasList(text) {
    return (text || "")
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(line => line !== "")
        .map(line => {
            const markdownMatch = line.match(/^\s*\[([^\]]+)\]\(([^)]+)\)\s*$/);
            if (markdownMatch) {
                return {
                    texto: markdownMatch[1].trim(),
                    url: markdownMatch[2].trim()
                };
            }

            return {
                texto: line,
                url: ""
            };
        })
        .filter(entry => entry.texto);
}

       
// ============================================
// PARSER CSV - FICHA (datos completos) con soporte de filas partidas
// ============================================
function parseSpectrumCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return [];

    const header = parseCSVLine(lines[0]);
    const expectedCols = header.length;
    const rows = [];

    const idxID = header.indexOf("ID");
    const idxTit = findColumnIndex(header, ["TITULO_MOSTRAR", "TÍTULO", "TITULO"]);
    const idxPub = header.indexOf("PUBLISHER_MOSTRAR");
    const idxAnio = header.indexOf("AÑO_MOSTRAR");
    const idxCaratula = findColumnIndex(header, ["CARÁTULA", "CARATULA"]);
    const idxImgAdic = findColumnIndex(header, [
        "IMÁGENES",
        "IMAGENES",
        "IMAGENES_ADICIONALES",
        "IMÁGENES_ADICIONALES"
    ]);
    const idxPuntuacion = findColumnIndex(header, ["PUNTUACIÓN", "PUNTUACION"]);
    const idxScreenshots = findColumnIndex(header, ["SCREENSHOTS"]);
    
    // Nuevos campos para la sección FICHA
    const idxAnioFicha = findColumnIndex(header, ["AÑO"]);
    const idxEditor = findColumnIndex(header, ["PUBLISHER"]);
    const idxDesarrollo = findColumnIndex(header, ["DESARROLLADOR"]);
    const idxAutor = findColumnIndex(header, ["AUTOR"]);
    const idxContribuciones = findColumnIndex(header, ["CONTRIBUCIONES"]);
    const idxGenero = findColumnIndex(header, ["GÉNERO", "GENERO"]);
    const idxSubgenero = findColumnIndex(header, ["SUBGÉNERO", "SUBGENERO"]);
    const idxDistribuidoras = findColumnIndex(header, ["DISTRIBUIDORAS"]);
    const idxSinopsis = findColumnIndex(header, ["SINOPSIS"]);
    const idxJugadores = findColumnIndex(header, ["JUGADORES"]);
    const idxControles = findColumnIndex(header, ["CONTROLES"]);
    const idxVersion = findColumnIndex(header, ["VERSIÓN", "VERSION"]);
    const idxFormato = findColumnIndex(header, ["FORMATO"]);
    const idxZx2a = findColumnIndex(header, ["ZX +2A", "ZX+2A"]);
    const idxTspec = findColumnIndex(header, ["TSPEC"]);
    const idxTerminado = findColumnIndex(header, ["TERMINADO"]);
    const idxFavorito = findColumnIndex(header, ["FAVORITO"]);
    const idxVideo = findColumnIndex(header, ["VIDEO"]);
    const idxRevistas = findColumnIndex(header, ["REVISTAS"]);
    const idxMapa = findColumnIndex(header, ["MAPA"]);
    const idxInstrucciones = findColumnIndex(header, ["INSTRUCCIONES"]);
    const idxEnlace = findColumnIndex(header, ["LINK"]);

    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;

        let rawLine = lines[i];
        let cols = parseCSVLine(rawLine);

        while (cols.length < expectedCols && i + 1 < lines.length) {
            rawLine += "\n" + lines[i + 1];
            i++;
            cols = parseCSVLine(rawLine);
        }

        const thisId = getColumnValue(cols, idxID);
        const rawAdditionalImages = getColumnValue(cols, idxImgAdic);
        const additionalImagesList = parseAdditionalImagesList(rawAdditionalImages);

        rows.push({
            id: thisId,
            titulo: getColumnValue(cols, idxTit),
            pub: getColumnValue(cols, idxPub),
            anio: getColumnValue(cols, idxAnio),
            caratula: getColumnValue(cols, idxCaratula),
            imagenesAdicionales: rawAdditionalImages,
            imagenesArray: additionalImagesList,
            puntuacion: getColumnValue(cols, idxPuntuacion),
            screenshots: getColumnValue(cols, idxScreenshots),
            anioFicha: getColumnValue(cols, idxAnioFicha),
            editor: getColumnValue(cols, idxEditor),
            desarrollo: getColumnValue(cols, idxDesarrollo),
            autor: getColumnValue(cols, idxAutor),
            contribuciones: getColumnValue(cols, idxContribuciones),
            genero: getColumnValue(cols, idxGenero),
            subgenero: getColumnValue(cols, idxSubgenero),
            distribuidoras: getColumnValue(cols, idxDistribuidoras),
            sinopsis: getColumnValue(cols, idxSinopsis),
            jugadores: getColumnValue(cols, idxJugadores),
            controles: getColumnValue(cols, idxControles),
            version: getColumnValue(cols, idxVersion),
            formato: getColumnValue(cols, idxFormato),
            zx2a: getColumnValue(cols, idxZx2a),
            tspec: getColumnValue(cols, idxTspec),
            terminado: getColumnValue(cols, idxTerminado),
            favorito: getColumnValue(cols, idxFavorito),
            videoUrl: getColumnValue(cols, idxVideo),
            revistasTexto: getColumnValue(cols, idxRevistas),
            revistas: parseRevistasList(getColumnValue(cols, idxRevistas)),
            mapaUrl: normalizeUrlValue(getColumnValue(cols, idxMapa)),
            instruccionesUrl: normalizeUrlValue(getColumnValue(cols, idxInstrucciones)),
            enlaceUrl: normalizeUrlValue(getColumnValue(cols, idxEnlace))
        });
    }

    return rows;
}

// ============================================
// PARSER CSV - COLECCIÓN (para navegación desde coleccion.html)
// ============================================
function parseColeccionCSV(text) {
    const rows = [];
    let currentRow = [];
    let currentField = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
        const ch = text[i];

        if (ch === '"') {
            if (inQuotes && text[i + 1] === '"') {
                currentField += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (ch === "," && !inQuotes) {
            currentRow.push(currentField.trim());
            currentField = "";
        } else if ((ch === "\n" || ch === "\r") && !inQuotes) {
            if (ch === "\r" && text[i + 1] === "\n") {
                i++;
            }
            currentRow.push(currentField.trim());
            if (currentRow.some(v => v !== "")) {
                rows.push(currentRow);
            }
            currentRow = [];
            currentField = "";
        } else {
            currentField += ch;
        }
    }

    if (currentField.length > 0 || currentRow.length > 0) {
        currentRow.push(currentField.trim());
        if (currentRow.some(v => v !== "")) {
            rows.push(currentRow);
        }
    }

    if (rows.length === 0) return [];

    const header = rows[0];
    const games = [];

    const idxID = header.indexOf("ID");
    const idxTitulo = header.indexOf("TITULO_MOSTRAR");
    const idxPlataforma = header.indexOf("PLATAFORMA");
    const idxAnio = header.indexOf("AÑO_MOSTRAR");
    const idxFavorito = header.indexOf("FAVORITO");
    const idxTerminado = header.indexOf("TERMINADO");
    const idxFormato = header.indexOf("FORMATO_MOSTRAR");
    const idxGenero = header.indexOf("GENERO_MOSTRAR");
    const idxSubgenero = header.indexOf("SUBGENERO_MOSTRAR");
    const idxPublisher = header.indexOf("PUBLISHER_MOSTRAR");
    const idxDesarrollo = header.indexOf("DESARROLLO_MOSTRAR");

    for (let i = 1; i < rows.length; i++) {
        const cols = rows[i];
        const id = idxID >= 0 && cols[idxID] ? cols[idxID].trim() : "";
        const titulo = idxTitulo >= 0 && cols[idxTitulo] ? cols[idxTitulo].trim() : "";

        if (!titulo) continue;

        const displayTitulo = formatTitleWithArticle(titulo);

        games.push({
            id,
            titulo,
            displayTitulo,
            sortKey: displayTitulo.toLowerCase(),
            plataforma: idxPlataforma >= 0 && cols[idxPlataforma] ? cols[idxPlataforma].trim() : "",
            anio: idxAnio >= 0 && cols[idxAnio] ? cols[idxAnio].trim() : "",
            favorito: idxFavorito >= 0 && cols[idxFavorito] ? cols[idxFavorito].trim() : "",
            terminado: idxTerminado >= 0 && cols[idxTerminado] ? cols[idxTerminado].trim() : "",
            formato: idxFormato >= 0 && cols[idxFormato] ? cols[idxFormato].trim() : "",
            genero: idxGenero >= 0 && cols[idxGenero] ? cols[idxGenero].trim() : "",
            subgenero: idxSubgenero >= 0 && cols[idxSubgenero] ? cols[idxSubgenero].trim() : "",
            pub: idxPublisher >= 0 && cols[idxPublisher] ? cols[idxPublisher].trim() : "",
            desarrollo: idxDesarrollo >= 0 && cols[idxDesarrollo] ? cols[idxDesarrollo].trim() : ""
        });
    }

    return games;
}

    // ============================================
    // EXTRACCIÓN DE CARÁTULA
    // ============================================
    
    function extractURLs(text) {
        const urlRegex = /https?:\/\/[^\s,]+/g;
        const urls = [];
        let match;

        while ((match = urlRegex.exec(text)) !== null) {
            const cleanUrl = match[0].replace(/["',]+$/g, "");
            urls.push({
                url: cleanUrl,
                index: match.index
            });
        }

        return urls;
    }

    function findBestCover(imagenesText) {
        const urls = extractURLs(imagenesText);
        if (urls.length === 0) return "";

        let bestUrl = urls[0].url;

        for (const item of urls) {
            const contextStart = Math.max(0, item.index - 80);
            const context = imagenesText
                .slice(contextStart, item.index)
                .toLowerCase();

            if (context.includes("inlay") && context.includes("front")) {
                bestUrl = item.url;
                break;
            }
        }

        return bestUrl;
    }

    function getCoverURL(game) {
        if (game.caratula) {
            return game.caratula;
        }

        if (game.imagenesAdicionales) {
            return findBestCover(game.imagenesAdicionales);
        }

        return "";
    }

       function getYouTubeThumbnail(embedUrl) {
        if (!embedUrl) return "";
        const match = embedUrl.match(/embed\/([^?&#\/]+)/);
        if (match && match[1]) {
            return `https://img.youtube.com/vi/${match[1]}/hqdefault.jpg`;
        }
        return "";
    }


    // ============================================
    // ACTUALIZACIÓN DE UI
    // ============================================
    
function updateTitle(game) {
    const title = game.titulo || "Juego ZX Spectrum";
    document.title = `${title} – ZX Spectrum`;

    const h1 = document.getElementById("ficha-title");
    if (h1) {
        h1.textContent = title;
        h1.classList.remove("loading-title");
    }

    const platformEl = document.querySelector(".ficha-platform");
    if (platformEl) {
        platformEl.style.display = "block";
    }

    const fichaSection = document.querySelector(".ficha-section");
    if (fichaSection) {
        fichaSection.style.display = "block";
    }

    document.body.classList.remove("loading");
}

function updateCover(game) {
    const coverImg = document.getElementById("ficha-cover");
    const wrapper = document.querySelector(".ficha-cover-wrapper");
    if (!coverImg || !wrapper) return;

  const fallbackCover = "assets/img/CaratulaNoDisponible.png";
    const coverUrl = (getCoverURL(game) || "").trim();
    const hasValidCover = coverUrl && coverUrl.toLowerCase() !== "null";
    const finalCoverUrl = hasValidCover ? coverUrl : fallbackCover;

    coverImg.style.opacity = "0";
    coverImg.style.display = "block";

    coverImg.onload = function() {
        const naturalW = coverImg.naturalWidth;
        const naturalH = coverImg.naturalHeight;
        const aspectRatio = naturalW / naturalH;

        const wrapperWidth = wrapper.offsetWidth;
        const wrapperHeight = wrapper.offsetHeight;
        const targetRatio = wrapperWidth / wrapperHeight;

        const scaledWidth = wrapperHeight * aspectRatio;
        const squeezeRatio = 0.97;

        const ratioDiff = Math.abs(aspectRatio - targetRatio) / targetRatio;
        const isMatchingRatio = ratioDiff < 0.03;

        if (scaledWidth < wrapperWidth || isMatchingRatio) {
            coverImg.style.width = "100%";
            coverImg.style.height = "100%";
            coverImg.style.objectFit = "fill";
            coverImg.style.left = "auto";
            coverImg.style.right = "0";
            coverImg.style.transform = "none";
        } else if (aspectRatio > targetRatio) {
            const compressedWidth = scaledWidth * squeezeRatio;
            coverImg.style.width = compressedWidth + "px";
            coverImg.style.height = "100%";
            coverImg.style.objectFit = "fill";
            coverImg.style.left = "auto";
            coverImg.style.right = "0";
            coverImg.style.transform = "none";
        } else {
            coverImg.style.width = "auto";
            coverImg.style.height = "100%";
            coverImg.style.objectFit = "cover";
            coverImg.style.left = "auto";
            coverImg.style.right = "0";
            coverImg.style.transform = "none";
        }
        
        coverImg.style.opacity = "1";
        const coverLabel = wrapper.querySelector(".skeleton-label");
        if (coverLabel) coverLabel.style.display = "none";
        wrapper.classList.add("loaded");
    };

       coverImg.onerror = function() {
        const fallbackAbsolute = new URL(fallbackCover, window.location.href).href;
        if (coverImg.src !== fallbackAbsolute) {
            coverImg.onerror = null;
            coverImg.src = fallbackCover;
        }
    };

       coverImg.src = finalCoverUrl;
    coverImg.alt = `Carátula de ${game.titulo || "juego ZX Spectrum"}`;
    coverImg.style.display = "block";

    const isFavorito = (game.favorito || "").trim().toUpperCase() === "SI";
    const existingStar = wrapper.querySelector(".ficha-favorito-star");
    
    if (isFavorito && !existingStar) {
        const star = document.createElement("img");
        star.src = "assets/img/ic_favorito.svg";
        star.alt = "Favorito";
        star.className = "ficha-favorito-star";
        wrapper.appendChild(star);
    } else if (!isFavorito && existingStar) {
        existingStar.remove();
    }
}

function updatePuntuacion(game) {
    const puntuacionEl = document.getElementById("ficha-puntuacion");
    const ratingEl = document.querySelector(".ficha-rating");
    const starsEl = document.getElementById("ficha-rating-stars");
    if (!puntuacionEl || !ratingEl || !starsEl) return;

    const valor = (game.puntuacion || "").trim();

    if (valor) {
        puntuacionEl.innerHTML = `<b>Puntuación:</b> ${valor}`;
        puntuacionEl.style.display = "block";
        ratingEl.style.display = "flex";

        const match = valor.match(/^(\d+[.,]?\d*)/);
        let nota = 0;
        if (match) {
            nota = parseFloat(match[1].replace(",", "."));
        }

        if (isNaN(nota)) nota = 0;
        if (nota < 0) nota = 0;
        if (nota > 10) nota = 10;

        const porcentaje = (nota / 10) * 100;

        let color = "#ff4b4b";
        if (nota >= 7) {
            color = "#00c853";
        } else if (nota >= 5) {
            color = "#ffd600";
        }

        starsEl.style.setProperty("--fill", "0%");
        starsEl.style.setProperty("--rating-color", color);
        void starsEl.offsetWidth;
        starsEl.style.setProperty("--fill", porcentaje + "%");

    } else {
        puntuacionEl.innerHTML = "";
        puntuacionEl.style.display = "none";
        ratingEl.style.display = "none";
        starsEl.style.setProperty("--fill", "0%");
    }
}

// ============================================
// SCREENSHOTS
// ============================================

function updateScreenshots(game) {
    const screenshot1 = document.getElementById("screenshot-1");
    const screenshot2 = document.getElementById("screenshot-2");
    const wrapper1 = screenshot1?.parentElement;
    const wrapper2 = screenshot2?.parentElement;
    const container = document.querySelector(".ficha-screenshots");

    if (!screenshot1 || !screenshot2 || !container) return;

    const screenshotsRaw = (game.screenshots || "").trim();
    const startsWithSkip = screenshotsRaw.startsWith("--");
    const parts = screenshotsRaw
        ? screenshotsRaw.split(",").map(u => u.trim())
        : [];

    let screenshot1Url = "";
    let screenshot2Url = "";

    if (startsWithSkip) {
        const [, ...rest] = parts;
        const remainingUrls = rest.filter(u => u && u !== "--");
        screenshot2Url = remainingUrls[0] || "";
    } else {
        const validUrls = parts.filter(u => u);
        screenshot1Url = validUrls[0] || "";
        screenshot2Url = validUrls[1] || "";
    }
    
    if (screenshot1Url || screenshot2Url) {
        container.style.display = "flex";
    } else {
        container.style.display = "none";
        return;
    }

    if (screenshot1Url) {
        screenshot1.src = screenshot1Url;
        screenshot1.style.display = "block";
        screenshot1.onclick = () => openModal(screenshot1Url);
        wrapper1.classList.remove("empty");
        const label1 = wrapper1.querySelector(".skeleton-label");
        if (label1) label1.style.display = "none";
    } else {
        screenshot1.style.display = "none";
        wrapper1.classList.add("empty");
    }

    if (screenshot2Url) {
        screenshot2.src = screenshot2Url;
        screenshot2.style.display = "block";
        screenshot2.onclick = () => openModal(screenshot2Url);
        wrapper2.classList.remove("empty");
        const label2 = wrapper2.querySelector(".skeleton-label");
        if (label2) label2.style.display = "none";
    } else {
        screenshot2.style.display = "none";
        wrapper2.classList.add("empty");
    }
}

function openModal(src) {
    const modal = document.getElementById("cover-modal");
    const modalImg = document.getElementById("cover-modal-img");
    if (modal && modalImg) {
        modalImg.src = src;
        modal.classList.add("active");
    }
}

// ============================================
// DATOS DE LA FICHA
// ============================================
function updateFichaDatos(game) {
    const container = document.getElementById("ficha-datos");
    if (!container) return;

    const campos = [
        { label: "· AÑO", value: game.anioFicha },
        { label: "· EDITOR", value: game.editor },
        { label: "· DESARROLLO", value: game.desarrollo },
        { label: "· AUTOR", value: game.autor },
        { label: "· CONTRIBUCIONES", value: game.contribuciones },
        { label: "· GÉNERO", value: game.genero },
        { label: "· SUBGÉNERO", value: game.subgenero },
        { label: "· DISTRIBUIDORAS", value: game.distribuidoras }
    ];

    const camposConValor = campos.filter(c => c.value && c.value.trim() !== "");

    if (camposConValor.length === 0) {
        container.style.display = "none";
        return;
    }

    let html = "";
    camposConValor.forEach(campo => {
        html += `<p class="ficha-dato"><span class="ficha-dato-label">${campo.label}:</span> ${campo.value}</p>`;
    });

    container.innerHTML = html;
    container.style.display = "block";
}

// ============================================
// SINOPSIS CON VOZ
// ============================================
let sinopsisVoiceButton = null;
let sinopsisVoiceOnIcon = null;
let sinopsisVoiceOffIcon = null;
let currentUtterance = null;
let isReadingSinopsis = false;
const speechSupported =
    typeof window !== "undefined" &&
    "speechSynthesis" in window &&
    typeof SpeechSynthesisUtterance !== "undefined";

function resetVoiceIcons() {
    if (!sinopsisVoiceButton) return;
    if (sinopsisVoiceOnIcon && sinopsisVoiceOffIcon) {
        sinopsisVoiceOnIcon.style.display = isReadingSinopsis ? "none" : "block";
        sinopsisVoiceOffIcon.style.display = isReadingSinopsis ? "block" : "none";
    }
}

function stopSynopsisVoice() {
    if (!speechSupported) return;
    window.speechSynthesis.cancel();
    currentUtterance = null;
    isReadingSinopsis = false;
    resetVoiceIcons();
}

function getPreferredSpanishVoice() {
    if (!speechSupported) return null;
    const voices = window.speechSynthesis.getVoices();
    if (!voices || !voices.length) return null;

    const preferred = voices.find(voice =>
        voice.lang && voice.lang.toLowerCase().startsWith("es-es")
    );
    if (preferred) return preferred;

    const anySpanish = voices.find(voice => voice.lang && voice.lang.toLowerCase().startsWith("es"));
    return anySpanish || voices[0];
}

function handleVoiceEnd() {
    isReadingSinopsis = false;
    currentUtterance = null;
    resetVoiceIcons();
}

function startSynopsisVoice() {
    if (!speechSupported) return;
    const text = getSynopsisText();
    if (!text) return;

    stopSynopsisVoice();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "es-ES";
    utterance.rate = 1;
    utterance.volume = 1;
    const voice = getPreferredSpanishVoice();
    if (voice) {
        utterance.voice = voice;
    }
    utterance.onend = handleVoiceEnd;
    utterance.onerror = handleVoiceEnd;

    currentUtterance = utterance;
    isReadingSinopsis = true;
    resetVoiceIcons();
    window.speechSynthesis.speak(utterance);
}

function toggleSynopsisVoice() {
    if (!speechSupported) return;
    if (isReadingSinopsis) {
        stopSynopsisVoice();
    } else {
        startSynopsisVoice();
    }
}

function setupVoiceButton() {
    if (!sinopsisVoiceButton || !speechSupported) return;
    sinopsisVoiceButton.addEventListener("click", toggleSynopsisVoice);
}

function renderVoiceButton(container) {
    sinopsisVoiceButton = document.createElement("button");
    sinopsisVoiceButton.type = "button";
    sinopsisVoiceButton.className = "sinopsis-voice-button";
    sinopsisVoiceButton.setAttribute("aria-label", "Leer sinopsis en voz alta");

    sinopsisVoiceOnIcon = document.createElement("img");
    sinopsisVoiceOnIcon.src = "assets/img/ic_voz_ON.svg";
    sinopsisVoiceOnIcon.alt = "Reproducir voz";
    sinopsisVoiceOnIcon.className = "sinopsis-voice-icon sinopsis-voice-icon--on";

    sinopsisVoiceOffIcon = document.createElement("img");
    sinopsisVoiceOffIcon.src = "assets/img/ic_voz_OFF.svg";
    sinopsisVoiceOffIcon.alt = "Detener voz";
    sinopsisVoiceOffIcon.className = "sinopsis-voice-icon sinopsis-voice-icon--off";

    sinopsisVoiceButton.appendChild(sinopsisVoiceOnIcon);
    sinopsisVoiceButton.appendChild(sinopsisVoiceOffIcon);
    container.appendChild(sinopsisVoiceButton);
    resetVoiceIcons();

    if (!speechSupported) {
        sinopsisVoiceButton.style.display = "none";
        return;
    }

    setupVoiceButton();
}

function getSynopsisText() {
    const textEl = document.querySelector(".ficha-sinopsis-texto");
    return textEl ? textEl.textContent.trim() : "";
}

function updateSinopsis(game) {
    const section = document.getElementById("sinopsis-section");
    const container = document.getElementById("ficha-sinopsis");
    if (!section || !container) return;

    const sinopsis = (game.sinopsis || "").trim();

    if (!sinopsis) {
        section.style.display = "none";
        return;
    }

    const textParagraph = document.createElement("p");
    textParagraph.className = "ficha-sinopsis-texto";
    textParagraph.textContent = sinopsis;
    container.appendChild(textParagraph);
    renderVoiceButton(container);
    
    section.style.display = "block";
}


// ============================================
// DATOS TÉCNICOS
// ============================================
function updateDatosTecnicos(game) {
    const section = document.getElementById("datos-tecnicos-section");
    const container = document.getElementById("ficha-datos-tecnicos");
    if (!section || !container) return;

    const getStatusClass = (label, value) => {
        const normalized = (value || "")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");

        const isCompatibilityField =
            label.includes("ZX +2A") || label.includes("THE SPECTRUM");
            const isCompletionField = label.includes("TERMINADO");

        if (!isCompatibilityField && !isCompletionField) return "";

        if (normalized === "no probado" && isCompatibilityField) return "status status--pending";
        if (normalized === "no") return "status status--no";
        if (normalized === "si") return "status status--yes";

        return "";
    };
    
    const campos = [
        { label: "· JUGADORES", value: game.jugadores },
        { label: "· CONTROLES", value: game.controles },
        { label: "· VERSIÓN", value: game.version },
        { label: "· FORMATO", value: game.formato },
        { label: "· ZX +2A", value: game.zx2a },
        { label: "· THE SPECTRUM", value: game.tspec },
        { label: "· TERMINADO", value: game.terminado }
    ];

    const camposConValor = campos.filter(campo => campo.value && campo.value.trim() !== "");

    if (!camposConValor.length) {
        section.style.display = "none";
        return;
    }

    const html = camposConValor
        .map(campo => {
            const statusClass = getStatusClass(campo.label, campo.value);
            const valueHtml = statusClass
                ? `<span class="${statusClass}">${campo.value}</span>`
                : campo.value;

            return `<p class="ficha-dato"><span class="ficha-dato-label">${campo.label}:</span> ${valueHtml}</p>`;
        })
        .join("");

    container.innerHTML = html;
    section.style.display = "block";
}

// ============================================
// GAMEPLAY
// ============================================
function updateGameplay(game) {
    const section = document.getElementById("gameplay-section");
    const frame = document.getElementById("ficha-gameplay-frame");
    const placeholder = document.getElementById("ficha-gameplay-placeholder");

    if (!section || !frame || !placeholder) return;

    const videoUrl = (game.videoUrl || "").trim();

    if (!videoUrl) {
        section.style.display = "none";
        return;
    }

    const thumbnail = getYouTubeThumbnail(videoUrl);
    if (thumbnail) {
        placeholder.style.backgroundImage = `url('${thumbnail}')`;
    } else {
        placeholder.style.backgroundImage = "";
    }

    if (!placeholder.dataset.bound) {
        placeholder.dataset.bound = "true";
        placeholder.addEventListener("click", () => {
            const iframe = document.createElement("iframe");
            const separator = videoUrl.includes("?") ? "&" : "?";
            iframe.src = `${videoUrl}${separator}autoplay=1`;
            iframe.className = "ficha-gameplay-iframe";
            iframe.title = "Gameplay";
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
            iframe.allowFullscreen = true;
            iframe.loading = "lazy";

            frame.innerHTML = "";
            frame.appendChild(iframe);
        });
    }

    section.style.display = "block";
}

// ============================================
// IMÁGENES ADICIONALES
// ============================================
function renderAdditionalImage() {
    if (!additionalImages.length) return;

    const imgEl = document.getElementById("ficha-imagenes-img");
    const counterCurrent = document.getElementById("imagenes-current");
    const counterTotal = document.getElementById("imagenes-total");
    const modal = document.getElementById("imagenes-modal");
    const modalImg = document.getElementById("imagenes-modal-img");

    if (!imgEl || !counterCurrent || !counterTotal) return;

    const url = additionalImages[additionalImageIndex];

    imgEl.src = url;
    imgEl.style.display = "block";
    counterCurrent.textContent = (additionalImageIndex + 1).toString();
    counterTotal.textContent = additionalImages.length.toString();

    if (modal && modal.classList.contains("active") && modalImg) {
        modalImg.src = url;
    }
}

function changeAdditionalImage(step) {
    if (!additionalImages.length) return;

    additionalImageIndex = (additionalImageIndex + step + additionalImages.length) % additionalImages.length;
    renderAdditionalImage();
    modalAbierta = true;
}

function openAdditionalImagesModal() {
    const modal = document.getElementById("imagenes-modal");
    if (!modal || !additionalImages.length) return;

    modal.classList.add("active");
    renderAdditionalImage();
}

function closeAdditionalImagesModal() {
    const modal = document.getElementById("imagenes-modal");
    if (modal) {
        modal.classList.remove("active");
    }
    modalAbierta = false;
}

function setupAdditionalImagesModalControls() {
    const modal = document.getElementById("imagenes-modal");
    const closeBtn = document.querySelector(".imagenes-modal-close");
    const prevArrow = document.querySelector(".imagenes-modal-arrow--prev");
    const nextArrow = document.querySelector(".imagenes-modal-arrow--next");

    if (closeBtn && !closeBtn.dataset.bound) {
        closeBtn.dataset.bound = "true";
        closeBtn.addEventListener("click", closeAdditionalImagesModal);
    }

    if (modal && !modal.dataset.bound) {
        modal.dataset.bound = "true";
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                closeAdditionalImagesModal();
            }
        });

        ["touchstart", "touchmove", "touchend"].forEach(eventName => {
            modal.addEventListener(eventName, (e) => {
                e.stopPropagation();
            }, { passive: true });
        });
    }

    if (prevArrow && !prevArrow.dataset.bound) {
        prevArrow.dataset.bound = "true";
        prevArrow.addEventListener("click", () => changeAdditionalImage(-1));
    }

    if (nextArrow && !nextArrow.dataset.bound) {
        nextArrow.dataset.bound = "true";
        nextArrow.addEventListener("click", () => changeAdditionalImage(1));
    }

    if (!additionalImagesKeydownBound) {
        additionalImagesKeydownBound = true;
        document.addEventListener("keydown", (e) => {
            if (!modal || !modal.classList.contains("active")) return;

            if (e.key === "Escape") {
                closeAdditionalImagesModal();
            } else if (e.key === "ArrowLeft") {
                changeAdditionalImage(-1);
            } else if (e.key === "ArrowRight") {
                changeAdditionalImage(1);
            }
        });
    }

    let touchStartX = 0;
    let touchEndX = 0;
    const minSwipeDistance = 40;

    if (modal && !modal.dataset.swipeBound) {
        modal.dataset.swipeBound = "true";
        modal.addEventListener("touchstart", (e) => {
            e.stopPropagation();
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        modal.addEventListener("touchend", (e) => {
            e.stopPropagation();
            touchEndX = e.changedTouches[0].screenX;
            const distance = touchEndX - touchStartX;

            if (Math.abs(distance) < minSwipeDistance) return;

            if (distance < 0) {
                changeAdditionalImage(1);
            } else {
                changeAdditionalImage(-1);
            }
        }, { passive: true });
    }
}

function updateImagenesAdicionales(game) {
    const section = document.getElementById("imagenes-section");
    const nav = document.getElementById("ficha-imagenes-nav");
    const imgEl = document.getElementById("ficha-imagenes-img");
    if (!section || !nav || !imgEl) return;

    additionalImages = Array.isArray(game.imagenesArray)
        ? game.imagenesArray
        : parseAdditionalImagesList(game.imagenesAdicionales);
    additionalImageIndex = 0;

    if (!additionalImages.length) {
        section.style.display = "none";
        nav.style.display = "none";
        imgEl.style.display = "none";
        return;
    }

    const prevArrow = nav.querySelector(".ficha-imagenes-arrow--prev");
    const nextArrow = nav.querySelector(".ficha-imagenes-arrow--next");

    section.style.display = "block";
    nav.style.display = "flex";
    imgEl.style.display = "block";

    if (prevArrow && !prevArrow.dataset.bound) {
        prevArrow.dataset.bound = "true";
        prevArrow.addEventListener("click", () => changeAdditionalImage(-1));
    }

    if (nextArrow && !nextArrow.dataset.bound) {
        nextArrow.dataset.bound = "true";
        nextArrow.addEventListener("click", () => changeAdditionalImage(1));
    }

    if (!imgEl.dataset.bound) {
        imgEl.dataset.bound = "true";
        imgEl.addEventListener("click", openAdditionalImagesModal);
    }

    setupAdditionalImagesModalControls();
    renderAdditionalImage();
}

function splitRevistaTexto(texto) {
    const separator = " - ";
    const idx = texto.indexOf(separator);

    if (idx >= 0) {
        return {
            titulo: texto.slice(0, idx).trim(),
            detalle: texto.slice(idx + separator.length).trim()
        };
    }

    return {
        titulo: (texto || "").trim(),
        detalle: ""
    };
}

function updateRevistas(game) {
    const section = document.getElementById("revistas-section");
    const container = document.getElementById("ficha-revistas");
    if (!section || !container) return;

    const revistas = Array.isArray(game.revistas)
        ? game.revistas
        : parseRevistasList(game.revistasTexto);

    const revistasValidas = (revistas || []).filter(entry => entry && entry.texto);

    if (!revistasValidas.length) {
        section.style.display = "none";
        container.innerHTML = "";
        return;
    }

    container.innerHTML = "";

    revistasValidas.forEach((entry) => {
        const { titulo, detalle } = splitRevistaTexto(entry.texto || "");

        const linea = document.createElement("p");
        linea.className = "ficha-revista-item";

        const enlace = entry.url ? document.createElement("a") : document.createElement("span");
        enlace.className = "ficha-revista-link";
        if (entry.url) {
            enlace.href = entry.url;
            enlace.target = "_blank";
            enlace.rel = "noopener noreferrer";
        }

        enlace.appendChild(document.createTextNode("· "));

        const strong = document.createElement("strong");
        strong.textContent = titulo;
        enlace.appendChild(strong);

        if (detalle) {
            enlace.appendChild(document.createTextNode(` – ${detalle}`));
        }

        linea.appendChild(enlace);
        container.appendChild(linea);
    });

    section.style.display = "block";
}

       function updateUtiles(game) {
    const section = document.getElementById("utiles-section");
    const container = document.getElementById("ficha-utiles");
    if (!section || !container) return;

    const items = [
        { key: "mapa", label: "MAPA", url: game.mapaUrl },
        { key: "instrucciones", label: "INSTRUCCIONES", url: game.instruccionesUrl },
        { key: "enlace", label: "ENLACE", url: game.enlaceUrl }
    ];

    container.innerHTML = "";

    const row = document.createElement("div");
    row.className = "utiles-buttons-row";

    items.forEach(item => {
        const hasUrl = !!(item.url && item.url.trim());
        const element = document.createElement(hasUrl ? "a" : "div");
        element.className = "utiles-button " + (hasUrl ? "utiles-button--active" : "utiles-button--inactive");
        element.dataset.type = item.key;

        if (hasUrl) {
            element.href = item.url;
            element.target = "_blank";
            element.rel = "noopener noreferrer";
        }

        const circle = document.createElement("div");
        circle.className = "utiles-icon";

        const label = document.createElement("div");
        label.className = "utiles-label";
        label.textContent = item.label;

        element.appendChild(circle);
        element.appendChild(label);
        row.appendChild(element);
        
        if (hasUrl) {
            const setPressed = () => element.classList.add("is-pressed");
            const clearPressed = () => {
                element.classList.remove("is-pressed");
                element.blur();
            };

            element.addEventListener("pointerdown", setPressed);
            ["pointerup", "pointerleave", "pointercancel", "lostpointercapture", "blur"].forEach(evt => {
                element.addEventListener(evt, clearPressed);
            });

            element.addEventListener("click", () => {
                setTimeout(() => {
                    element.classList.remove("is-pressed");
                    element.blur();
                }, 100);
            });
        }
    });

    container.appendChild(row);
    section.style.display = "block";
}


    function showError(message) {
        const h1 = document.getElementById("ficha-title");
        if (h1) {
            h1.textContent = message;
        }
    }

    // ============================================
    // PREFETCHING DE FICHAS ADYACENTES
    // ============================================

    function prefetchAdjacentGames() {
        setTimeout(() => {
            const prevIndex = currentGameIndex - 1;
            const nextIndex = currentGameIndex + 1;
            
            if (prevIndex >= 0 && prevIndex < sortedGamesList.length) {
                const prevGame = sortedGamesList[prevIndex];
                prefetchGameData(prevGame.id);
            }
            
            if (nextIndex >= 0 && nextIndex < sortedGamesList.length) {
                const nextGame = sortedGamesList[nextIndex];
                prefetchGameData(nextGame.id);
            }
        }, PREFETCH_DELAY);
    }

    async function prefetchGameData(gameId) {
        const cached = getCachedFicha(gameId);
        if (cached) {
            return;
        }
        
        try {
            const cacheKey = `ficha_spectrum_${CACHE_VERSION}`;
            let games = getCachedData(cacheKey);
            
            if (!games) {
                const response = await fetch(ZX_SPECTRUM_CSV_URL);
                if (!response.ok) return;
                
                const text = await response.text();
                games = parseSpectrumCSV(text);
                setCachedData(cacheKey, games);
            }
            
            const game = games.find(row => row.id === gameId);
            if (game) {
                setCachedFicha(gameId, game);
            }
            
        } catch (err) {
            console.warn(`[Prefetch] Error precargando ${gameId}:`, err);
        }
    }

    // ============================================
    // NAVEGACIÓN ENTRE JUEGOS
    // ============================================

    function computeGroupLabel() {
    const filterField = (getQueryParam("filterField") || "").toLowerCase();
    const filterValue = (getQueryParam("filterValue") || "").trim();
    const searchQuery = getQueryParam("search");
    const fromColeccion = getQueryParam("from") === "coleccion";

    if (fromColeccion) {
        if (searchQuery) {
            const qNorm = normalizeText(searchQuery);
            const singleCharMatch = searchQuery.match(/^([a-zA-ZñÑáéíóúüÁÉÍÓÚÜ0-9])$/);
            if (singleCharMatch) {
                return `Letra ${searchQuery.toUpperCase()}`;
            }
            if (qNorm === "fav") return "Favoritos";
            if (qNorm === "terminado") return "Terminados";
            if (qNorm === "fisico") return "Formato Físico";
            
            // Verificar si es filtro de plataforma
            if (qNorm === "spectrum" || qNorm === "zx") return "Mi Colección";
            
            return `"${searchQuery}"`;
        }
        return "Mi Colección";
    }

    if (filterField === "subgenero" && filterValue) {
        return `Subgénero ${filterValue}`;
    }

    if (searchQuery) {
        const singleCharMatch = searchQuery.match(/^([a-zA-ZñÑáéíóúüÁÉÍÓÚÜ0-9])$/);
        if (singleCharMatch) {
            return `Letra ${searchQuery.toUpperCase()}`;
        }
        return `"${searchQuery}"`;
    }

    return "Juegos ZX Spectrum";
}

    // CORREGIDO: updateNavCounter con contexto y fallback
    function updateNavCounter() {
        const counterEl = document.querySelector(".game-nav-counter");
        const titleEl = document.querySelector(".game-nav-title");
        
        if (counterEl && currentGameIndex >= 0) {
            const position = currentGameIndex + 1;
            const total = sortedGamesList.length;
            const counterText = `${position.toLocaleString("es-ES")}/${total.toLocaleString("es-ES")}`;
            counterEl.textContent = counterText;
            sessionStorage.setItem("navCounter", counterText);
            
            // Actualizar contexto de navegación
            const fromColeccion = getQueryParam("from") === "coleccion";
            const searchQuery = getQueryParam("search") || "";
            const filterField = getQueryParam("filterField") || "";
            const navContextKey = fromColeccion 
                ? `coleccion_${searchQuery}_${filterField}`
                : `spectrum_${searchQuery}_${filterField}`;
            sessionStorage.setItem("navContext", navContextKey);
        } else if (counterEl) {
            // Si no encuentra el juego, mostrar placeholder
            counterEl.textContent = "- / -";
        }
        
        if (titleEl) {
            const label = currentGroupLabel || computeGroupLabel();
            titleEl.textContent = label;
        }
    }

function attachVoiceStopToNavigation() {
    const navSelectors = [
        ".top-bar-back",
        ".top-bar-home",
        ".game-nav-arrow--prev",
        ".game-nav-arrow--next"
    ];

    navSelectors.forEach(selector => {
        const element = document.querySelector(selector);
        if (element) {
            element.addEventListener("click", () => stopSynopsisVoice(), { capture: true });
        }
    });

    window.addEventListener("beforeunload", () => {
        stopSynopsisVoice();
    });
}

       
    function setupNavigation() {
    const prevArrow = document.querySelector(".game-nav-arrow--prev");
    const nextArrow = document.querySelector(".game-nav-arrow--next");
    const counterEl = document.querySelector(".game-nav-counter");
    
    const searchQuery = getQueryParam("search");
    const filterField = getQueryParam("filterField");
    const filterValue = getQueryParam("filterValue");
    const fromColeccion = getQueryParam("from");

    if (prevArrow) {
        prevArrow.addEventListener("click", () => {
            if (currentGameIndex > 0) {
                stopSynopsisVoice();
                const newPosition = currentGameIndex;
                const total = sortedGamesList.length;
                const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                if (counterEl) {
                    counterEl.textContent = counterText;
                }
                sessionStorage.setItem("navCounter", counterText);
                
                const prevGame = sortedGamesList[currentGameIndex - 1];
                let url = `spectrum-ficha.html?id=${encodeURIComponent(prevGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                if (filterField) {
                    url += `&filterField=${encodeURIComponent(filterField)}`;
                }
                if (filterValue) {
                    url += `&filterValue=${encodeURIComponent(filterValue)}`;
                }
                if (fromColeccion) {
                    url += `&from=${encodeURIComponent(fromColeccion)}`;
                }
                window.location.href = url;
            }
        });
        prevArrow.style.cursor = "pointer";
    }

    if (nextArrow) {
        nextArrow.addEventListener("click", () => {
            if (currentGameIndex < sortedGamesList.length - 1) {
                stopSynopsisVoice();
                const newPosition = currentGameIndex + 2;
                const total = sortedGamesList.length;
                const counterText = `${newPosition.toLocaleString("es-ES")} / ${total.toLocaleString("es-ES")}`;
                if (counterEl) {
                    counterEl.textContent = counterText;
                }
                sessionStorage.setItem("navCounter", counterText);
                
                const nextGame = sortedGamesList[currentGameIndex + 1];
                let url = `spectrum-ficha.html?id=${encodeURIComponent(nextGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                if (filterField) {
                    url += `&filterField=${encodeURIComponent(filterField)}`;
                }
                if (filterValue) {
                    url += `&filterValue=${encodeURIComponent(filterValue)}`;
                }
                if (fromColeccion) {
                    url += `&from=${encodeURIComponent(fromColeccion)}`;
                }
                window.location.href = url;
            }
        });
        nextArrow.style.cursor = "pointer";
    }
}

    async function loadGamesList(gameId) {
    try {
        const fromColeccion = getQueryParam("from") === "coleccion";
        const searchQuery = getQueryParam("search");
        const filterField = (getQueryParam("filterField") || "").toLowerCase();
        const filterValue = (getQueryParam("filterValue") || "").trim();

        let games;
        
        if (fromColeccion) {
            // Cargar CSV de colección
            const cacheKey = `coleccion_${CACHE_VERSION}`;
            games = getCachedData(cacheKey);
            
            if (!games) {
                const response = await fetch(COLECCION_CSV_URL);
                if (!response.ok) throw new Error("No se pudo cargar colección");
                
                const text = await response.text();
                games = parseColeccionCSV(text);
                setCachedData(cacheKey, games);
            }
            
            // Filtrar solo juegos de Spectrum
            games = games.filter(g => {
                const plat = normalizeText(g.plataforma || "");
                return plat === "spectrum" || plat === "zx spectrum" || plat === "zx";
            });
        } else {
            // Reutilizar allGamesData
            if (!allGamesData || allGamesData.length === 0) {
                const cacheKey = `ficha_spectrum_${CACHE_VERSION}`;
                allGamesData = getCachedData(cacheKey);
                
                if (!allGamesData) {
                    const response = await fetch(ZX_SPECTRUM_CSV_URL);
                    if (!response.ok) throw new Error("No se pudo cargar el CSV");
                    
                    const text = await response.text();
                    allGamesData = parseSpectrumCSV(text);
                    setCachedData(cacheKey, allGamesData);
                }
            }
            
            games = allGamesData.map(g => ({
                id: g.id,
                titulo: g.titulo,
                displayTitulo: formatTitleWithArticle(g.titulo),
                sortKey: formatTitleWithArticle(g.titulo).toLowerCase(),
                pub: g.pub,
                anio: g.anio,
                genero: g.genero,
                subgenero: g.subgenero,
                favorito: g.favorito,
                terminado: g.terminado,
                desarrollo: g.desarrollo
            }));
        }

        // CORREGIDO: Filtrar filas vacías antes de ordenar
        games = games.filter(g => g.id && g.titulo);
        
        games.sort((a, b) => (a.sortKey || "").localeCompare(b.sortKey || "", "es-ES"));

        let filteredGames = games;
        currentGroupLabel = "";

        if (fromColeccion) {
            currentGroupLabel = "Mi Colección";

            if (searchQuery) {
                const qNorm = normalizeText(searchQuery);
                const singleCharMatch = searchQuery.match(/^([a-zñáéíóúü0-9])$/i);

                if (singleCharMatch) {
                    const char = normalizeText(singleCharMatch[1]);
                    filteredGames = games.filter(game => {
                        const titleNorm = normalizeText(game.sortKey || "");
                        return titleNorm.startsWith(char);
                    });
                    currentGroupLabel = `Letra ${searchQuery.toUpperCase()}`;
                } else if (qNorm === "fav") {
                    filteredGames = games.filter(game => normalizeText(game.favorito || "") === "si");
                    currentGroupLabel = "Favoritos";
                } else if (qNorm === "terminado") {
                    filteredGames = games.filter(game => normalizeText(game.terminado || "") === "si");
                    currentGroupLabel = "Terminados";
                } else if (qNorm === "fisico") {
                    filteredGames = games.filter(game => normalizeText(game.formato || "").includes("fisico"));
                    currentGroupLabel = "Formato Físico";
                } else if (qNorm === "spectrum" || qNorm === "zx") {
                    // Ya están filtrados, mantener todos
                    currentGroupLabel = "Mi Colección";
                } else {
                    filteredGames = games.filter(game => {
                        const titleNorm = normalizeText(game.sortKey || "");
                        const pubNorm = normalizeText(game.pub || "");
                        const yearNorm = normalizeText(game.anio || "");
                        const generoNorm = normalizeText(game.genero || "");
                        const subgeneroNorm = normalizeText(game.subgenero || "");
                        const desarrolloNorm = normalizeText(game.desarrollo || "");

                        return (
                            titleNorm.includes(qNorm) ||
                            pubNorm.includes(qNorm) ||
                            yearNorm.includes(qNorm) ||
                            generoNorm.includes(qNorm) ||
                            subgeneroNorm.includes(qNorm) ||
                            desarrolloNorm.includes(qNorm)
                        );
                    });
                    currentGroupLabel = `"${searchQuery}"`;
                }
            }
        } else if (filterField === "subgenero" && filterValue) {
            const qNorm = normalizeText(filterValue);
            filteredGames = games.filter(game => normalizeText(game.subgenero || "").includes(qNorm));
            currentGroupLabel = `Subgénero ${filterValue}`;
        } else if (filterField === "favorito") {
            filteredGames = games.filter(game => normalizeText(game.favorito || "") === "si");
            currentGroupLabel = `Favoritos`;
        } else if (searchQuery) {
            const qNorm = normalizeText(searchQuery);
            const singleCharMatch = searchQuery.match(/^([a-zñáéíóúü0-9])$/i);
            
            if (singleCharMatch) {
                const char = normalizeText(singleCharMatch[1]);
                filteredGames = games.filter(game => {
                    const titleNorm = normalizeText(game.sortKey || "");
                    return titleNorm.startsWith(char);
                });
            } else {
                filteredGames = games.filter(game => {
                    const titleNorm = normalizeText(game.sortKey || "");
                    const pubNorm = normalizeText(game.pub || "");
                    const yearNorm = normalizeText(game.anio || "");
                    const generoNorm = normalizeText(game.genero || "");
                    const subgeneroNorm = normalizeText(game.subgenero || "");

                    return (
                        titleNorm.includes(qNorm) ||
                        pubNorm.includes(qNorm) ||
                        yearNorm.includes(qNorm) ||
                        generoNorm.includes(qNorm) ||
                        subgeneroNorm.includes(qNorm)
                    );
                });
                currentGroupLabel = `"${searchQuery}"`;
            }
        } else {
            currentGroupLabel = "Juegos ZX Spectrum";
        }

        sortedGamesList = filteredGames;
        currentGameIndex = filteredGames.findIndex(g => g.id === gameId);
        updateNavCounter();
        setupNavigation();

    } catch (err) {
        console.error("Error cargando lista para navegación:", err);
    }
}

    // ============================================
    // CARGA PRINCIPAL
    // ============================================
    
    async function loadSpectrumFicha() {
        const gameId = (getQueryParam("id") || "").trim();
        
        if (!gameId) {
            console.warn("No hay ID en la URL.");
            showError("ID no especificado");
            return;
        }

        try {
            // PASO 1: Intentar obtener ficha individual cacheada
            let game = getCachedFicha(gameId);
            
            if (game) {
                console.log(`[Caché] Ficha ${gameId} cargada desde caché ⚡`);
            } else {
                // PASO 2: Si no está cacheada, buscar en CSV
                const cacheKey = `ficha_spectrum_${CACHE_VERSION}`;
                let games = getCachedData(cacheKey);
                
                if (!games) {
                    const response = await fetch(ZX_SPECTRUM_CSV_URL);
                    if (!response.ok) throw new Error("No se pudo cargar el CSV");
                    
                    const text = await response.text();
                    games = parseSpectrumCSV(text);
                    setCachedData(cacheKey, games);
                }
                
                allGamesData = games;
                game = games.find(row => row.id === gameId);
                
                if (game) {
                    setCachedFicha(gameId, game);
                }
            }
            
            if (game) {
                updateTitle(game);
                updateCover(game);
                updatePuntuacion(game);
                updateScreenshots(game);
                updateFichaDatos(game);
                updateSinopsis(game);
                updateDatosTecnicos(game);
                updateGameplay(game);
                updateImagenesAdicionales(game);
                updateRevistas(game);
                updateUtiles(game);
            } else {
                showError("Juego no encontrado");
            }

            // PASO 3: Cargar lista para navegación
            await loadGamesList(gameId);
            
            // PASO 4: Prefetch de fichas adyacentes
            prefetchAdjacentGames();

        } catch (err) {
            console.error("Error cargando ZX_SPECTRUM:", err);
            showError("Error cargando datos");
        }
    }

    // ============================================
    // INICIALIZACIÓN - CORREGIDO con contexto
    // ============================================
    
    document.addEventListener("DOMContentLoaded", () => {
        const titleEl = document.querySelector(".game-nav-title");
        if (titleEl) {
            titleEl.textContent = computeGroupLabel();
        }

        // Construir clave de contexto para el contador
        const fromColeccion = getQueryParam("from") === "coleccion";
        const searchQuery = getQueryParam("search") || "";
        const filterField = getQueryParam("filterField") || "";
        const navContextKey = fromColeccion 
            ? `coleccion_${searchQuery}_${filterField}`
            : `spectrum_${searchQuery}_${filterField}`;
        
        // Solo restaurar contador si el contexto coincide
        const savedContext = sessionStorage.getItem("navContext");
        const savedCounter = sessionStorage.getItem("navCounter");
        
        if (savedCounter && savedContext === navContextKey) {
            const counterEl = document.querySelector(".game-nav-counter");
            if (counterEl) {
                counterEl.textContent = savedCounter;
            }
        }
        
        // Guardar el contexto actual
        sessionStorage.setItem("navContext", navContextKey);
        
        loadSpectrumFicha();
        setupCoverModal();
        setupSwipeNavigation();
        attachVoiceStopToNavigation();
    });

       // ============================================
// MODAL CARÁTULA
// ============================================

function setupCoverModal() {
    const coverImg = document.getElementById("ficha-cover");
    const modal = document.getElementById("cover-modal");
    const modalImg = document.getElementById("cover-modal-img");
    const closeBtn = document.querySelector(".cover-modal-close");

    if (!coverImg || !modal || !modalImg || !closeBtn) return;

    coverImg.addEventListener("click", function() {
        modalImg.src = coverImg.src;
        modal.classList.add("active");
        modalAbierta = true;
    });

    closeBtn.addEventListener("click", function() {
        modal.classList.remove("active");
        modalAbierta = false;
    });

    modal.addEventListener("click", function(e) {
        if (e.target === modal) {
            modal.classList.remove("active");
            modalAbierta = false;
        }
    });
     ["touchstart", "touchmove", "touchend"].forEach(eventName => {
        modal.addEventListener(eventName, (e) => {
            e.stopPropagation();
        }, { passive: true });
    });

    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape" && modal.classList.contains("active")) {
            modal.classList.remove("active");
            modalAbierta = false;
        }
    });
}
       // ============================================
// SWIPE PARA NAVEGACIÓN EN MÓVIL
// ============================================

function setupSwipeNavigation() {
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    let touchStartTime = 0;
    
    const minSwipeDistance = 100;
    const maxSwipeTime = 500;
    const maxVerticalRatio = 0.5;
    
    const searchQuery = getQueryParam("search");
    const filterField = getQueryParam("filterField");
    const filterValue = getQueryParam("filterValue");
    const fromColeccion = getQueryParam("from");

    document.addEventListener("touchstart", function(e) {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        touchStartTime = Date.now();
    }, { passive: true });

    document.addEventListener("touchend", function(e) {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe();
    }, { passive: true });

    function handleSwipe() {
        if (modalAbierta) return;
        
        const distanceX = touchEndX - touchStartX;
        const distanceY = touchEndY - touchStartY;
        const elapsedTime = Date.now() - touchStartTime;
        
        if (Math.abs(distanceX) < minSwipeDistance) return;
        if (elapsedTime > maxSwipeTime) return;
        if (Math.abs(distanceY) > Math.abs(distanceX) * maxVerticalRatio) return;

        if (distanceX < 0) {
            // Swipe izquierda -> siguiente
            if (currentGameIndex < sortedGamesList.length - 1) {
                const nextGame = sortedGamesList[currentGameIndex + 1];
                let url = `spectrum-ficha.html?id=${encodeURIComponent(nextGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                if (filterField) {
                    url += `&filterField=${encodeURIComponent(filterField)}`;
                }
                if (filterValue) {
                    url += `&filterValue=${encodeURIComponent(filterValue)}`;
                }
                if (fromColeccion) {
                    url += `&from=${encodeURIComponent(fromColeccion)}`;
                }
                stopSynopsisVoice();
                window.location.href = url;
            }
        } else {
            // Swipe derecha -> anterior
            if (currentGameIndex > 0) {
                const prevGame = sortedGamesList[currentGameIndex - 1];
                let url = `spectrum-ficha.html?id=${encodeURIComponent(prevGame.id)}`;
                if (searchQuery) {
                    url += `&search=${encodeURIComponent(searchQuery)}`;
                }
                if (filterField) {
                    url += `&filterField=${encodeURIComponent(filterField)}`;
                }
                if (filterValue) {
                    url += `&filterValue=${encodeURIComponent(filterValue)}`;
                }
                if (fromColeccion) {
                    url += `&from=${encodeURIComponent(fromColeccion)}`;
                }
                stopSynopsisVoice();
                window.location.href = url;
            }
        }
    }
}
</script>

    <script src="assets/js/app.js"></script>

    <!-- MODAL CARÁTULA -->
<div id="cover-modal" class="cover-modal">
    <span class="cover-modal-close">&times;</span>
    <img class="cover-modal-img" id="cover-modal-img" alt="Carátula ampliada">
</div>
    
<!-- MODAL IMÁGENES ADICIONALES -->
<div id="imagenes-modal" class="imagenes-modal">
    <span class="imagenes-modal-close">&times;</span>
    <img class="imagenes-modal-img" id="imagenes-modal-img" alt="Imagen adicional ampliada">
    <img src="assets/img/ic_back.svg" class="imagenes-modal-arrow imagenes-modal-arrow--prev" alt="Anterior">
    <img src="assets/img/ic_back.svg" class="imagenes-modal-arrow imagenes-modal-arrow--next" alt="Siguiente">
</div>
</body>
</html>
